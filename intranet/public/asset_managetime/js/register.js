function startAction(e,t,a,i){var n=$(t).data("DateTimePicker").date(),r=new Date(n),d=r.format("Y-m-d");"increase"===a?r.getHours()===timeSetting[i][d].morningInSetting.hour&&(r.setHours(timeSetting[i][d].afternoonInSetting.hour,timeSetting[i][d].afternoonInSetting.minute),$(e).css("visibility","hidden"),$(t+" a[data-action=decrementHours]").css("visibility","visible"),setTimeout(function(){$(t).data("DateTimePicker").date(r)},0)):r.getHours()===timeSetting[i][d].afternoonInSetting.hour&&(r.setHours(timeSetting[i][d].morningInSetting.hour,timeSetting[i][d].morningInSetting.minute),$(e).css("visibility","hidden"),$(t+" a[data-action=incrementHours]").css("visibility","visible"),setTimeout(function(){$(t).data("DateTimePicker").date(r)},0))}function endAction(e,t,a,i){var n=$(t).data("DateTimePicker").date(),r=new Date(n),d=r.format("Y-m-d");"increase"===a?r.getHours()===timeSetting[i][d].morningOutSetting.hour&&(r.setHours(timeSetting[i][d].afternoonOutSetting.hour,timeSetting[i][d].afternoonOutSetting.minute),$(e).css("visibility","hidden"),$(t+" a[data-action=decrementHours]").css("visibility","visible"),setTimeout(function(){$(t).data("DateTimePicker").date(r)},0)):r.getHours()===timeSetting[i][d].afternoonOutSetting.hour&&(r.setHours(timeSetting[i][d].morningOutSetting.hour,timeSetting[i][d].morningOutSetting.minute),$(e).css("visibility","hidden"),$(t+" a[data-action=incrementHours]").css("visibility","visible"),setTimeout(function(){$(t).data("DateTimePicker").date(r)},0))}function setStartDateOnChange(e,t,a){e.getHours()===timeSetting[a][t].afternoonInSetting.hour?($("#datetimepicker-start-date a[data-action=incrementHours]").css("visibility","hidden"),$("#datetimepicker-start-date a[data-action=decrementHours]").css("visibility","visible"),e.setHours(timeSetting[a][t].afternoonInSetting.hour,timeSetting[a][t].afternoonInSetting.minute),$("#datetimepicker-start-date").data("DateTimePicker").date(e)):($("#datetimepicker-start-date a[data-action=decrementHours]").css("visibility","hidden"),$("#datetimepicker-start-date a[data-action=incrementHours]").css("visibility","visible"),e.setHours(timeSetting[a][t].morningInSetting.hour,timeSetting[a][t].morningInSetting.minute),$("#datetimepicker-start-date").data("DateTimePicker").date(e));var i=$("#datetimepicker-start-date").data("DateTimePicker").date(),n=$("#datetimepicker-end-date").data("DateTimePicker").date(),r=getDaysTimekeeping(i,n,a);$("#number_days_off").val(r),$("#number_validate").val(r),$("#table_supplement_employees").find("tr[id="+$("#employee_id").val()+"] .start_at").text($("#start_date").val()),$("#table_supplement_employees").find("tr[id="+$("#employee_id").val()+"] .number_days").text(r)}function setEndDateOnChange(e,t,a){e.getHours()===timeSetting[a][t].morningOutSetting.hour?($("#datetimepicker-end-date a[data-action=decrementHours]").css("visibility","hidden"),$("#datetimepicker-end-date a[data-action=incrementHours]").css("visibility","visible"),e.setHours(timeSetting[a][t].morningOutSetting.hour,timeSetting[a][t].morningOutSetting.minute),$("#datetimepicker-end-date").data("DateTimePicker").date(e)):($("#datetimepicker-end-date a[data-action=decrementHours]").css("visibility","visible"),$("#datetimepicker-end-date a[data-action=incrementHours]").css("visibility","hidden"),e.setHours(timeSetting[a][t].afternoonOutSetting.hour,timeSetting[a][t].afternoonOutSetting.minute),$("#datetimepicker-end-date").data("DateTimePicker").date(e));var i=$("#datetimepicker-start-date").data("DateTimePicker").date(),n=$("#datetimepicker-end-date").data("DateTimePicker").date(),r=getDaysTimekeeping(i,n,a);$("#number_days_off").val(r),$("#number_validate").val(r),$("#table_supplement_employees").find("tr[id="+$("#employee_id").val()+"] .end_at").text($("#end_date").val()),$("#table_supplement_employees").find("tr[id="+$("#employee_id").val()+"] .number_days").text(r)}function setStartTimeSupplementOt(e,t,a,i,n,r){empProjects=Object(empProjects);for(var d=timeSetting[a][i].morningInSetting,o=timeSetting[a][i].afternoonOutSetting,s=!1,m=getStringDate(e),c=Object.keys(empProjects).length,l=0;l<c;++l){var u=empProjects[l].start_at,p=empProjects[l].end_at;if(u<=m&&m<=p){s=!0;break}}r?n.getDate()!==r.getDate()?isHolidayOrWeekend(e)?e.setHours(d.hour,d.minute):s?e.setHours(o.hour,o.minute):e.setHours(o.hour+1,o.minute):isHolidayOrWeekend(e)||(!s&&e.format("H:i")<convertTime(o.hour+1,o.minute)&&e.setHours(o.hour+1,o.minute),s&&e.format("H:i")<convertTime(o.hour,o.minute)&&e.setHours(o.hour,o.minute)):isHolidayOrWeekend(e)||(s?e.setHours(o.hour,o.minute):e.setHours(o.hour+1,o.minute)),$("#datetimepicker-start-date").data("DateTimePicker").date(e);var g=getDaysTimekeeping(e,t,a);$("#number_days_off").val(g),$("#table_supplement_employees").find("tr[id="+$("#employee_id").val()+"] .start_at").text($("#start_date").val()),$("#table_supplement_employees").find("tr[id="+$("#employee_id").val()+"] .number_days").text(g),checkOneDay(e,t)}function setEndTimeSupplementOt(e,t,a,i,n,r){r?(n.getDate()!==r.getDate()&&(isHolidayOrWeekend(t)?t.setHours(timeSetting[a][i].afternoonOutSetting.hour,timeSetting[a][i].afternoonOutSetting.minute):t.setHours(22,0)),t.getHours()>22&&t.setHours(22,0)):isHolidayOrWeekend(t)||t.setHours(22,0),$("#datetimepicker-end-date").data("DateTimePicker").date(t);var d=getDaysTimekeeping(e,t,a);$("#number_days_off").val(d),$("#table_supplement_employees").find("tr[id="+$("#employee_id").val()+"] .end_at").text($("#end_date").val()),$("#table_supplement_employees").find("tr[id="+$("#employee_id").val()+"] .number_days").text(d),checkOneDay(e,t)}function dateRange(e,t){for(var a=e.split("-"),i=t.split("-"),n=parseInt(a[0]),r=parseInt(i[0]),d=[],o=n;o<=r;o++)for(var s=o!=r?11:parseInt(i[1])-1,m=o===n?parseInt(a[1])-1:0,c=m;c<=s;c=c>12?c%12||11:c+1){var l=c+1,u=l<10?"0"+l:l;d.push([o,u].join("-"))}return d}function getDaysTimekeeping(e,t,a){for(var i=moment(e).toDate(),n=moment(t).toDate(),r=generateDatesInPeriod(i.format("Y-m-d"),n.format("Y-m-d")),d=0,o=0;o<r.length;o++){var s=r[o],m=new Date(r[o]),c=new Date(r[o]);r.length>1?(o<r.length-1?c.setHours(timeSetting[a][s].afternoonOutSetting.hour,timeSetting[a][s].afternoonOutSetting.minute,0):c.setHours(n.getHours(),n.getMinutes()),0===o?m.setHours(i.getHours(),i.getMinutes()):m.setHours(timeSetting[a][s].morningInSetting.hour,timeSetting[a][s].morningInSetting.minute,0)):(m.setHours(i.getHours(),i.getMinutes()),c.setHours(n.getHours(),n.getMinutes())),$("input[name=is_ot]").is(":checked")||(isHolidayOrWeekend(m)&&m.setHours(timeSetting[a][s].morningInSetting.hour,timeSetting[a][s].morningInSetting.minute,0),isHolidayOrWeekend(c)&&c.setHours(timeSetting[a][s].afternoonOutSetting.hour,timeSetting[a][s].afternoonOutSetting.minute,0)),d+=getTimeDiffInRange(m,c,a,s)}var l=rounding(d,1),u=rounding(d,2);return parseFloat(l)==parseFloat(u)?l:u}function getTimeDiffInRange(e,t,a,i){var n=864e5,r=new Date(e),d=new Date(t);r.setHours(0,0),d.setHours(0,0);var o=getNumberDaysWeekend(new Date(e),new Date(t)),s=r.getTime(),m=d.getTime(),c=m-s,l=Math.round(c/n*100)/100;if($("input[name=is_ot]").is(":checked")||(l-=o),l<0)return 0;var u=getEveningBreak(l,a,i),p=getLunchBreak(e,t,l,a,i),g=u+p;$("input[name=is_ot]").is(":checked")||(g+=24*o);var _=getTimeDiff(e,t)-g;return parseFloat(rounding(_/getHoursWork(a,i),2))}function getHoursWork(e,t){var a=new Date,i=new Date;a.setHours(timeSetting[e][t].morningInSetting.hour,timeSetting[e][t].morningInSetting.minute,0),i.setHours(timeSetting[e][t].afternoonOutSetting.hour,timeSetting[e][t].afternoonOutSetting.minute,0);var n=getLunchBreak(a,i,0,e,t);return getTimeDiff(a,i)-n}function getEveningBreak(e,t,a){var i=new Date,n=new Date;return n.setDate(i.getDate()+1),i.setHours(timeSetting[t][a].afternoonOutSetting.hour,timeSetting[t][a].afternoonOutSetting.minute,0),n.setHours(timeSetting[t][a].morningInSetting.hour,timeSetting[t][a].morningInSetting.minute,0),getTimeDiff(i,n)*e}function getLunchBreak(e,t,a,i,n){var r=new Date,d=new Date;r.setHours(timeSetting[i][n].morningOutSetting.hour,timeSetting[i][n].morningOutSetting.minute,0),d.setHours(timeSetting[i][n].afternoonInSetting.hour,timeSetting[i][n].afternoonInSetting.minute,0);var o=getTimeDiff(r,d),s=a;return isMorningInTime(e)&&!isMorningOutTime(t)?s++:!isMorningInTime(e)&&isMorningOutTime(t)&&s--,s<0&&(s=0),o*s}function isMorningInTime(e){var t=[7,8,9,10,11,12];return $.inArray(e.getHours(),t)!==-1}function isMorningOutTime(e){var t=[7,8,9,10,11,12,13];return $.inArray(e.getHours(),t)!==-1}function getTimeDiff(e,t){return e=parseInt(new Date(e).getTime()/1e3),t=parseInt(new Date(t).getTime()/1e3),e>t?0:(t-e)/3600}function getNumberDaysWeekend(e,t){e.setHours(0,0),t.setHours(0,0);for(var a=0,i=e;i<=t;i.setDate(i.getDate()+1))isHolidayOrWeekend(i)&&a++;return a}function isHolidayOrWeekend(e){var t=new Date(e);t.setHours(0,0);var a=t.getFullYear(),i=t.getTime();if(isWeekend(e))return!0;if("object"==typeof arrAnnualHolidays)for(var n=arrAnnualHolidays.length,r=0;r<n;r++){var d=new Date(a+"-"+arrAnnualHolidays[r]);d.setHours(0,0);var o=d.getTime();if(o==i)return!0}if("object"==typeof arrSpecialHolidays)for(var s=arrSpecialHolidays.length,r=0;r<s;r++){var m=new Date(arrSpecialHolidays[r]);m.setHours(0,0);var c=m.getTime();if(c==i)return!0}return!1}function checkFormMissionRegisterByAdmin(e){if($("#check_status").length>0){var t=$("#check_status").val();if(t==STATUS_CANCEL)return $("#show_notification").text(notificationStatusCanceled),$("#modal_allow_edit").modal("show"),!1}var a=1;$("#check_submit").val(1);var i=$("#datetimepicker-start-date").data("DateTimePicker").date();null==i&&($("#start_date-error").show(),a=0);var n=$("#datetimepicker-end-date").data("DateTimePicker").date();if(null==n&&($("#end_date-error").show(),a=0),null!=i&&null!=n){var r=$("#number_days_off").val();r<=0&&($("#end_date_before_start_date-error").show(),a=0)}if($("#employee_id").length){var d=$("#employee_id").val();null==d&&($("#registrant-error").show(),a=0)}if($("#approver").length){var o=$("#approver").val();null==o&&($("#approver-error").show(),a=0)}if($("#country_id").length){var s=$("#country_id").val();s||($("#country_id-error").show(),a=0);var m=$("#country_id option:selected").attr("code");if(m==VN&&$("#province_id").length){var c=$("#province_id").val();c||($("#province_id-error").show(),a=0)}}if($("#location").length){var l=$("#location").val();isEmptyOrSpaces(l)&&($("#location-error").show(),a=0)}var u=$("#reason").val().trim();return""==u&&($("#reason-error").show(),a=0),0!=a}function checkFormMissionRegister(e){if($("#check_status").length>0){var t=$("#check_status").val();if(t==STATUS_CANCEL)return $("#show_notification").text(notificationStatusCanceled),$("#modal_allow_edit").modal("show"),!1}var a=1;$("#check_submit").val(1);var i=$("#datetimepicker-start-date").data("DateTimePicker").date();null==i&&($("#start_date-error").show(),a=0);var n=$("#datetimepicker-end-date").data("DateTimePicker").date();if(null==n&&($("#end_date-error").show(),a=0),null!=i&&null!=n){var r=$("#number_days_off").val();r<=0?($("#end_date_before_start_date-error").show(),a=0):checkNoEmployee()?a=0:checkExistRegister(e)&&(a=0)}if($("#employee_id").length){var d=$("#employee_id").val();null==d&&($("#registrant-error").show(),a=0)}if($("#approver").length){var o=$("#approver").val();null==o&&($("#approver-error").show(),a=0)}if($("#country_id").length){var s=$("#country_id").val();s||($("#country_id-error").show(),a=0);var m=$("#country_id option:selected").attr("code");if(m==VN&&$("#province_id").length){var c=$("#province_id").val();c||($("#province_id-error").show(),a=0)}}if($("#location").length){var l=$("#location").val();isEmptyOrSpaces(l)&&($("#location-error").show(),a=0)}var u=$("#reason").val().trim();return""==u&&($("#reason-error").show(),a=0),0!=a}function checkFormSupplementRegister(e){if($("#check_status").length>0){var t=$("#check_status").val();if(t==STATUS_APPROVED)return $("#show_notification").text(notificationStatusApproved),$("#modal_allow_edit").modal("show"),!1;if(t==STATUS_CANCEL)return $("#show_notification").text(notificationStatusCanceled),$("#modal_allow_edit").modal("show"),!1}var a=1;$("#check_submit").val(1);var i=$("#datetimepicker-start-date").data("DateTimePicker").date();null==i&&($("#start_date-error").show(),a=0);var n=$("#datetimepicker-end-date").data("DateTimePicker").date();if(null==n&&($("#end_date-error").show(),a=0),null!=i&&null!=n){var r=$("#number_days_off").val();r<=0?($("#end_date_before_start_date-error").show(),a=0):checkNoEmployee()?a=0:checkExistRegister(e)&&(a=0)}if($("#employee_id").length){var d=$("#employee_id").val();null==d&&($("#registrant-error").show(),a=0)}if($("#approver").length){var o=$("#approver").val();null==o&&($("#approver-error").show(),a=0)}if($("#country_id").length){var s=$("#country_id").val();s||($("#country_id-error").show(),a=0)}if(!isWorkingJP||$("#reason_id").find("option:selected").data("other")===typeOther){var m=$("#reason").val().trim();""===m&&($("#reason-error").show(),a=0)}return isWorkingJP&&$("#reason_id").find("option:selected").data("required")===typeImageRequired&&0==document.getElementById("image_upload").files.length&&($("#image_upload-error").show(),a=0),!isOneDay(i,n)&&$("input[name=is_ot]").is(":checked")&&(a=0),0!==a}function checkDiffDate(e,t){var a=new Date(e.format("MM/DD/YYYY HH:mm:ss")),i=new Date(t.format("MM/DD/YYYY HH:mm:ss")),n=i-a;return n<=0}function checkExistRegister(e){var t=!1,a=[];$("#table_supplement_employees > tbody").find("tr").length>0&&$("#table_supplement_employees > tbody").find("tr").each(function(){var e=$(this).find("td");a.push({empId:$(this).attr("id"),startAt:e.eq(2).text(),endAt:e.eq(3).text()})});var i=JSON.stringify(a);return $.ajax({type:"GET",url:e,dataType:"json",async:!1,data:{empList:i,registerId:$("#register_id").val(),isOt:$("#is_ot:checked").val()},success:function(e){$(".employee-exist").html(""),e.length>0&&($(".employee-exist").append('<div class="error">Các nhân viên sau đã đăng ký trùng thời gian với đơn đăng ký khác:</div>'),t=!0,$.each(e,function(e,t){$(".employee-exist").append('<div class="error emp-row" data-emp="'+t.empId+'">Nhân viên: '+t.empName+", mã nhân viên: "+t.empCode+' <a target="_blank" href="'+t.url+'">Chi tiết</a></div>')}))}}),t}function initEmployeeTable(){if(0==$("#table_supplement_employees").find("tr#"+$("#register_id").data("id")).length){var e=$("#employee_id").val(),t="<tr id='"+e+"'>",a=$("#datetimepicker-start-date").data("DateTimePicker").date(),i=$("#datetimepicker-end-date").data("DateTimePicker").date();t+="<td class='emp_code_main'>"+$("#employee_code").val()+"</td>",t+="<td class='emp_name'>"+$("#employee_name").val()+"</td>",t+="<td class='start_at'>"+$("#start_date").val()+"</td>",t+="<td class='end_at'>"+$("#end_date").val()+"</td>",t+="<td class='number_days'>"+getDaysTimekeeping(a,i,currentEmpId)+"</td>",t+="<td class='btn-manage'><button type='button' class='btn btn-primary edit' onclick='editEmp("+e+")'><i class='fa fa-pencil-square-o'></i></button>",t+=" <button type='button' class='btn btn-delete delete' onclick='removeEmp("+e+")'><i class='fa fa-minus'></i></button></td>",t+="</tr>",$("#table_supplement_employees").children("tbody").prepend(t)}}function calculateNumberDays(){$("#table_supplement_employees tbody tr").each(function(){var e=$(this),t=e.attr("id"),a=convertDate(e.find(".start_at").text()),i=convertDate(e.find(".end_at").text()),n=getDaysTimekeeping(a,i,t);e.find(".number_days").text(n)})}function preSaveProcessing(){var e=[];$("#table_supplement_employees > tbody").find("tr").length>0&&$("#table_supplement_employees > tbody").find("tr").each(function(){var t=$(this).find("td");e.push({empId:$(this).attr("id"),startAt:t.eq(2).text(),endAt:t.eq(3).text()})});var t=JSON.stringify(e);$("#table_data_emps").val(t)}function getFullDate(e){return get2Digis(e.getDate())+"-"+get2Digis(e.getMonth()+1)+"-"+e.getFullYear()+" "+get2Digis(e.getHours())+":"+get2Digis(e.getMinutes())}function removeEmp(e){$("#exist_time_lot_before_submit_error").html(""),$("#table_supplement_employees > tbody").children("tr#"+e).remove(),checkNoEmployee()?$("#error_no_employee").removeClass("hidden"):$("#error_no_employee").addClass("hidden"),$(".employee-exist").find(".error[data-emp="+e+"]").remove(),0==$(".employee-exist").find(".emp-row").length&&$(".employee-exist").html("")}function checkTimeNotFilled(){var e=!1;return $("#table_supplement_employees > tbody").find("td.start_at, td.end_at").each(function(t,a){$(this).text()||(e=!0)}),e}function checkNoEmployee(){return $("#table_supplement_employees tbody tr").length<=0}function setStartDateChildOnChange(e,t,a){e.getHours()===timeSetting[t][a].afternoonInSetting.hour?($("#datetimepicker_add_start a[data-action=incrementHours]").css("visibility","hidden"),$("#datetimepicker_add_start a[data-action=decrementHours]").css("visibility","visible"),e.setHours(timeSetting[t][a].afternoonInSetting.hour,timeSetting[t][a].afternoonInSetting.minute),$("#datetimepicker_add_start").data("DateTimePicker").date(e)):($("#datetimepicker_add_start a[data-action=decrementHours]").css("visibility","hidden"),$("#datetimepicker_add_start a[data-action=incrementHours]").css("visibility","visible"),e.setHours(timeSetting[t][a].morningInSetting.hour,timeSetting[t][a].morningInSetting.minute),$("#datetimepicker_add_start").data("DateTimePicker").date(e))}function setEndDateChildOnChange(e,t,a){e.getHours()===timeSetting[t][a].morningOutSetting.hour?($("#datetimepicker_add_end a[data-action=decrementHours]").css("visibility","hidden"),$("#datetimepicker_add_end a[data-action=incrementHours]").css("visibility","visible"),e.setHours(timeSetting[t][a].morningOutSetting.hour,timeSetting[t][a].morningOutSetting.minute),$("#datetimepicker_add_end").data("DateTimePicker").date(e)):($("#datetimepicker_add_end a[data-action=decrementHours]").css("visibility","visible"),$("#datetimepicker_add_end a[data-action=incrementHours]").css("visibility","hidden"),e.setHours(timeSetting[t][a].afternoonOutSetting.hour,timeSetting[t][a].afternoonOutSetting.minute),$("#datetimepicker_add_end").data("DateTimePicker").date(e))}function editEmp(e){$("#add_emp_id").val(e),$("#datetimepicker_add_start").datetimepicker({allowInputToggle:!0,format:"DD-MM-YYYY HH:mm",sideBySide:!0,maxDate:moment().add(10,"y"),minDate:moment().subtract(10,"y"),disabledHours:[23]}).on("dp.show",function(t){if(e==$("#add_emp_id").val()){$('a[data-action="incrementMinutes"], a[data-action="decrementMinutes"]').css("display","none"),$("#datetimepicker_add_start a[data-action=incrementHours]").attr("href","javascript:void(0)").attr("onclick",'startAction(this, "#datetimepicker_add_start", "increase", '+e+")"),$("#datetimepicker_add_start a[data-action=decrementHours]").attr("href","javascript:void(0)").attr("onclick",'startAction(this, "#datetimepicker_add_start", "descrease", '+e+")");var a=$("#datetimepicker_add_start").data("DateTimePicker").date(),i=new Date(a),n=i.format("Y-m-d");i.getHours()===timeSetting[e][n].afternoonInSetting.hour?($("#datetimepicker_add_start a[data-action=incrementHours]").css("visibility","hidden"),i.setHours(timeSetting[e][n].afternoonInSetting.hour,timeSetting[e][n].afternoonInSetting.minute),$("#datetimepicker_add_start").data("DateTimePicker").date(i)):($("#datetimepicker_add_start a[data-action=decrementHours]").css("visibility","hidden"),i.setHours(timeSetting[e][n].morningInSetting.hour,timeSetting[e][n].morningInSetting.minute),$("#datetimepicker_add_start").data("DateTimePicker").date(i))}}).on("dp.change",function(t){if(e==$("#add_emp_id").val()){var a=$("#datetimepicker_add_start").data("DateTimePicker").date(),i=new Date(a),n=new Date($("#datetimepicker_add_end").data("DateTimePicker").date());1970===i.getFullYear()&&(a=$("#table_supplement_employees > tbody").children("tr#"+e).children(".start_at").html(),i=new Date(convertDate(a))),updateTimeSettingData(e,i.format("Y-m-d"),n.format("Y-m-d")),setStartDateChildOnChange(i,e,i.format("Y-m-d"))}}),$("#datetimepicker_add_end").datetimepicker({allowInputToggle:!0,format:"DD-MM-YYYY HH:mm",sideBySide:!0,maxDate:moment().add(10,"y"),minDate:moment().subtract(10,"y"),disabledHours:[23]}).on("dp.show",function(t){if(e==$("#add_emp_id").val()){$('a[data-action="incrementMinutes"], a[data-action="decrementMinutes"]').css("display","none"),$("#datetimepicker_add_end a[data-action=incrementHours]").attr("href","javascript:void(0)").attr("onclick",'endAction(this, "#datetimepicker_add_end", "increase", '+e+")"),$("#datetimepicker_add_end a[data-action=decrementHours]").attr("href","javascript:void(0)").attr("onclick",'endAction(this, "#datetimepicker_add_end", "descrease", '+e+")");var a=$("#datetimepicker_add_end").data("DateTimePicker").date(),i=new Date(a),n=i.format("Y-m-d");i.getHours()===timeSetting[e][n].morningOutSetting.hour?($("#datetimepicker_add_end a[data-action=decrementHours]").css("visibility","hidden"),i.setHours(timeSetting[e][n].morningOutSetting.hour,timeSetting[e][n].morningOutSetting.minute),$("#datetimepicker_add_end").data("DateTimePicker").date(i)):($("#datetimepicker_add_end a[data-action=incrementHours]").css("visibility","hidden"),i.setHours(timeSetting[e][n].afternoonOutSetting.hour,timeSetting[e][n].afternoonOutSetting.minute),$("#datetimepicker_add_end").data("DateTimePicker").date(i))}}).on("dp.change",function(t){var a=new Date($("#datetimepicker_add_start").data("DateTimePicker").date()),i=$("#datetimepicker_add_end").data("DateTimePicker").date(),n=new Date(i);1970===n.getFullYear()&&(i=$("#table_supplement_employees > tbody").children("tr#"+e).children(".end_at").html(),n=new Date(convertDate(i))),22==n.getHours()&&(n.setHours(22,0),$("#datetimepicker_add_end").data("DateTimePicker").date(n)),e==$("#add_emp_id").val()&&(updateTimeSettingData(e,a.format("Y-m-d"),n.format("Y-m-d")),setEndDateChildOnChange(n,e,n.format("Y-m-d")))}),$("#exist_time_lot_before_submit_error").html(""),$("#addEmp").find(".errorTxt").addClass("hidden");var t=$("#table_supplement_employees > tbody").children("tr#"+e);$("#addEmp").modal("show"),$(".btn-confirm").data("id",e),$("#add_register_code").data("id",t.attr("id")),$("#add_register_code").val(t.find(".emp_code_main").text()),$("#add_time_start").val(t.children(".start_at").html()),$("#add_time_end").val(t.children(".end_at").html()),$("#add_relax").val(t.children(".relax").html()),$("#emp_list").find("option[value="+e+"]").length>0?$("#emp_list").val(e).trigger("change"):($("#emp_list").append($("<option>",{value:e,text:t.children(".emp_name").html()})),$("#emp_list").val(e).trigger("change"))}function convertDate(e){var t=e.split(" "),e=t[0],a=t[1],i=e.split("-");return i[2]+"-"+i[1]+"-"+i[0]+" "+a}function checkTimeNotFilled(){var e=!1;return $("#addEmp").find("#add_time_end").val()||($(".add_time_end-error").removeClass("hidden"),e=!0),e}function isEmptyOrSpaces(e){return null===e||null!==e.match(/^ *$/)}function getStringDate(e){var t=e.getMonth()+1;return t=t<10?"0"+t:t,e.getFullYear()+"-"+t+"-"+e.getDate()}function isOneDay(e,t){var a=getStringDate(new Date(e)),i=getStringDate(new Date(t));return a===i}function checkOneDay(e,t){if(!isOneDay(e,t)&&$("input[name=is_ot]").is(":checked"))$("#supplement_ot_one_day").show(),$("#number_days_off").val(0),$("#number_validate").val(0);else{$("#supplement_ot_one_day").hide();var a=$("#employee_id").val();if(a){var i=getDaysTimekeeping(e,t,a);$("#number_days_off").val(i),$("#number_validate").val(i)}}}function convertTime(e,t){return("0"+e).slice(-2)+":"+("0"+t).slice(-2)}function updateTimeSettingData(e,t,a){if(t>a){var i=t;t=a,a=i}var n,r=generateDatesInPeriod(t,a),d=!0;for(n=0;n<r.length;n++)if(!timeSetting[e][r[n]]){d=!1,t=r[n];break}if(!d){for(n=r.length-1;n>=0;n--)if(!timeSetting[e][r[n]]){a=r[n];break}$.ajax({type:"post",dataType:"json",url:urlGetTimeSetting,async:!1,data:{period:{start_date:t,end_date:a},empId:e,_token:token},success:function(t){var a=t.timeWorking[e];Object.keys(a).forEach(function(t){timeSetting[e][t]=a[t]})}})}}$(window).load(function(){$(".se-pre-con").fadeOut("slow");var e=$("#country_id option:selected").attr("code");"JP"===e?$("#add-text-required").html(""):"VN"===e?$("#add-text-required").html("<em>*</em>"):$("#add-text-required").html("")});var $startDateContainer=$("#datetimepicker-start-date"),$endDateContainer=$("#datetimepicker-end-date");$(function(){$(".managetime-upload-file input:file").fileuploader({addMore:!0,extensions:["jpg","jpeg","png","bmp"]}),$(".fancybox").fancybox({openEffect:"none",closeEffect:"none"}),$("#datetimepicker-start-date").datetimepicker({allowInputToggle:!0,sideBySide:!0,disabledHours:[22,23],defaultDate:startDateDefault}).on("dp.show",function(e){$("#hidden-end-date").hide(),$("#datetimepicker-end-date").show();var t=$("#check_submit").val();if(1==t){var a=$("#datetimepicker-start-date").data("DateTimePicker").date();null==a?($("#start_date-error").show(),$("#end_date_before_start_date-error").hide()):($("#start_date-error").hide(),$("#end_date_before_start_date-error").hide(),$("#register_exist_error").hide())}if($("input[name=is_ot]").is(":checked"))$('a[data-action="incrementMinutes"], a[data-action="decrementMinutes"]').css("display","inline-block");else{var i=currentEmpId;""!=$("#employee_id").val()&&null!==$("#employee_id").val()&&(i=$("#employee_id").val()),$("select#employee_id").length>0&&null!=$("select#employee_id").val()&&(i=$("select#employee_id").val()),$('a[data-action="incrementMinutes"], a[data-action="decrementMinutes"]').css("display","none"),$("#datetimepicker-start-date a[data-action=incrementHours]").attr("href","javascript:void(0)").attr("onclick",'startAction(this, "#datetimepicker-start-date", "increase", '+i+")"),$("#datetimepicker-start-date a[data-action=decrementHours]").attr("href","javascript:void(0)").attr("onclick",'startAction(this, "#datetimepicker-start-date", "decrease", '+i+")");var a=$("#datetimepicker-start-date").data("DateTimePicker").date(),n=new Date(a),r=n.format("Y-m-d");n.getHours()===timeSetting[i][r].afternoonInSetting.hour?($("#datetimepicker-start-date a[data-action=incrementHours]").css("visibility","hidden"),n.setHours(timeSetting[i][r].afternoonInSetting.hour,timeSetting[i][r].afternoonInSetting.minute),$("#datetimepicker-start-date").data("DateTimePicker").date(n)):($("#datetimepicker-start-date a[data-action=decrementHours]").css("visibility","hidden"),n.setHours(timeSetting[i][r].morningInSetting.hour,timeSetting[i][r].morningInSetting.minute),$("#datetimepicker-start-date").data("DateTimePicker").date(n))}}).on("dp.hide",function(e){var t=$("#datetimepicker-start-date").data("DateTimePicker").date();null==t&&($("#hidden-end-date").show(),$("#datetimepicker-end-date").hide(),$("#datetimepicker-end-date").data("DateTimePicker").date(null));var a=$("#check_submit").val();1==a&&(null==t?($("#start_date-error").show(),$("#end_date-error").show(),$("#end_date_before_start_date-error").hide()):($("#start_date-error").hide(),$("#register_exist_error").hide()))}).on("dp.change",function(e){var t=$startDateContainer.data("DateTimePicker").date();if(!t)return void $startDateContainer.data("DateTimePicker").date(new Date);var a=$endDateContainer.data("DateTimePicker").date(),i=new Date(t),n=new Date(a),r=currentEmpId;$("select#employee_id").length>0&&null!=$("select#employee_id").val()&&(r=$("select#employee_id").val()),updateTimeSettingData(r,i.format("Y-m-d"),n.format("Y-m-d"));var d=i.format("Y-m-d");if($("input[name=is_ot]").is(":checked"))setStartTimeSupplementOt(i,n,r,d,new Date(e.date),new Date(e.oldDate));else if(setStartDateOnChange(i,d,r),e.oldDate){var o=timeSetting[r][d];isMorningInTime(i)?i.setHours(o.morningInSetting.hour,o.morningInSetting.minute):i.setHours(o.afternoonInSetting.hour,o.afternoonInSetting.minute),$("#datetimepicker-start-date").data("DateTimePicker").date(i)}});var e={allowInputToggle:!0,sideBySide:!0,defaultDate:endDateDefault};isEmpJp||(e.disabledHours=[23]),$("#datetimepicker-end-date").datetimepicker(e).on("dp.show",function(e){var t=currentEmpId;""!=$("#employee_id").val()&&null!==$("#employee_id").val()&&(t=$("#employee_id").val()),$("select#employee_id").length>0&&null!=$("select#employee_id").val()&&(t=$("select#employee_id").val());var a=$("#check_submit").val();if(1==a){var i=$("#datetimepicker-end-date").data("DateTimePicker").date();null==i?($("#end_date-error").show(),$("#end_date_before_start_date-error").hide()):($("#end_date-error").hide(),$("#end_date_before_start_date-error").hide(),$("#register_exist_error").hide())}if($("input[name=is_ot]").is(":checked"))$('a[data-action="incrementMinutes"], a[data-action="decrementMinutes"]').css("display","inline-block");else{$('a[data-action="incrementMinutes"], a[data-action="decrementMinutes"]').css("display","none"),$("#datetimepicker-end-date a[data-action=incrementHours]").attr("href","javascript:void(0)").attr("onclick",'endAction(this, "#datetimepicker-end-date", "increase", '+t+")"),$("#datetimepicker-end-date a[data-action=decrementHours]").attr("href","javascript:void(0)").attr("onclick",'endAction(this, "#datetimepicker-end-date", "descrease", '+t+")");var i=$("#datetimepicker-end-date").data("DateTimePicker").date(),n=new Date(i),r=n.format("Y-m-d");n.getHours()===timeSetting[t][r].morningOutSetting.hour?($("#datetimepicker-end-date a[data-action=decrementHours]").css("visibility","hidden"),n.setHours(timeSetting[t][r].morningOutSetting.hour,timeSetting[t][r].morningOutSetting.minute),$("#datetimepicker-end-date").data("DateTimePicker").date(n)):($("#datetimepicker-end-date a[data-action=incrementHours]").css("visibility","hidden"),n.setHours(timeSetting[t][r].afternoonOutSetting.hour,timeSetting[t][r].afternoonOutSetting.minute),$("#datetimepicker-end-date").data("DateTimePicker").date(n))}}).on("dp.hide",function(e){var t=$("#check_submit").val();if(1==t){var a=$("#datetimepicker-end-date").data("DateTimePicker").date();null==a?$("#end_date-error").show():($("#end_date-error").hide(),$("#register_exist_error").hide())}}).on("dp.change",function(e){var t=$endDateContainer.data("DateTimePicker").date();if(!t)return void $endDateContainer.data("DateTimePicker").date(new Date);var a=$startDateContainer.data("DateTimePicker").date(),i=new Date(a),n=new Date(t);22===n.getHours()&&(n.setHours(22,0),$("#datetimepicker-end-date").data("DateTimePicker").date(n));var r=currentEmpId;$("select#employee_id").length>0&&null!=$("select#employee_id").val()&&(r=$("select#employee_id").val()),updateTimeSettingData(r,i.format("Y-m-d"),n.format("Y-m-d"));var d=n.format("Y-m-d");$("input[name=is_ot]").is(":checked")?setEndTimeSupplementOt(i,n,r,d,new Date(e.date),new Date(e.oldDate)):setEndDateOnChange(n,d,r)});var t=$("#datetimepicker-start-date").data("DateTimePicker").date(),a=$("#datetimepicker-end-date").data("DateTimePicker").date(),i=getDaysTimekeeping(t,a,currentEmpId);$("#number_days_off").val(i),$("#managetime-icon-date-start").on("click",function(){$(".managetime-select-2").select2("close"),$("#related_persons").select2("close"),$("#datetimepicker-start-date").data("DateTimePicker").show()}),$("#managetime-icon-date-end").on("click",function(){$("#related_persons").select2("close"),$(".managetime-select-2").select2("close"),$("#datetimepicker-start-end").data("DateTimePicker").show()}),$("#related_persons").select2({ajax:{url:urlSearchRelatedPerson,dataType:"JSON",data:function(e){return{q:$.trim(e.term)}},processResults:function(e){return{results:e}},cache:!0}}),$("#button_approve").click(function(){$("#register_id_approve").val($(this).val())}),$("#button_disapprove").click(function(){$("#reason_disapprove-error").hide(),$("#reason_disapprove").val(""),$("#register_id_disapprove").val($(this).val())}),$("#button_approve_submit").click(function(){var e=$("#register_id_approve").val(),t=window.location.href.substr(window.location.href),a=$(this);a.button("loading"),$.ajax({type:"GET",url:urlApprove,data:{registerId:e,
urlCurrent:t},success:function(e){$("#modal_approve").modal("hide");var t=JSON.parse(e);window.location=t.url}})}),$("#button_disapprove_submit").click(function(){var e=$("#register_id_disapprove").val(),t=window.location.href.substr(window.location.href),a=$("#reason_disapprove").val();if(""==a.trim())return void $("#reason_disapprove-error").show();var i=$(this);i.button("loading"),$.ajax({type:"GET",url:urlDisapprove,data:{registerId:e,urlCurrent:t,reasonDisapprove:a},success:function(e){$("#modal_disapprove").modal("hide");var t=JSON.parse(e);window.location=t.url}})}),$("#reason_disapprove").keyup(function(){var e=$("#reason_disapprove").val();""==e.trim()?$("#reason_disapprove-error").show():$("#reason_disapprove-error").hide()}),$("#approver").on("change",function(e){$("#approver-error").hide()}),$("#country_id").change(function(){$("#country_id-error").hide(),$("#province_id-error").hide()}),$("#province_id").change(function(){$("#province_id-error").hide()}),$("#location").change(function(){$("#location-error").hide()})}),$("input[name=is_ot]").change(function(){var e=$("#datetimepicker-start-date").data("DateTimePicker").date(),t=$("#datetimepicker-end-date").data("DateTimePicker").date(),a=new Date(e),i=new Date(t),n=a.format("Y-m-d"),r=i.format("Y-m-d"),d=currentEmpId;$("select#employee_id").length>0&&null!=$("select#employee_id").val()&&(d=$("select#employee_id").val()),$(this).is(":checked")?(setStartTimeSupplementOt(a,i,d,n,a,null),setEndTimeSupplementOt(a,i,d,r,i,null)):(setStartDateOnChange(a,n,d),setEndDateOnChange(i,r,d),$("#supplement_ot_one_day").hide())}),$(function(){$("#datetimepicker_start, #datetimepicker_end").initOTTimeCalendar(),"undefined"!=typeof pageType&&"create"===pageType&&initEmployeeTable(),$(".select-search-employee").selectSearchEmployee(),$(".select-search-employee-no-pagination").selectSearchEmployeeNoPagination(),calculateNumberDays()}),$("#btn_add_employee_ot").click(function(){var e=$(this),t=$("#search_employee_ot").select2("data"),a=[];jQuery.each(t,function(e,t){a.push(t.id)});var i=$(this).data("url");return!a.length||(!!e.data("process")||(e.data("process",1),void $.ajax({type:"POST",url:i,dataType:"json",data:{empIds:a,_token:token,startDate:$("#start_date").val(),endDate:$("#end_date").val()},success:function(e){var i=moment(convertDate($("#start_date").val())).toDate(),n=moment(convertDate($("#end_date").val())).toDate(),r=new Date(i),d=r.format("Y-m-d"),o=new Date(n),s=o.format("Y-m-d");$.each(a,function(t,a){"undefined"==typeof timeSetting[a]&&(timeSetting[a]={}),timeSetting[a]=e[0][a]}),jQuery.each(t,function(e,t){if($("#error_no_employee").addClass("hidden"),$("#table_supplement_employees > tbody > tr#"+t.id).length<=0){var a="<tr id='"+t.id+"'>",r=t.id,o=isMorningInTime(i),m=isMorningOutTime(n);o?i.setHours(timeSetting[r][d].morningInSetting.hour,timeSetting[r][d].morningInSetting.minute):i.setHours(timeSetting[r][d].afternoonInSetting.hour,timeSetting[r][d].afternoonInSetting.minute),m?n.setHours(timeSetting[r][s].morningOutSetting.hour,timeSetting[r][s].morningOutSetting.minute):n.setHours(timeSetting[r][s].afternoonOutSetting.hour,timeSetting[r][s].afternoonOutSetting.minute),a+="<td class='emp_code'><div class='emp_code_main'>"+t.employee_code+"</div></td>",a+="<td class='emp_name'>"+t.employee_name+"</td>",a+="<td class='start_at'>"+getFullDate(i)+"</td>",a+="<td class='end_at'>"+getFullDate(n)+"</td>",a+="<td class='number_days'></td>",a+="<td class='btn-manage'><button type='button' class='btn btn-primary edit' onclick='editEmp("+r+")'><i class='fa fa-pencil-square-o'></i></button>",a+=" <button type='button' class='btn btn-delete delete' onclick='removeEmp("+r+")'><i class='fa fa-minus'></i></button></td>",a+="</tr>",$("#table_supplement_employees > tbody").append(a)}}),calculateNumberDays(),$("#search_employee_ot").html("").trigger("change")},complete:function(){e.data("process",0)}})))}),$.fn.initOTTimeCalendar=function(){$(this).datetimepicker({allowInputToggle:!0,format:"DD-MM-YYYY HH:mm",sideBySide:!0,maxDate:moment().add(10,"y"),minDate:moment().subtract(10,"y"),disabledHours:[23]}).on("dp.show",function(){$(this).data("DateTimePicker").disabledTimeIntervals([[moment().hour(22).minutes(0),moment().hour(23).minutes(59)]])}).on("dp.change",function(){var e=$(this).data("DateTimePicker").date(),t=new Date(e);22===t.getHours()&&(t.setHours(22,0),$(this).data("DateTimePicker").date(t))})},$("#addEmp").find(".btn-confirm").on("click",function(){var e=$("#add_time_start").val(),t=$("#add_time_end").val(),a=moment(convertDate(e)).toDate(),i=moment(convertDate(t)).toDate();if(a.getTime()>i.getTime())return $(".add_time_start-compare-error").removeClass("hidden"),!1;var n=$(this).data("id"),r=$("#table_supplement_employees").find("tr[id="+n+"]");r.find(".start_at").text(e),r.find(".end_at").text(t),$("#addEmp").modal("hide"),calculateNumberDays(),parseInt(n)===parseInt(currentEmpId)&&($("#datetimepicker-start-date").data("DateTimePicker").date(a),$("#datetimepicker-end-date").data("DateTimePicker").date(i))}),$(".managetime-form-register").submit(function(e){preSaveProcessing()}),$("#reason_id").on("change",function(){var e=$(this),t=$("#reason");e.find(":selected").data("other")===typeOther?t.removeClass("hidden"):t.addClass("hidden");var a=$("#image_upload-error");e.find(":selected").data("required")!==typeImageRequired&&a.hide()}),$(function(){$("select#country_id").change(function(){var e=$("#country_id option:selected").attr("code");"JP"===e?$("#add-text-required").html(""):"VN"===e?$("#add-text-required").html("<em>*</em>"):$("#add-text-required").html("")})}),$("body").on("click","#checkbox-serach-employee-type",function(e){$(this).is(":checked")?($("#search_employee_ot").attr("data-type",1),$("#form-register #employee_id").attr("data-type",1)):($("#search_employee_ot").attr("data-type",0),$("#form-register #employee_id").attr("data-type",0)),$(".select-search-employee").selectSearchEmployee()});