function appendToRow(e){var t=$("#row_employees_generate_clone tbody tr").closest("tr").clone();resetRowTable();var a=$('select[name="workingTime"]').val(),i=$('select[name="workingTimeHalf"]').val(),n={startDate:$("#dateStartPicker input").val(),endDate:$("#dateEndPicker input").val()},r="";jQuery.each(e,function(e,o){if(arrEmpIdTable.indexOf(parseInt(o.employee_id))===-1){var d={id:o.employee_id,code:o.employee_code,name:o.employee_name};rowTableNew=setRowTable(t,d,n,a,i),r+=rowTableNew.prop("outerHTML"),arrEmpIdTable.push(parseInt(o.employee_id))}}),$("#table_employees_generate tbody").append(r)}function resetRowTable(){var e="";arrEmpIdTable=[];var t={startDate:$("#dateStartPicker input").val(),endDate:$("#dateEndPicker input").val()},a=$('select[name="workingTime"]').val(),i=$('select[name="workingTimeHalf"]').val();$("#table_employees_generate > tbody tr").each(function(){var n=$(this),r=parseInt(n.data("generate"));r||(parseInt(n.data("status"))&&(n=setRowTableWithTime(n,t,a,i)),e+=n.prop("outerHTML"),arrEmpIdTable.push(parseInt(n.data("id_emp"))))}),$("#table_employees_generate tbody").html(""),$(e).appendTo("#table_employees_generate tbody")}function setTimeRowTable(){arrEmpIdTable=[];var e={startDate:$("#dateStartPicker input").val(),endDate:$("#dateEndPicker input").val()},t=$('select[name="workingTime"]').val(),a=$('select[name="workingTimeHalf"]').val();$("#table_employees_generate > tbody tr").each(function(){var i=$(this);parseInt(i.data("status"))&&setRowTableWithTime(i,e,t,a)})}function setRowTableWithTime(e,t,a,i){var n=workingTimeFrame[a],r=workingTimeHalfFrame[i];return e.attr("data-key_working_time",a),e.attr("data-key_working_time_half",i),e.find(".col-start_date").text(t.startDate),e.find(".col-end_date").text(t.endDate),e.find(".col-morning_in").text(n[0]),e.find(".col-morning_out").text(n[1]),e.find(".col-afternoon_in").text(n[2]),e.find(".col-afternoon_out").text(n[3]),e.find(".col-half_morning").text(r[0]),e.find(".col-half_afternoon").text(r[1]),e}function setRowTable(e,t,a,i,n){var r=workingTimeFrame[i],o=workingTimeHalfFrame[n];return e.attr("data-id_emp",t.id),e.attr("data-key_working_time",i),e.attr("data-key_working_time_half",n),e.find(".col-code").text(t.code),e.find(".col-name").text(t.name),e.find(".col-start_date").text(a.startDate),e.find(".col-end_date").text(a.endDate),e.find(".col-morning_in").text(r[0]),e.find(".col-morning_out").text(r[1]),e.find(".col-afternoon_in").text(r[2]),e.find(".col-afternoon_out").text(r[3]),e.find(".col-half_morning").text(o[0]),e.find(".col-half_afternoon").text(o[1]),e}function findEmployeeByProj(e,t,a){$.ajax({type:"GET",url:urlEmpProj,data:{_token:_token,id_proj:e,start_date:t,end_date:a},success:function(e){appendToRow(e)},error:function(e){}})}function validateRegisterForm(){var e=getFormData(),t=[];return e.reason||t.push(messTheReson),e.approver_id||t.push(messEmpApprove),(!checkIsDate(e.from_date)||!checkIsDate(e.to_date)||e.from_date>e.to_date)&&t.push(messEndThanStart),e.wtDetail.length?e.wtDetail.forEach(function(e){(!checkIsDate(e.end_date)||!checkIsDate(e.start_date)||e.start_date>e.end_date)&&t.push("Nhân viên: <b>"+e.employee_name+"</b> "+messEndLessStart)}):t.push(messNotObject),{status:!t.length,errorMessages:t,data:e}}function submitRegisterForm(e){e.preventDefault();var t="",a=validateRegisterForm();return a.status?($btnSubmit.find("i").removeClass("hidden"),void $.ajax({url:$workingTimeForm.attr("action"),type:$workingTimeForm.attr("method"),data:a.data,dataType:"json",success:function(e){if(e.status)return void(location.href=e.redirect);t+="<li>"+e.message+"</li>";var a="";Object.keys(e.exists||[]).forEach(function(t){$.inArray(t,["leave_day","supplement","business_trip","ot","working_time"])!==-1&&e.exists[t].forEach(function(e){var t="";e.note&&(t+="<div>"+e.note.old_text+"</div><div>"+e.note.new_text+"</div>"),a+="<tr><td>"+e.employee_name+"</td><td>"+e.type+"</td><td>"+new Date(e.date_start).format("d-m-Y H:i")+"</td><td>"+new Date(e.date_end).format("d-m-Y H:i")+"</td><td>"+t+'</td><td><a target="_blank" href="'+e.url.replace(":id",e.id)+'">'+viewDetail+"</a></td></tr>"})}),a&&(t+='<table class="table-register-exist"><thead><tr><th> '+viewEmployee+"</th><th>"+viewAppType+"</th><th>"+viewFromDate+"</th><th>"+viewToDate+"</th><th>"+txtNote+"</th><th></th></tr></thead><tbody>"+a+"</tbody></table>")},error:function(){t="Đã có lỗi xảy ra. Vui lòng thử lại sau!"},complete:function(){$btnSubmit.find("i.fa-refresh").addClass("hidden"),t&&$modalError.modal("show").find(".modal-body").html("<ul>"+t+"</ul>")}})):(a.errorMessages.forEach(function(e){t+="<li>"+e+"</li>"}),void $modalError.modal("show").find(".modal-body").html("<ul>"+t+"</ul>"))}function getFormData(){var e=[];return $("#table_employees_generate > tbody tr").each(function(){var t=$(this);e.push({employee_id:t.data("id_emp"),employee_name:t.find(".col-name").text(),key_working_time:t.attr("data-key_working_time"),key_working_time_half:t.attr("data-key_working_time_half"),start_date:t.find(".col-start_date").text().split("-").reverse().join("-"),end_date:t.find(".col-end_date").text().split("-").reverse().join("-")})}),{register_id:idRegister,approver_id:$('select[name="approver_id"]').val(),related_ids:$('select[name="related_ids[]"]').val(),from_date:$("#dateStartPicker input").val().split("-").reverse().join("-"),to_date:$("#dateEndPicker input").val().split("-").reverse().join("-"),key_working_time:$('select[name="workingTime"]').val(),key_working_time_half:$('select[name="workingTimeHalf"]').val(),proj_id:$("#select-project").val(),reason:$('textarea[name="reason"]').val().trim(),wtDetail:e,_token:_token}}!function(e){RKfuncion.select2.init()}(jQuery);var $modalError=$("#modalError"),$workingTimeForm=$("#working_time_form"),$btnSubmit=$workingTimeForm.find("#btn-submit-form");$(function(){$("body").on("change","#select-project",function(e){var t=$(this).val(),a=$("#dateStartPicker input").val(),i=$("#dateEndPicker input").val();return t?a&&i?void findEmployeeByProj(t,a,i):($("#modalError .modal-body").html("<p>"+messRequired+"</p>"),void $(".btn-modalError").click()):void resetRowTable()}),$("body").on("change",".select-time",function(e){var t=$("#dateStartPicker input").val(),a=$("#dateEndPicker input").val();t&&a&&setTimeRowTable()}),$(".datepicker").datetimepicker({format:"DD-MM-YYYY"}).on("dp.change",function(e){var t=$('select[name="project_id"]').val(),a=$("#dateStartPicker input").val(),i=$("#dateEndPicker input").val();(!t||a&&i)&&setTimeRowTable(),!t||!a||!i}),$(".datepickerModal").datetimepicker({format:"DD-MM-YYYY"}).on("dp.change",function(e){})}),$(function(){$("#table_employees_generate").on("click",".btn-delete",function(){var e=$(this).closest("tr").data("id_emp");const t=arrEmpIdTable.indexOf(e);t>-1&&arrEmpIdTable.splice(t,1),$(this).closest("tr").remove()}),$("#table_employees_generate").on("click",".btn-edit",function(){var e=$(this).closest("tr"),t=e.data("key_working_time"),a=e.data("key_working_time_half");$("#dateStartPickerEdit input").val(e.find(".col-start_date").text()),$("#dateEndPickerEdit input").val(e.find(".col-end_date").text()),$('input[name="empId"]').val(e.attr("data-id_emp")),$('select[name="workingTimeEdit"] option').each(function(){$(this).val()==t?$(this).attr("selected","selected"):$(this).prop("checked",!1)}),$('select[name="workingTimeHalfEdit"] option').each(function(){$(this).val()==a?$(this).attr("selected","selected"):$(this).prop("checked",!1)}),$(".select2-base").select2(),$(".btn-modalEdit").click()})}),$("#modalEdit").on("click",".btn-submit-update",function(){var e=$('input[name="empId"]').val(),t=$('select[name="workingTimeEdit"]').val(),a=$('select[name="workingTimeHalfEdit"]').val(),i={startDate:$('input[name="startDateEdit"]').val(),endDate:$('input[name="endDateEdit"]').val()};$("#table_employees_generate > tbody tr").each(function(){var n=$(this),r=parseInt(n.data("id_emp"));r==e&&(setRowTableWithTime(n,i,t,a),n.attr("data-status",statusNotUpdate),n.attr("data-generate",statusNotGenerate))}),$(".btn-modalEdit").click()}),$("form").on("click","#btn_add_employee_table_generate",function(){var e=$("#search_add_employee").select2("data"),t=$("#row_employees_generate_clone tbody tr").closest("tr").clone(),a=$('select[name="workingTime"]').val(),i=$('select[name="workingTimeHalf"]').val(),n={startDate:$("#dateStartPicker input").val(),endDate:$("#dateEndPicker input").val()},r="";$.each(e,function(e,o){var d={id:o.id,code:o.employee_code,name:o.employee_name};arrEmpIdTable.indexOf(parseInt(d.id))===-1&&(t.attr("data-generate",statusNotGenerate),rowTableNew=setRowTable(t,d,n,a,i),r+=rowTableNew.prop("outerHTML"),arrEmpIdTable.push(parseInt(d.id)))}),$("#table_employees_generate tbody").append(r),$("#search_add_employee").html("").trigger("change")}),$btnSubmit.click(submitRegisterForm),$("#working_time_form button.status-submit").click(function(){var e=$(this),t=e.data("url"),a=e.data("status"),i=e.data("id"),n=!0,r="";return"undefined"!=typeof i&&i||(r="<li> "+messEmpNotCode+" </li>",n=!1),t&&a||(r+="<li> Có lỗi xảy ra!</li>",n=!1),n?void bootbox.confirm({className:"modal-warning",message:e.data("noti"),buttons:{cancel:{label:confirmNo},confirm:{label:confirmYes}},callback:function(e){e&&($("#working_time_form").attr("action",t),$("#working_time_form").submit())}}):($("#modalError .modal-body").html("<ul>"+r+"</ul>"),$(".btn-modalError").click(),!1)}),$("#btn_time_modal_reject").click(function(){$("#wk_time_modal_reject").modal("show")}),$(function(){$('select[name="workingTime"]').change(function(){var e=wKTRelation[$(this).val()];$('select[name="workingTimeHalf"] option').each(function(){$(this).val()==e?($(this).attr("selected","selected"),$(this).trigger("change")):$(this).attr("selected",!1)})}),$('select[name="workingTimeEdit"]').change(function(){var e=wKTRelation[$(this).val()];$('select[name="workingTimeHalfEdit"] option').each(function(){$(this).val()==e?($(this).attr("selected","selected"),$(this).trigger("change")):$(this).attr("selected",!1)})})});