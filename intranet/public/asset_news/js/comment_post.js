function initVirtualEditor(e){void 0!==e&&e.length||(e=$(".emojis-wysiwyg")),e.each(function(){var e=$(this).val();return!e||void(e=e.trim())}),e.emojiarea({wysiwyg:!0,buttonLabel:'<img src="'+emoticonPath+'/icon.jpg" alt="smiley" width="20" />'}),$(".emoji-button").attr("title","smiley")}function setEmoticonContent(e){console.log(replaceTextToIcon(getValueCmt(e.data("id")))),e.html(nl2br(replaceTextToIcon(getValueCmt(e.data("id"))))),0===e.text().replace(/\s/g,"").length&&e.find("img").length<20&&e.find("img").addClass("img-big"),RKExternal.moreHeight.viewMore(e),e.find("img").load(function(){RKExternal.moreHeight.viewMore(e)})}function nl2br(e,t){if("undefined"==typeof e||null===e)return"";var o=t||"undefined"==typeof t?"<br />":"<br>";return(e+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+o+"$2")}function setAllEmoticonContent(e,t){"undefined"!=typeof t&&t&&t.length||(t=$(".content-block .span-comment")),t.each(function(){setEmoticonContent($(this),e)})}function nl2br(e,t){var o=t||"undefined"==typeof t?"<br />":"<br>";return(e+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+o+"$2")}function escapeHtml(e){return e}function refreshCountComment(e){var t=$(".count-comment:last"),o=t.data("count-org");o=o?parseInt(o):0,o+=parseInt(e),t.data("count-org",o),$(".count-comment").text(o)}function refreshCountCommentUp(e){var t=$(".count-comment-up"),o=t.text().trim();o=o?parseInt(o):0,t.text(o+parseInt(e))}function warning(e){e.parent().find("#comment-error").html(required_comment),e.css("border","1px solid red"),setTimeout(function(){e.parent().find("#comment-error").html(""),e.css("border","1px solid #ccc")},2e3)}function resetEditorMain(){$("#create_comment .emoji-wysiwyg-editor").html("").blur().trigger("blur"),$('.emoji-wysiwyg-editor[contenteditable="false"]').attr({contenteditable:"true"})}function refreshEditor(){$(".emoji-wysiwyg-editor").remove(),$(".emoji-button").remove(),initVirtualEditor()}function focusEditor(e){if(e=e.get(0),e.focus(),"undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange){var t=document.createRange();t.selectNodeContents(e),t.collapse(!1);var o=window.getSelection();o.removeAllRanges(),o.addRange(t)}else if("undefined"!=typeof document.body.createTextRange){var n=document.body.createTextRange();n.moveToElementText(e),n.collapse(!1),n.select()}}function removeLoadMoreLess(e){$("a.load-more.comment-"+e).remove(),$("a.load-less.comment-"+e).remove()}function cancelEdit(e,t,o){e.hasClass("reply-new")?(e.val("").trigger("input"),e.closest("div[id^=reply-]").addClass("hidden"),e.closest(".content-block").find(".load-more").removeClass("hidden")):(e.val(o.text()),e.parent(".parent-comment").addClass("hidden"),t.removeClass("hidden"),e.closest(".content-block").find(".load-more").removeClass("hidden"),refreshEditor())}function showEditForm(e,t,o){e.find(".parent-comment").removeClass("hidden"),$("span.comment-"+t).addClass("hidden"),$("a.comment-"+t+".load-more").addClass("hidden"),$("a.comment-"+t+".load-less").addClass("hidden");var n=e.find(o),a=n.next(".emoji-wysiwyg-editor");a.html(getValueCmt(t)).blur().trigger("blur"),focusEditor(a)}function viewMore(e){var t=$("p.content-comment.not-trim-comment.comment-"+e).html();$("span.comment-"+e).html(replaceTextToIcon(t)),$("a.load-more.comment-"+e).addClass("hidden"),$("a.load-less.comment-"+e).removeClass("hidden")}function viewLess(e){var t=$("p.content-comment.trim-comment.comment-"+e).html();$("span.comment-"+e).html(replaceTextToIcon(t)),$("a.load-more.comment-"+e).removeClass("hidden"),$("a.load-less.comment-"+e).addClass("hidden")}function stripTags(e){return e.replace(/<[^>]+>/gm,"")}function replaceTextToIcon(e){e=converter.makeHtml(e);for(var t in icons)e=e.replace(new RegExp(escapeRegex(t),"g"),getImage(t));return e}function getImage(e){return'<img src="'+emoticonPath+"/"+icons[e]+'" alt="'+e+'" class="emoji" />'}function escapeRegex(e){return(e+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}function getValueCmt(e){return"undefined"!=typeof cmtAll[e]?stripTags(cmtAll[e]):""}var converter=new showdown.Converter({omitExtraWLInCodeBlocks:!0,noHeaderId:!0,simplifiedAutoLink:!0,strikethrough:!0,tables:!0,takslists:!0,ghMentions:!0,ghMentionsLink:siteConfigGlobal.base_url+"contact?s={u}@rikkeisoft.com"});RKExternal.moreHeight.init(),$.emojiarea.path=emoticonPath,$.emojiarea.icons=icons,initVirtualEditor(),setAllEmoticonContent(!0),$(document).on("keydown",".emoji-wysiwyg-editor",function(e){var t=$(this),o=t.prev("textarea"),n=escapeHtml(o.val().trim());if(e.altKey&&13===e.which||13===e.which&&e.shiftKey){if(!n)return!1}else if(13===e.keyCode){if(!n)return o.next(".emoji-wysiwyg-editor").attr("tabindex",-1).focus(),warning(t),!1;var a=jQuery.Event("keydown");a.which=13,a.keyCode=13,o.trigger(a)}else if(27===e.keyCode){var a=jQuery.Event("keydown");a.which=27,a.keyCode=27,o.trigger(a)}}),$(document).on("paste",".emoji-wysiwyg-editor",function(){var e=$(this),t=e.prev("textarea");setTimeout(function(){var o=e.text();t.val(o)},100)}),$(document).on("keyup",".emoji-wysiwyg-editor",function(){var e=$(this),t=e[0].scrollHeight,o=e.next(".emoji-button"),n=t>150?"20px":"5px";o.css("right",n)}),$(document).on("keydown",".textarea-parent",function(e){var t=$(this),o=t.parent(".parent-comment").find('input[name="id"]').val(),n=t.parent(".parent-comment").find('input[name="post_id"]').val(),a=t.closest("div.content-comment-"+o).find("span.comment-"+o),r=t.closest("div.content-comment-"+o).find("p.not-trim-comment.comment-"+o),i=escapeHtml(t.val().trim()),c=t.next(".emoji-wysiwyg-editor");if(e.altKey&&13===e.which||13===e.which&&e.shiftKey){if(t.textareaAutoSize(),!i)return!1}else if(13===e.keyCode){if(!i)return warning(t),!1;if($.trim(r.text())===i)return t.parent().addClass("hidden"),a.removeClass("hidden").html(c.html()),removeLoadMoreLess(o),setEmoticonContent(a),!1;c.attr("contenteditable","false"),$.ajax({url:comment_url,method:"POST",timeout:1e4,data:{comment:i,post_id:n,_token:_token,id:o},success:function(e){if(e==-1)return cancelEdit(t,a,p),void $("#comment-error-modal").modal("show");if(o&&""!==o){a.removeClass("hidden"),cmtAll[o]=i,t.textareaAutoSize(),t.parent(".parent-comment").addClass("hidden");var n=t.closest(".area-comment");if(setAllEmoticonContent(!0,n.find(".span-comment")),removeLoadMoreLess(o),resetEditorMain(),!checkPermission&&sttAutoSettingApproveComment!=sttAutoApproveComment){$("#approve-message-"+o).length>0&&$("#approve-message-"+o).remove();var r=$("<span class='error' id='approve-message-"+o+"'> (Bình luận này chưa được duyệt) </span>");if($(".content-comment-"+o).before(r),$(".status_value_"+o).val()!=stt){$(".content-comment-"+o).css("background","#f7f0cb");var c=$(".store_value_"+o).val();$(".content-comment-"+o).attr({"data-toggle":"tooltip",title:"Approved Value:"+c})}}}else{t.val(""),$("#comment-content-pending").prepend(e),t.css("height","46px"),refreshCountComment(1),refreshCountCommentUp(1);var n=$("#comment-content-pending").children(":first-child");initVirtualEditor(n.find(".emojis-wysiwyg")),setAllEmoticonContent(!0,n.find(".span-comment")),resetEditorMain()}},error:function(){refreshEditor(),$("#comment-error-modal").modal("show")}})}else 27===e.keyCode&&(t.hasClass("root-comment")?(t.val(""),refreshEditor(),focusEditor(c)):cancelEdit(t,a,r))}),$(document).on("click",".reply-comment",function(){var e=$(this).attr("data-id"),t=$("#add_new_reply_"+e+" #reply-"+e);t.removeClass("hidden"),refreshEditor();var o=t.find(".emoji-wysiwyg-editor");focusEditor(o)}),$(document).on("keydown",".reply-text",function(e){var t=$(this),o=t.parent(".parent-comment").find('input[name="id"]').val(),n=$("#create_comment").find('input[name="post_id"]').val(),a=t.attr("data-parent-id"),r=t.closest("div.content-reply-comment-"+o).find("span.comment-"+o),i=t.closest("div.content-reply-comment-"+o).find("p.not-trim-comment.comment-"+o),c=$.trim($(this).val()),l=t.next(".emoji-wysiwyg-editor");if(e.altKey&&13===e.which||13===e.which&&e.shiftKey){if(t.textareaAutoSize(),!c)return!1}else if(13===e.keyCode){if(!c)return t.parent().find("#comment-error").html(required_comment),t.css("border","1px solid red"),setTimeout(function(){t.parent().find("#comment-error").html(""),t.css("border","1px solid #ccc")},2e3),!1;if($.trim(i.text())===c)return t.parent().addClass("hidden"),r.removeClass("hidden").html(l.html()),removeLoadMoreLess(o),setEmoticonContent(r),!1;l.attr("contenteditable","false"),$.ajax({url:comment_url,method:"POST",timeout:1e4,data:{comment:c,_token:_token,parent_id:a,id:o,post_id:n},success:function(e){if(parseInt(e)===parseInt(-1))return cancelEdit(t,r,i),$("#comment-error-modal").modal("show"),!1;if(o){cmtAll[o]=c,t.textareaAutoSize(),t.parent().addClass("hidden");var n=t.closest(".area-comment");if(setAllEmoticonContent(!0,n.find(".span-comment")),r.removeClass("hidden"),i.html(nl2br(c,!1)),removeLoadMoreLess(o),resetEditorMain(),!checkPermission&&sttAutoSettingApproveComment!=sttAutoApproveComment){$("#approve-message-"+o).length>0&&$("#approve-message-"+o).remove();var l=$("<span class='error' id='approve-message-"+o+"'> (Bình luận này chưa được duyệt) </span>");if($(".content-reply-comment-"+o).before(l),$(".value_status_reply_"+o).val()!=stt){$(".content-reply-comment-"+o).css("background","#f7f0cb");var s=$(".value_reply_"+o).val();$(".content-reply-comment-"+o).attr({"data-toggle":"tooltip",title:"Approved Value:"+s})}}}else{t.val(""),$("#content-reply-"+a).prepend(e),t.closest("#reply-"+a).addClass("hidden"),refreshCountComment(1),refreshCountCommentUp(1);var n=$("#content-reply-"+a).children(":first-child");initVirtualEditor(n.find(".emojis-wysiwyg")),setAllEmoticonContent(!0,n.find(".span-comment")),resetEditorMain()}},error:function(){refreshEditor(),$("#comment-error-modal").modal("show")}})}else 27===e.keyCode&&cancelEdit(t,r,i)}),$("#load_more_comment").click(function(){page=parseInt(page)+1,$.ajax({url:url_load_more,data:{page:page,post_id:post_id,_token:siteConfigGlobal.token},type:"post",success:function(e){$("#get-more-comment").append(e.data),e.comments.next_page_url||$("#load_more_comment").remove(),setAllEmoticonContent(),resetEditorMain()}})}),$(document).on("click",".edit-comment",function(e){e.preventDefault();var t=$(this).attr("data-id");showEditForm($(".content-comment-"+t),t,".textarea-parent")}),$("body").on("click",".edit-reply-comment",function(e){e.preventDefault();var t=$(this).attr("data-id");showEditForm($(".content-reply-comment-"+t),t,".reply-text")}),$("body").on("click",".delete-comment",function(e){e.preventDefault();var t=$(this).attr("data-id");bootbox.confirm({message:"Are you sure delete comment?",className:"modal-default",buttons:{cancel:{label:"Cancel",className:"pull-left"}},callback:function(e){e&&$.ajax({method:"POST",url:delete_comment,data:{id:t,_token:_token},success:function(e){$(".comment-post-"+t).remove(),e&&e.count&&(refreshCountComment(-e.count),refreshCountCommentUp(-e.count))}})}})}),$("body").on("click",".delete-reply-comment",function(e){e.preventDefault();var t=$(this),o=t.attr("data-id");bootbox.confirm({message:"Are you sure delete comment?",className:"modal-default",buttons:{cancel:{label:"Cancel",className:"pull-left"}},callback:function(e){e&&$.ajax({method:"POST",url:delete_comment,data:{id:o,_token:_token},success:function(e){$(".content-reply-"+o).remove(),e&&e.count&&(refreshCountComment(-e.count),refreshCountCommentUp(-e.count))}})}})}),$("body").on("click",".btn-approve",function(){var e=$(this);e.prop("disabled","disabled");var t=e.attr("data-id"),o=$("#approve-message-"+t);$.ajax({type:"post",data:{id:t,_token:siteConfigGlobal.token},url:approve_url,success:function(n){$("#approve-"+t).fadeOut("fast"),o.html(n).hide().fadeIn("slow"),o.removeClass("error"),o.css("color","red"),e.parents(".comment-parent").find(".reply-comment").remove();var a=e.closest(".area-comment").find(".format");e.data("root")&&a.prepend('<a class="reply-comment" data-id="'+t+'">Trả lời</a>');var r='<div class="like-div">';r+='<a class="like-button" onclick="like(this, '+t+", "+typeComment+')" link="'+like_url+'">',r+='<i class="font-style-normal thumb-dislike">'+likeText+"</i>",r+="</a>",r+="&nbsp",r+='<div class="like-container hidden" onclick="showLike('+t+", "+typeComment+')">',r+='<i class="fa fa-thumbs-up thumb-like size-detail" aria-hidden="true"></i>',r+='<span class="count-like">0</span>',r+="</div>",r+="</div>",a.prepend(r);var i=$("#approve-message-"+t).next().prop("className");i.indexOf("content-comment")>-1?($(".content-comment-"+t).css("background",""),$(".content-comment-"+t).tooltip("disable"),e.parents(".comment-parent").find(".edit-comment").length<1&&e.parents(".comment-parent").find(".btn-group").remove()):($(".content-reply-comment-"+t).css("background",""),$(".content-reply-comment-"+t).tooltip("disable"),e.parents(".comment-parent").find(".edit-comment").length<1&&e.parents(".area-comment").find(".dropdown.reply-comment-menu").remove())}})});var reply_page=1;$(document).on("click",".loadmore-comment-reply",function(){parent_id=$(this).attr("data-id"),reply_page+=1,total=reply_page*commentPerPage,$.ajax({url:url_load_more,data:{page:reply_page,parent_id:parent_id,_token:siteConfigGlobal.token},type:"post",success:function(e){$("#get-more-reply-comment-"+parent_id).append(e.view),total>=e.data&&$("#loadmore-reply-"+parent_id).remove(),refreshEditor(),setAllEmoticonContent(!0)}})}),$(document).ready(function(){var e=$('input[name="_token"]').val();$("#checkedAll").change(function(){$("input:checkbox").not(this).prop("checked",this.checked)}),$(".checkSingle").click(function(){if($(this).is(":checked")){var e=0;$(".checkSingle").each(function(){this.checked||(e=1)}),0==e&&$("#checkedAll").prop("checked",!0)}else $("#checkedAll").prop("checked",!1)}),$(".deleteAll").click(function(){bootbox.confirm({message:"Are you sure?",className:"modal-default",buttons:{cancel:{label:"Cancel",className:"pull-left"}},callback:function(t){t&&(listValue=[],$(".checkSingle:checked").each(function(){$(this).val()&&listValue.push(parseInt($(this).val()))}),listValue.length<=0?bootbox.alert({message:"Please select row delete",className:"modal-default"}):$.ajax({url:url_delete,type:"POST",data:{_token:e,data:listValue},dataType:"JSON",success:function(e){e.success?location.reload():e.error&&bootbox.alert({message:e.error,className:"modal-default"})},error:function(e){bootbox.alert({message:e.responseText,className:"modal-default"})}}))}})}),$("#approveAll").click(function(){bootbox.confirm({message:"Are you sure approve all comment?",className:"modal-default",buttons:{cancel:{label:"Cancel",className:"pull-left"}},callback:function(t){t&&(listDataId=[],$(".checkSingle:checked").each(function(){$(this).val()&&listDataId.push(parseInt($(this).val()))}),listDataId.length<=0?bootbox.alert({message:"Select comment need approve",className:"modal-default"}):$.ajax({url:url_approve_all,method:"POST",data:{data:listDataId,_token:e},success:function(e){for(var t=0;t<listDataId.length;t++){var o=listDataId[t];$(".changeStatus-"+o).html("Approve")}$("input:checkbox").removeAttr("checked"),bootbox.alert({message:"Comment approve success",className:"modal-default"})}}))}})}),$("#un_approve_all").click(function(){bootbox.confirm({message:"Are you sure unapprove all comment?",className:"modal-default",buttons:{cancel:{label:"Cancel",className:"pull-left"}},callback:function(t){t&&(listDataId=[],$(".checkSingle:checked").each(function(){$(this).val()&&listDataId.push(parseInt($(this).val()))}),listDataId.length<=0?bootbox.alert({message:"Select comment need unapprove",className:"modal-default"}):$.ajax({url:url_unapprove_all,method:"POST",data:{data:listDataId,_token:e},success:function(){for(var e=0;e<listDataId.length;e++){var t=listDataId[e];$(".changeStatus-"+t).html("Unapprove")}$("input:checkbox").removeAttr("checked"),bootbox.alert({message:"Unapprove all comment success",className:"modal-default"})}}))}})})}),$(document).ready(function(){$(".dropdown-menu.action-reply-comment").attr("style","max-height: none !important"),$('[data-toggle="tooltip"]').tooltip()}),$("#icon-comment").click(function(){$("html, body").animate({scrollTop:$("#my-comment").offset().top},1500)}),$("#tagcloud a").tagcloud({size:{start:14,end:36,unit:"px"},color:{start:"#6f6f6f",end:"#6f6f6f"}}),$(".view-more").click(function(){var e=$(this).parent().find(".full-comment").html();$("#modal-comment .modal-body p").html(e),$("#modal-comment").modal("show")});