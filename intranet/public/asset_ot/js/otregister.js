function initAddOtEmployee(){var e=$("#form_id").val();$("#emp_list").select2({minimumInputLength:1,containerCssClass:"show-hide",ajax:{url:urlSearchEmp,dataType:"json",delay:250,data:function(e){return{queryStr:$.trim(e.term),registerId:$("#register_id").data("id")}},processResults:function(e){return{results:e}}}}),$("#emp_list").on("select2:close",function(){var t=$("#emp_list").select2("data");t[0]&&($("#add_register_code").prop("data-id",t[0].id),$("#add_register_code").val(t[0].code),$("#add_time_start").val(""),$("#add_time_end").val(""),$("#add_time_start").prop("disabled",!1),$("#add_time_start").val()&&validateTimeSlot($("#add_time_start"),e,t[0].id,$("#add_time_start").val()),$("#add_time_end").val()&&validateTimeSlot($("#add_time_end"),e,t[0].id,$("#add_time_end").val()))}),$("#addEmp").find(".btn-confirm").on("click",function(){addOtEmployee($("#add_register_code").attr("data-id")),checkTimeNotFilled()?$("#error_time_not_filled").show():$("#error_time_not_filled").hide()})}function validateTime(){controlOTStartTime(!0),controlOTStartTime(!1),controlOTEndTime(!0),controlOTEndTime(!1)}function setStartDateOnChange(e,t,a,i,r){var n=timeSetting[a][t],d=n.afternoonOutSetting,o=n.morningInSetting;void 0===r||e.format("Y-m-d")!==r.format("Y-m-d")?setTimeStart(e,i,n):isHoliday(e)||isWeekend(e)||"japan"===teamCodePreOfEmp?e.format("H:i")<convertTime(o.hour,o.minute)&&e.setHours(o.hour,o.minute):isProjAllowed($projectSelect.val(),projectAllowedOT18Key)?e.format("H:i")<convertTime(d.hour,d.minute)&&e.setHours(d.hour,d.minute):e.format("H:i")<convertTime(d.hour+1,d.minute)&&e.setHours(d.hour+1,d.minute),i.data("DateTimePicker").date(e)}function setEndDateOnChange(e,t){e.format("H:i")>="22:00"&&e.setHours(22,0),t.data("DateTimePicker").date(e)}function setTimeStart(e,t,a){var i=[],r=new Date(t.data("DateTimePicker").date()),n=a.morningInSetting,d=a.afternoonOutSetting;isHoliday(e)||isWeekend(e)?(e.setHours(n.hour,n.minute),i.push([r.setHours(0,0),r.setHours(n.hour-1,n.minute)])):isProjAllowed($projectSelect.val(),projectAllowedOT18Key)?(e.setHours(d.hour,d.minute),i.push([r.setHours(0,0),r.setHours(d.hour-1,d.minute)])):(e.setHours(d.hour+1,d.minute),i.push([r.setHours(0,0),r.setHours(d.hour,d.minute)])),isEmpJp||i.push([r.setHours(22,0),r.setHours(23,59)]),t.data("DateTimePicker").disabledTimeIntervals(i),t.data("DateTimePicker").disabledHours([0])}function controlOTStartTime(e){var t=e?"mainForm":"popupForm",a=$startContainers[t],i=$endContainers[t];a.on("dp.show",function(t){var i=new Date(a.data("DateTimePicker").date()),r=getEmployeeId(e),n=timeSetting[r][i.format("Y-m-d")];setTimeStart(i,a,n)}),a.on("dp.change",function(t){a.data("DateTimePicker").date()||a.data("DateTimePicker").date(new Date);var r;if(t.oldDate&&(r=new Date(moment(t.oldDate.format("DD-MM-YYYY HH:mm").toString(),"DD-MM-YYYY HH:mm"))),t.date){var n=new Date(a.data("DateTimePicker").date()),d=new Date(i.data("DateTimePicker").date()),o=getEmployeeId(e),s=a.children("input").valid();updateTimeSettingData(o,n.format("Y-m-d"),d.format("Y-m-d")),setStartDateOnChange(n,n.format("Y-m-d"),o,a,r),changeEvent(e),a.siblings(".errorTxt").empty(),s&&e&&(o=$("#register_id").data("id"),$tableEmployeeOT.find("tr#"+o+" td.start_at").text($timeStart.val()),$tableEmployeeOT.find("tr#"+o+" td.end_at").text($timeEnd.val()))}i.children("input").val()&&i.children("input").valid()}),a.find("input").on("keyup mouseup",function(){""==a.find("input").val()&&a.siblings(".errorTxt").empty()})}function controlOTEndTime(e){var t=e?"mainForm":"popupForm",a=$startContainers[t],i=$endContainers[t];i.on("dp.change",function(t){if(!i.data("DateTimePicker").date()){var r=new Date;r.setHours(22,0),i.data("DateTimePicker").date(r)}if(t.date){var n=new Date(a.data("DateTimePicker").date()),d=new Date(i.data("DateTimePicker").date()),o=getEmployeeId(e),s=i.children("input").valid();updateTimeSettingData(o,n.format("Y-m-d"),d.format("Y-m-d")),setEndDateOnChange(d,i),changeEvent(e),s&&e&&(o=$("#register_id").data("id"),$tableEmployeeOT.find("tr#"+o+" td.start_at").text($timeStart.val()),$tableEmployeeOT.find("tr#"+o+" td.end_at").text($timeEnd.val()))}a.children("input").val()&&a.children("input").valid()}),i.find("input").on("keyup mouseup",function(){""==i.find("input").val()&&i.siblings(".errorTxt").empty()})}function getEmployeeId(e){var t=currentEmpId;return $("select#employee_id").length>0&&null!=$("select#employee_id").val()&&(t=$("select#employee_id").val()),e||(t=$("#add_register_code").data("id")),t}function getLunchBreak(e,t,a,i,r){var n=new Date,d=new Date;n.setHours(timeSetting[i][r].morningOutSetting.hour,timeSetting[i][r].morningOutSetting.minute,0),d.setHours(timeSetting[i][r].afternoonInSetting.hour,timeSetting[i][r].afternoonInSetting.minute,0);var o=getTimeDiff(n,d),s=a;return isMorningInTime(e)&&!isMorningOutTime(t)?s++:!isMorningInTime(e)&&isMorningOutTime(t)&&s--,s<0&&(s=0),o*s}function isMorningInTime(e){var t=[7,8,9,10,11,12];return $.inArray(e.getHours(),t)!==-1}function isMorningOutTime(e){var t=[7,8,9,10,11,12,13];return $.inArray(e.getHours(),t)!==-1}function getTimeDiff(e,t){return e=parseInt(new Date(e).getTime()/1e3),t=parseInt(new Date(t).getTime()/1e3),e>t?0:(t-e)/3600}function changeEvent(e){if(e)var t="#datetimepicker_start",a="#datetimepicker_end";else var t="#datetimepicker_add_start",a="#datetimepicker_add_end";var i=moment($(t).find("input:first").val(),"DD-MM-YYYY"),r=moment($(a).find("input:first").val(),"DD-MM-YYYY"),n=new Date(moment($(t).find("input:first").val(),"DD-MM-YYYY HH:mm")),d=new Date(moment($(a).find("input:first").val(),"DD-MM-YYYY HH:mm"));if(e){if($("#check_change_date").val(1),$("#check_set_break_time").val(0),$("#has_set_time_break").empty(),null!=i&&null!=r){i=new Date(i),r=new Date(r),i.setHours(0,0),r.setHours(0,0),$("#table_ot_employees").find("tr#"+$("#register_id").data("id")).find("td.emp_code .has-set-time-break-edit").html(""),hasHolidayOrWeekend(i,r,annualHolidayList,specialHolidayList)?$("#form_set_time_break").show():$("#form_set_time_break").hide();for(var o=0,s=i;s<=r;s.setDate(s.getDate()+1)){var l=isHolidayOrWeekend(s,annualHolidayList,specialHolidayList);if(l){var m=getDayOfWeek(s.getDay()),c=get2Digis(s.getDate())+"/"+get2Digis(s.getMonth()+1)+"/"+s.getFullYear();$("#duplicate_set_time_break_item .time-break-date .time-break-date-val").attr("data-date",c).text(c),$("#duplicate_set_time_break_item .time-break-date .time-break-date-day").text(" ("+m+")"),$("#duplicate_set_time_break_item .time-break-value").attr("data-date",c);var u=$("#duplicate_set_time_break_item").html();$("#has_set_time_break").append(u),$("#table_ot_employees").find("tr#"+$("#register_id").data("id")).find("td.emp_code .has-set-time-break-edit").append(u);var p=currentEmpId;$("select#employee_id").length>0&&null!=$("select#employee_id").val()&&(p=$("select#employee_id").val());var _=setLunchBreak(p,s,n,d,c);o+=_,void 0===timeBreakOrigin[p]&&(timeBreakOrigin[p]={}),timeBreakOrigin[p][c]=_,setTimeBreak(p),saveSetTimeBreak()}}$("#total_time_break").val(rounding(o,2)),$("#table_ot_employees").find("tr#"+$("#register_id").data("id")).find(".relax").text(rounding(o,2))}}else if(null!=i&&null!=r){i=new Date(i),r=new Date(r),i.setHours(0,0),r.setHours(0,0),$("#box_set_time_break_edit").html("");for(var s=i;s<=r;s.setDate(s.getDate()+1)){var l=isHolidayOrWeekend(s,annualHolidayList,specialHolidayList);if(l){var m=getDayOfWeek(s.getDay()),c=get2Digis(s.getDate())+"/"+get2Digis(s.getMonth()+1)+"/"+s.getFullYear();$("#duplicate_set_time_break_item .time-break-date .time-break-date-val").attr("data-date",c).text(c),$("#duplicate_set_time_break_item .time-break-date .time-break-date-day").text(" ("+m+")"),$("#duplicate_set_time_break_item .time-break-value").attr("data-date",c);var u=$("#duplicate_set_time_break_item").html();$("#box_set_time_break_edit").append(u);var p=$("#add_register_code").attr("data-id");o+=setLunchBreak(p,s,n,d,c);var f=breakTimesEmployees[p][c];$('#box_set_time_break_edit .time-break-value[data-date="'+c+'"]').val(f)}}}}function setLunchBreak(e,t,a,i,r){var n=t.format("Y-m-d"),d=new Date(n),o=new Date(n),s=a.format("Y-m-d"),l=t.format("Y-m-d"),m=i.format("Y-m-d"),c=timeSetting[e][n];s<l&&l<m?(d.setHours(c.morningInSetting.hour,c.morningInSetting.minute,0),o.setHours(c.afternoonOutSetting.hour,c.afternoonOutSetting.minute,0)):s<l&&l===m?(d.setHours(c.morningInSetting.hour,c.morningInSetting.minute,0),isMorningOutTime(i)?o.setHours(c.morningOutSetting.hour,c.morningOutSetting.minute,0):o.setHours(c.afternoonOutSetting.hour,c.afternoonOutSetting.minute,0)):s===l&&l<m?(o.setHours(c.afternoonOutSetting.hour,c.afternoonOutSetting.minute,0),isMorningInTime(a)?d.setHours(c.morningInSetting.hour,c.morningInSetting.minute,0):d.setHours(c.afternoonInSetting.hour,c.afternoonInSetting.minute,0)):(d.setHours(a.getHours(),a.getMinutes()),o.setHours(i.getHours(),i.getMinutes()));var u=getLunchBreak(d,o,0,e,n);return void 0===breakTimesEmployees[e]&&(breakTimesEmployees[e]={}),breakTimesEmployees[e][r]=u,u}function validateTimeSlot(e,t,a,i){$.ajax({url:urlcheckOccupiedTimeSlot,type:"GET",data:{id:a,time:i,regId:t},success:function(t){0!=t?e.siblings(".errorTxt").html(errList[4]):e.siblings(".errorTxt").empty()}})}function validateTimeSlotExist(e,t,a,i,r,n){$.ajax({url:urlAjaxCheckOccupiedTimeSlot,type:"GET",data:{employeeId:i,startDate:r,endDate:n,registerId:a},success:function(a){a?e.siblings(".errorTxt").html(errList[4]):(e.siblings(".errorTxt").empty(),t.siblings(".errorTxt").empty())}})}function checkExistTimeSlotBeforeSubmit(){var e=!1,t=[];$("#table_ot_employees > tbody").find("tr").length>0&&$("#table_ot_employees > tbody").find("tr").each(function(e,a){var i=$(this).find("td");t.push({empId:$(this).attr("id"),empCode:i.closest(".emp_code").children(".emp_code_main").text().trim(),empName:i.closest(".emp_name").text(),startAt:i.closest(".start_at").text(),endAt:i.closest(".end_at").text(),isPaid:i.find("input").is(":checked"),"break":i.closest(".relax").text()})});var a=JSON.stringify(t);return $.ajax({async:!1,url:urlAjaxCheckExistTimeSlotByEmployees,type:"GET",data:{dataEmployees:a,registerId:$("#form_id").val()},success:function(t){e=t.hasErrorExist,e&&$("#exist_time_lot_before_submit_error").html(t.html)}}),e}function validateForm(){$("#form-register").validate({rules:{leader_input:{required:!0},reason:{required:!0},project_list:{required:!0},time_start:{required:!0,compareTimeStart:"#time_end"},time_end:{required:!0,compareTimeEnd:"#time_start",enddateMax:!0},relax:{number:!0,checkBreak:!0,checkBreakOT:["#time_start","#time_end"]}},messages:{leader_input:{required:errList[0]},reason:{required:errList[0]},project_list:{required:errList[0]},time_start:{required:errList[0],compareTimeStart:errList[5]},time_end:{required:errList[0],compareTimeEnd:errList[2]},relax:{number:errList[7],checkBreak:errList[3],checkBreakOT:errList[3]}},errorPlacement:function(e,t){e.insertAfter(t.parent())}}),$("#addEmpForm").validate({rules:{add_time_start:{required:!0,compareTimeStart:"#add_time_end"},add_time_end:{required:!0,compareTimeEnd:"#add_time_start"}},messages:{add_time_start:{required:errList[0],compareTimeStart:errList[5]},add_time_end:{required:errList[0],compareTimeEnd:errList[2]}},errorPlacement:function(e,t){e.insertAfter(t.parent())}}),$.validator.addMethod("checkTime",function(e,t,a){for(var i=moment(e,"DD-MM-YYYY HH:mm"),r=i.day(),n=i.hours(),d=i.minutes(),o=getHolidayList(i.year()),s=!1,l=0;l<o.length;l++)moment(i).isSame(o[l],"day")&&(s=!0);return 0==r||6==r||s?!(n<8||n>=22&&d>0||n>22):isProjAllowed($("#project_list").val(),projectAllowedOT18Key)?!(n<18||n>=22&&d>0||n>22):!(18==n&&d<30||n<18||n>=22&&d>0||n>22)}),$.validator.addMethod("compareTimeEnd",function(e,t,a){var i=(new Date(moment($(a).val(),"DD-MM-YYYY HH:mm")),$(a).val().split(" ")),r=e.split(" ");return i[0]==r[0]}),$.validator.addMethod("compareTimeStart",function(e,t,a){var i=(new Date(moment($(a).val(),"DD-MM-YYYY HH:mm")),$(a).val().split(" ")),r=e.split(" ");return!$(a).val()||i[0]==r[0]}),$.validator.addMethod("checkBreak",function(e,t,a){return!!$(t).prop("readonly")||e>=0&&e<=14}),$.validator.addMethod("checkBreakOT",function(e,t,a){if($(t).prop("readonly"))return!0;if(!$(a[0]).val()&&!$(a[1]).val())return!0;var i=moment($(a[0]).val(),"DD-MM-YYYY HH:mm"),r=moment($(a[1]).val(),"DD-MM-YYYY HH:mm"),n=moment.range(moment($(a[0]).val(),"DD-MM-YYYY"),moment($(a[1]).val(),"DD-MM-YYYY")),d=!1,o=!1;if(!moment(i).isSame(r,"day")||0!=i.day()&&6!=i.day()){for(var s=countCertainDays([0,6],i,r),l=getHolidayList(r.year()),m=0,c=0;c<l.length;c++)n.contains(l[c])&&m++,moment(i).isSame(l[c],"day")&&(o=!0),moment(r).isSame(l[c],"day")&&(d=!0);var u=moment($(a[1]).val(),"DD-MM-YYYY HH:mm").hours(22).minutes(0);if(s>0||m>0){if(0===i.day()||6===i.day()||o){var p=moment($(a[0]).val(),"DD-MM-YYYY HH:mm").hours(8).minutes(0);if(0===r.day()||6===r.day()||d)var _=14*(s+m)-u.diff(r,"minutes")/60-i.diff(p,"minutes")/60;else var _=14*(s+m)-i.diff(p,"minutes")/60}else{var p=moment($(a[0]).val(),"DD-MM-YYYY HH:mm").hours(18).minutes(30);if(0===r.day()||6===r.day()||d)var _=14*(s+m)-u.diff(r,"minutes")/60;else var _=14*(s+m)}return e<_}return!0}var _=r.diff(i,"minutes")/60;return e<_}),$.validator.addMethod("valueNotEquals",function(e,t,a){return a!==e})}function hasDecimalPlace(e,t){var a=e.indexOf(".");return a>=0&&a<e.length-t}function countCertainDays(e,t,a){var i=1+Math.round(a.diff(t,"days")),r=function(e,a){return e+Math.floor((i+(t.day()+6-a)%7)/7)};return e.reduce(r,0)}function getHolidayList(e){for(var t=[],a=0;a<annualHolidayList.length;a++)for(var i=(new Date).getFullYear();i<=e;i++)t.push(moment(i+"-"+annualHolidayList[a],"YYYY-MM-DD"));for(var a=0;a<specialHolidayList.length;a++)t.push(moment(specialHolidayList[a],"YYYY-MM-DD"));return t}function checkNoEmployee(){return $("#table_ot_employees tbody tr").length<=0}function importMember(e){var t=e.$("td > input:checked");t.each(function(){var t=e.row($(this).parent().parent()).data();if($("#table_ot_employees > tbody > tr#"+t.id).length>0)$("#projectbtn").parent().append('<div class="include-error errorTxt">'+t.name+errList[7]+"</div>"),setTimeout(function(){$(".include-error").remove()},3e3);else{var a="<tr id='"+t.id+"'>";a+="<td class='emp_code'>"+t.code+"</td>",a+="<td class='emp_name'>"+t.name+"</td>",a+="<td class='start_at'>"+$("#time_start").val()+"</td>",a+="<td class='end_at'>"+$("#time_end").val()+"</td>",a+="<td class='ot_paid'><center><input type='checkbox' checked/></center></td>",a+="<td class='relax'>0.00</td>",a+="<td class='btn-manage'><button type='button' class='btn btn-primary edit' onclick='editEmp("+t.id+")'><i class='fa fa-pencil-square-o'></i></button>",a+=" <button type='button' class='btn btn-delete delete' onclick='removeEmp("+t.id+")'><i class='fa fa-minus'></i></button></td>",a+="</tr>",$("#table_ot_employees > tbody").append(a)}}),$("#projsMemberModal").modal("hide"),$("#teamMemberModal").modal("hide"),checkNoEmployee()?$("#error_no_employee").show():$("#error_no_employee").hide()}function addOtEmployee(e){var t="";if(e){if($("#emp_list").siblings(".errorTxt").empty(),isValidForm($("#addEmpForm"))){if(0==$("tr#"+e).length){t+="<tr id='"+e+"'>",t+="<td class='emp_code'>"+$("#add_register_code").val()+"</td>",t+="<td class='emp_name'>"+$("#emp_list").find(":selected").text().trim()+"</td>",t+="<td class='start_at'>"+$("#add_time_start").val()+"</td>",t+="<td class='end_at'>"+$("#add_time_end").val()+"</td>",t+="<td class='ot_paid'><center><input type='checkbox' "+($("#is_paid").is(":checked")?"checked":"")+" readonly=''/></center></td>";var a=parseFloat($("#add_relax").val());t+="<td class='relax'>"+a.toFixed(2)+"</td>",t+="<td class='btn-manage'><button type='button' class='btn btn-primary edit' onclick='editEmp("+e+")'><i class='fa fa-pencil-square-o'></i></button>",t+=" <button type='button' class='btn btn-delete delete' onclick='removeEmp("+e+")'><i class='fa fa-minus'></i></button></td>",t+="</tr>",$("#table_ot_employees > tbody").append(t)}else{var i=0,r=0,n="",d=0;if($("#box_set_time_break_edit .time-break-value").each(function(){var e=parseFloat($(this).val());if(""!=$(this).val()&&null!==$(this).val()&&(e>14&&(r=1,$(this).parent().find(".max_time_break-error").show()),0==r&&(i+=parseFloat($(this).val()))),0==r){var t=$(this).closest(".set-time-break-item").find(".time-break-date").html();e=e.toFixed(2),n=n+"<div class='set-time-break-item row'><div class='col-md-4 ot-form-group'><label class='control-label time-break-date'>"+t+"</label></div><div class='col-md-8 ot-form-group'><input type='text' class='form-control time-break-value' value='"+e+"'></div></div>"}d++}),1===r)return;$("tr#"+e).find(".emp_code .emp_code_main").html($("#add_register_code").val()),$("tr#"+e).find(".emp_code .has-set-time-break-edit").html(n),$("tr#"+e).children(".emp_name").html($("#emp_list option:selected").text().trim()),$("tr#"+e).children(".start_at").html($("#add_time_start").val()),$("tr#"+e).children(".end_at").html($("#add_time_end").val());var a=parseFloat($("#add_relax").val());if($("tr#"+e).children(".relax").html(i.toFixed(2)),$("tr#"+e).children(".ot_paid").find("input").prop("checked",$("#is_paid").is(":checked")),e==$("#emp_id").val()){$("#time_end").val($("#add_time_end").val()),$("#time_end").prop("disabled",!1),$("#time_start").val($("#add_time_start").val()),$("#time_start-error").remove(),$("#time_end-error").remove(),$("#total_time_break").val(i.toFixed(2)),$("#has_set_time_break").html(n),$("#check_set_break_time").val(1),$("#relax").val($("#add_relax").val()),$("#relax").val(),$("#add_relax").is("[readonly]")?$("#relax").prop("readonly",!0):$("#relax").prop("readonly",!1);var o=moment($("#datetimepicker_start").find("input:first").val(),"DD-MM-YYYY"),s=moment($("#datetimepicker_end").find("input:first").val(),"DD-MM-YYYY");null!=o&&null!=s&&(o=new Date(o),s=new Date(s),o.setHours(0,0),s.setHours(0,0),hasHolidayOrWeekend(o,s,annualHolidayList,specialHolidayList)?$("#form_set_time_break").show():$("#form_set_time_break").hide()),$("#box_set_time_break_edit .set-time-break-item").each(function(){var e=$(".time-break-date-val").data("date"),t=$(".time-break-value").val();timeBreakOrigin[e]=t})}}$("#addEmp").modal("hide"),$("#modal_set_time_break #box_set_time_break .time-break-date-val").text()}}else $("#emp_list").siblings(".errorTxt").html(errList[0])}function editEmp(e){$("#exist_time_lot_before_submit_error").html(""),$("#addEmp").validate().resetForm(),$("#addEmp").find(".errorTxt").empty();var t=$("#table_ot_employees > tbody").children("tr#"+e);$("#add_register_code").attr("data-id",t.prop("id")),$("#datetimepicker_add_start").data("DateTimePicker").clear(),$("#datetimepicker_add_end").data("DateTimePicker").clear(),$("#addEmp").modal("show"),$("#addEmp").find("h4.modal-title").html(titleList[1]),$("#add_register_code").prop("value",t.find(".emp_code .emp_code_main").html()),$("#add_time_start").val(t.children(".start_at").html()),$("#box_set_time_break_edit").html(t.find(".emp_code .has-set-time-break-edit").html()),$("#box_set_time_break_edit .set-time-break-item").each(function(){var t=$(this).find(".time-break-value").data("date");breakTimesEmployees[e]&&breakTimesEmployees[e][t]&&$(this).find(".time-break-value").val(breakTimesEmployees[e][t])}),$("#group_set_time_edit").css("display","block"),t.children(".end_at").html()?($("#datetimepicker_add_end").data("DateTimePicker").enable(),$("#add_time_end").val(t.children(".end_at").html())):$("#datetimepicker_add_end").data("DateTimePicker").disable(),$("#add_relax").val(t.children(".relax").html()),isBreakTimeWeekend(!1),t.find("input").is(":checked")?$("#is_paid").prop("checked",!0):$("#is_paid").prop("checked",!1),$("#emp_list").find("option[value="+e+"]").length>0?$("#emp_list").val(e).trigger("change"):($("#emp_list").append($("<option>",{value:e,text:t.children(".emp_name").html()})),$("#emp_list").val(e).trigger("change")),$(".time-break-value").limitBreakInputLength()}function removeEmp(e){$("#exist_time_lot_before_submit_error").html(""),$("#table_ot_employees > tbody").children("tr#"+e).remove(),$("#table_ot_employees > tbody tr").map(function(e,t){$("#table_ot_employees > tbody tr").length<=1&&($("#table_ot_employees > thead > tr").children(":first-child").remove(),$("#table_ot_employees > tbody > tr").children(":first-child").remove()),$(t).find(".stt").text($(t).index()+1)}),checkTimeNotFilled()?$("#error_time_not_filled").show():$("#error_time_not_filled").hide(),checkNoEmployee()?$("#error_no_employee").show():$("#error_no_employee").hide()}function checkTimeNotFilled(){var e=!1;return $("#table_ot_employees > tbody").find("td.start_at, td.end_at").each(function(t,a){$(this).text()||(e=!0)}),e}function convertDate(e){var t=e.split(" "),e=t[0],a=t[1],i=e.split("-");return i[2]+"-"+i[1]+"-"+i[0]+" "+a}function preSaveProcessing(){var e=[],t=[];$("#table_ot_employees > tbody").find("tr").length>0&&$("#table_ot_employees > tbody").find("tr").each(function(){var a=$(this).find("td"),i=$(this).attr("id");e.push({empId:$(this).attr("id"),empCode:a.closest(".emp_code").children(".emp_code_main").text().trim(),empName:a.closest(".emp_name").text(),startAt:a.closest(".start_at").text(),endAt:a.closest(".end_at").text(),isPaid:a.find("input").is(":checked"),"break":a.closest(".relax").text()}),$(this).find("td.emp_code .has-set-time-break-edit .time-break-value").each(function(){t.push({empId:i,time_break:$(this).val(),date:$(this).closest(".set-time-break-item").find(".time-break-date .time-break-date-val").text()})})}),$("#has_set_time_break .time-break-value").each(function(){t.push({empId:$("#emp_id").val(),time_break:$(this).val(),date:$(this).closest(".set-time-break-item").find(".time-break-date .time-break-date-val").text()})});var a=JSON.stringify(e);$("#table_data_emps").val(a),$("#time_breaks").val(JSON.stringify(t)),$("#form-register").submit()}function validateTagEmployees(){var e=!0;return $("#table_ot_employees > tbody").find("td.start_at, td.end_at").each(function(t,a){if(!$(this).text())return $("#error_time_not_filled").show(),e=!1,!1}),$("#table_ot_employees tbody tr").length<=0?($("#error_no_employee").show(),e=!1,!1):e}function initDataTable(e){return $(e).DataTable({columns:[{data:"checkbox"},{data:"id"},{data:"code"},{data:"name"},{data:"email"}],columnDefs:[{targets:0,searchable:!1,orderable:!1,className:"dt-body-center",render:function(){return'<input class="checkbox_select" type="checkbox">'}},{targets:1,visible:!1,searchable:!1}],order:[[1,"asc"]],bAutoWidth:!1,language:{emptyTable:viewList[0]}})}function isValidForm(e){var t=e.valid(),a=!1;return e.find(".errorTxt").each(function(){if($(this).text().trim())return a=!0,!1}),t&&!a}function initOtEmployeeTable(){if(0==$("#table_ot_employees").find("tr#"+$("#register_id").data("id")).length){var e=$("#register_id").data("id"),t="<tr id='"+e+"'>",a="<div class='has-set-time-break-edit' style='display: none;'>"+$("#has_set_time_break").html()+"</div>";t+="<td class='emp_code'><div class='emp_code_main'>"+$("#register_code").val()+"</div>"+a+"</td>",t+="<td class='emp_name'>"+$("#register_id").val()+"</td>",t+="<td class='start_at'>"+$("#time_start").val()+"</td>",t+="<td class='end_at'>"+$("#time_end").val()+"</td>",t+="<td class='ot_paid'><center><input type='checkbox' checked readonly=''></center></td>";var i=parseFloat($("#total_time_break").val());t+="<td class='relax'>"+i.toFixed(2)+"</td>",t+="<td class='btn-manage'><button type='button' class='btn btn-primary edit' onclick='editEmp("+$("#emp_id").val()+")'><i class='fa fa-pencil-square-o'></i></button>",t+=" <button type='button' class='btn btn-delete delete' onclick='removeEmp("+e+")'><i class='fa fa-minus'></i></button></td>",t+="</tr>",$("#table_ot_employees").children("tbody").prepend(t);var r=moment($("#time_start").val(),"DD-MM-YYYY"),r=r.format("DD-MM-YYYY").toString();breakTimesEmployees[e]={},breakTimesEmployees[e][r]=i}}function isBreakTimeWeekend(e){if(e)var t=$("#datetimepicker_start"),a=$("#datetimepicker_end"),i="#relax";else var t=$("#datetimepicker_add_start"),a=$("#datetimepicker_add_end"),i="#add_relax";if(t.children("input").val()&&a.children("input").val()){var r=0,n=moment(t.children("input").val(),"DD-MM-YYYY HH:mm"),d=moment(a.children("input").val(),"DD-MM-YYYY HH:mm"),o=getHolidayList(d.year());if(moment(n).isSame(d,"day"))for(var s=moment($(t).find("input:first").val(),"DD-MM-YYYY"),l=0;l<o.length;l++)moment(s).isSame(o[l],"day")&&r++;else for(var m=moment.range(n,d),l=0;l<o.length;l++)m.contains(o[l])&&r++;var c=countCertainDays([0,6],n,d);c>0||r>0?$(i).prop("readonly",!1):$(i).prop("readonly",!0)}}function clearModalCheckBox(){$(".btn-add").click(function(){$("#teamMemberModal, #projsMemberModal").find("input:checkbox").prop("checked",!1)})}function initForm(e){"edit"==e&&(isEditable&&""!=isEditable&&$("#time_end").prop("disabled",!1),$("#project_list").trigger("change")),$(".team-search").select2();var t=$("#time_start").val(),a=$("#time_end").val();$("#datetimepicker_start, #datetimepicker_end, #datetimepicker_add_start, #datetimepicker_add_end").initOTTimeCalendar(),$("#time_start").val(t),$("#time_end").val(a),$("#leader_input").changeLeaderByProject("#project_list"),$(".team-search").changeTagEmployeesByTeam(),$("#leader_input").changeApprover(),$("#relax").limitBreakInputLength(),$("#add_relax").limitBreakInputLength(),validateForm(),validateTime(),initAddOtEmployee(),"create"===e&&initOtEmployeeTable(),isBreakTimeWeekend(!0),$("button#submitBtn").click(function(){var e=checkExistTimeSlotBeforeSubmit();isValidForm($("#form-register"))&&validateTagEmployees()&&(e||preSaveProcessing())}),$.fn.modal.Constructor.prototype.enforceFocus=function(){},$(".ot-read-more").shorten({showChars:200,moreText:"See more",lessText:"Less"}),$('b[role="presentation"]').hide(),$("#relax").changeBreakTime(),clearModalCheckBox(),$(".btn-approve").setApproveIds(),$(".btn-reject").setRejectIds()}function formatReponse(e){return e.loading?e.text:markup=e.avatar_url?"<div class='select2-result-repository clearfix'><div class='select2-result-repository__title'><img style=\"margin-right:8px;max-width: 32px;max-height: 32px;border-radius: 50%;\" src=\""+e.avatar_url+'">'+e.text+"</div></div>":"<div class='select2-result-repository clearfix'><div class='select2-result-repository__title'><i style='margin-right:8px' class='fa fa-user-circle fa-2x' aria-hidden='true'></i>"+e.text+"</div></div>"}function formatReponseSelection(e,t){if("object"==typeof e.dataMore){var a=t.closest(".select2.select2-container").siblings("select").first();$.each(e.dataMore,function(e,t){a.data("select2-more-"+e,t)})}return e.text}function hasHolidayOrWeekend(e,t,a,i){if(null===e||null===t)return!1;e.setHours(0,0),t.setHours(0,0);for(var r=e;r<=t;r.setDate(r.getDate()+1))if(isHolidayOrWeekend(r,a,i))return!0;return!1}function isHolidayOrWeekend(e,t,a){if(null===e)return!1;var i=new Date(e);i.setHours(0,0);var r=(i.getDay(),i.getFullYear()),n=i.getTime();if(isWeekend(e))return!0;if("object"==typeof t)for(var d=t.length,o=0;o<d;o++)if(dateAnnual=new Date(r+"-"+t[o]),dateAnnual.setHours(0,0),getDateTimeAnnual=dateAnnual.getTime(),getDateTimeAnnual===n)return!0;if("object"==typeof a)for(var s=a.length,o=0;o<s;o++)if(dateSpecial=new Date(a[o]),dateSpecial.setHours(0,0),getDateTimeSpecial=dateSpecial.getTime(),getDateTimeSpecial===n)return!0;return!1}function getDayOfWeek(e){switch(e){case 0:return"Chủ nhật";case 1:return"Thứ hai";case 2:return"Thứ ba";case 3:return"Thứ tư";case 4:return"Thứ năm";case 5:return"Thứ sáu";default:return"Thứ bảy"}}function isProjAllowed(e,t){return jQuery.inArray(e,t)!==-1}function setTimeBreak(e){$("#box_set_time_break").html("");var t=moment($("#datetimepicker_start").find("input:first").val(),"DD-MM-YYYY"),a=moment($("#datetimepicker_end").find("input:first").val(),"DD-MM-YYYY");if(null!=t&&null!=a){t=new Date(t),a=new Date(a),t.setHours(0,0),a.setHours(0,0);for(var i=t;i<=a;i.setDate(i.getDate()+1)){var r=isHolidayOrWeekend(i,annualHolidayList,specialHolidayList);if(r){var n=i.getMonth()+1;n=n.toString(),1===n.length&&(n="0"+n);var d=i.getDate();d=d.toString(),1===d.length&&(d="0"+d);var o=getDayOfWeek(i.getDay()),s=d+"/"+n+"/"+i.getFullYear();$("#duplicate_set_time_break_item .time-break-date .time-break-date-val").attr("data-date",s).text(s),$("#duplicate_set_time_break_item .time-break-date .time-break-date-day").text(" ("+o+")"),$("#duplicate_set_time_break_item .time-break-value").attr("data-date",s);var l=$("#duplicate_set_time_break_item").html();$("#box_set_time_break").append(l);var m=breakTimesEmployees[e][s];m&&$('#box_set_time_break .time-break-value[data-date="'+s+'"]').val(m)}}}$(".time-break-value").limitBreakInputLength()}function saveSetTimeBreak(){var e=0,t="",a=0,i=$("#register_id").data("id");$("#box_set_time_break .time-break-value").each(function(){var r=parseFloat($(this).val());if(""!=$(this).val()&&null!==$(this).val()&&(r>14&&(a=1,$(this).parent().find(".max_time_break-error").show()),0==a&&(e+=parseFloat($(this).val()))),0==a){var n=$(this).closest(".set-time-break-item").find(".time-break-date").html();r=r.toFixed(2);var d=$(this).closest(".set-time-break-item").find(".time-break-date-val").text();t=t+"<div class='set-time-break-item row'><div class='col-md-4 ot-form-group'><label class='control-label time-break-date' >"+n+"</label></div><div class='col-md-8 ot-form-group'><input type='text' class='form-control time-break-value' data-date='"+d+"' value='"+r+"'></div></div>",timeBreakOrigin[d]=r,breakTimesEmployees[i][d]=r}}),1!=a&&($("#check_set_break_time").val(1),$("#total_time_break").val(e.toFixed(2)),$("#has_set_time_break").html(t),$("#table_ot_employees").find("tr#"+i).children("td.relax").text(e.toFixed(2)),$("#table_ot_employees").find("tr#"+i).find("td.emp_code .has-set-time-break-edit").html($("#has_set_time_break").html()),$("#modal_set_time_break").modal("hide"))}function getStartTimeOT(e,t){var a=timeSetting[e][t],i=new Date(t);return isHolidayOrWeekend(i,annualHolidayList,specialHolidayList)?(i.setHours(a.morningInSetting.hour,a.morningInSetting.minute),i):isProjAllowed($projectSelect.val(),projectAllowedOT18Key)?(i.setHours(a.afternoonOutSetting.hour,a.afternoonOutSetting.minute),i):(i.setHours(a.afternoonOutSetting.hour+1,a.afternoonOutSetting.minute),i)}function isHoliday(e){for(var t=getHolidayList(e.getFullYear()),a=0;a<t.length;a++)if(moment(e).isSame(t[a],"day"))return!0;return!1}function convertTime(e,t){return("0"+e).slice(-2)+":"+("0"+t).slice(-2)}function updateTimeSettingData(e,t,a){if(t>a){var i=t;t=a,a=i}var r,n=generateDatesInPeriod(t,a),d=!0;for(r=0;r<n.length;r++)if(!timeSetting[e][n[r]]){d=!1,t=n[r];break}if(!d){for(r=n.length-1;r>=0;r--)if(!timeSetting[e][n[r]]){a=n[r];break}$.ajax({type:"post",dataType:"json",url:urlGetTimeSetting,async:!1,data:{period:{start_date:t,end_date:a},empId:e,_token:token},success:function(t){var a=t.timeWorking[e];Object.keys(a).forEach(function(t){timeSetting[e][t]=a[t]})}})}}$(window).load(function(){$(".se-pre-con").fadeOut("slow")});var $timeStart=$("#time_start"),$timeEnd=$("#time_end"),$tableEmployeeOT=$("#table_ot_employees"),$projectSelect=$("#project_list"),$startContainers={mainForm:$("#datetimepicker_start"),popupForm:$("#datetimepicker_add_start")},$endContainers={mainForm:$("#datetimepicker_end"),popupForm:$("#datetimepicker_add_end")},dataInitCalendar={allowInputToggle:!0,format:"DD-MM-YYYY HH:mm",sideBySide:!0,maxDate:moment().add(10,"y"),minDate:moment().subtract(10,"y")};isEmpJp||(dataInitCalendar.disabledHours=[23]),$.fn.initOTTimeCalendar=function(){$(this).datetimepicker(dataInitCalendar)},$(document).on("blur","#addEmp .time-break-value",function(){var e=$(this).data("date"),t=$("#add_register_code").data("id");breakTimesEmployees[t][e]=this.value}),$.validator.addMethod("enddateMax",function(e,t){if(!e)return!0;var a=e.replace(/.*\s/,""),i=a.replace(/:.*/,""),r=a.replace(/.*:/,"");
return!(i&&r&&!isNaN(i)&&!isNaN(r))||!(!isEmpJp&&("0"+i).slice(-2)+":"+("0"+r).slice(-2)>"22:00")},"Must not be greater 22:00."),$.fn.changeLeaderByProject=function(e){$(e).on("change",function(){var e=$(this).find(":selected").val();""===e?$("#projectbtn").prop("disabled",!0):($("#project_list-error").hide(),$("#leader_input").prop("disabled",!1),$("#projectbtn").prop("disabled",!1))})},$.fn.changeApprover=function(){$(this).on("change",function(){$("#leader_input-error").hide(),$("#leader_id").val($(this).val())})},$.fn.changeTagEmployeesByTeam=function(){$(this).on("change",function(){var e=$(this).find(":selected").val();$.ajax({url:urlTeamEmployees,type:"GET",data:{idTeam:e},success:function(e){tableTeamEmp.clear().draw(),$.each(e,function(e,t){tableTeamEmp.row.add({checkbox:"",id:e,code:t.code,name:t.name,email:t.email}).draw()}),$("#teamMemberModal .checkbox_all").click(function(){$("#teamMemberModal .checkbox_select").not(this).prop("checked",this.checked)}),$("#teamMemberModal .checkbox_select").click(function(){$("#teamMemberModal .checkbox_select").filter(":checked").length===$("#teamMemberModal .checkbox_select").length?$("#teamMemberModal .checkbox_all").prop("checked",!0):$("#teamMemberModal .checkbox_all").prop("checked",!1)})}})})},$.fn.limitBreakInputLength=function(){$(this).number(!0,2),$(this).keyup(function(e){$.inArray(e.keyCode,[46,8,9,27,13,110,190])!==-1||65===e.keyCode&&(e.ctrlKey===!0||e.metaKey===!0)||e.keyCode>=35&&e.keyCode<=40||(e.shiftKey||e.keyCode<48||e.keyCode>57)&&(e.keyCode<96||e.keyCode>105)&&e.preventDefault()})},$.fn.changeBreakTime=function(){$(this).bind("keyup mouseup",function(){var e=$(this).val();hasDecimalPlace(e,3)&&(e=e.match(/^\d+\.\d{1,2}/)[0]),e=parseFloat(e),$("#table_ot_employees").find("tr#"+$("#register_id").data("id")).children("td.relax").text(e.toFixed(2))})},$.fn.selectSearchEmployee=function(){$(this).select2({id:function(e){return e.id},ajax:{url:$(this).data("remote-url"),dataType:"JSON",delay:250,data:function(e){return{q:e.term,page:e.page}},processResults:function(e,t){return t.page=t.page||1,{results:e.items,pagination:{more:5*t.page<e.total_count}}},cache:!0},escapeMarkup:function(e){return e},minimumInputLength:2,templateResult:formatReponse,templateSelection:formatReponseSelection})},$.fn.selectSearchEmployeeCanapprove=function(){$(this).select2({id:function(e){return e.id},ajax:{url:$(this).data("remote-url"),dataType:"JSON",delay:250,data:function(e){return{q:e.term}},processResults:function(e){return{results:e.items}},cache:!0},escapeMarkup:function(e){return e},minimumInputLength:2,templateResult:formatReponse,templateSelection:formatReponseSelection})},$("#btn_add_employee_ot").on("click",function(){var e=$(this),t=$("#search_employee_ot").select2("data");if(!t.length||e.data("process"))return!0;e.data("process",1);var a=e.data("url"),i=moment(convertDate($timeStart.val())).toDate(),r=i.format("Y-m-d"),n=moment(convertDate($timeEnd.val())).toDate(),d=n.format("Y-m-d"),o=[];jQuery.each(t,function(e,t){o.push(t.id)}),$.ajax({type:"POST",url:a,dataType:"json",data:{empIds:o,_token:token,startDate:r,endDate:d},success:function(e){o.forEach(function(t){timeSetting[t]=timeSetting[t]||{};var a=e[0][t];Object.keys(a).forEach(function(e){timeSetting[t][e]=a[e]})}),$tableEmployeeOT.find("tbody > tr").length<=1&&$tableEmployeeOT.find("thead > tr").children().length<8&&($tableEmployeeOT.find("thead > tr").prepend("<th class='col-width-40'>"+viewStt+" </th>"),$tableEmployeeOT.find("tbody > tr").prepend("<td class='stt text-center'> 1 </td>"));var a=$tableEmployeeOT.find("tbody > tr").length;jQuery.each(t,function(e,t){var o=getStartTimeOT(t.id,r),s=o>=i?o:i,l=new Date(d);l.setHours(22,0);var m=l<=n?l:n;if(!$tableEmployeeOT.find("tbody > tr#"+t.id).length){var c="<tr id='"+t.id+"'>",u="<div class='has-set-time-break-edit' style='display: none;'>"+$("#has_set_time_break").html()+"</div>";c+="<td class='stt text-center'>"+ ++a+"</td>",c+="<td class='emp_code'><div class='emp_code_main'>"+t.employee_code+"</div>"+u+"</td>",c+="<td class='emp_name'>"+t.employee_name+"</td>",c+="<td class='start_at'>"+s.format("d-m-Y H:i")+"</td>",c+="<td class='end_at'>"+m.format("d-m-Y H:i")+"</td>",c+="<td class='ot_paid text-center'><input type='checkbox' checked/></td>",c+="<td class='relax'>"+$("#total_time_break").val()+"</td>",c+="<td class='btn-manage'><button type='button' class='btn btn-primary edit' onclick='editEmp("+t.id+")'><i class='fa fa-pencil-square-o'></i></button>",c+="<button type='button' class='btn btn-delete delete' onclick='removeEmp("+t.id+")'><i class='fa fa-minus'></i></button></td>",c+="</tr>",$tableEmployeeOT.find("tbody").append(c)}}),$("#search_employee_ot").html("").trigger("change")},complete:function(){e.data("process",0)}})});