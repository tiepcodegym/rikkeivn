!function(e,t,a){rkTagApp=e.module("RkTagApp",["ngValidate","ui.select2","angularModalService"]).config(["$interpolateProvider",function(e){e.startSymbol("<%="),e.endSymbol("%>")}]),rkTagApp.run(["$rootScope","$location","$sce","$http","$timeout",function(r,n,i,l,s){r.trans=RKTagTrans,r.globTag=RKVarGlobalTag,r.generalTag=a.general,r.pager={current_page:1,next_page:null,last_page:1,total:0},r.dataLoaded=!1,r.dataSearched=!0,r.dataReseted=!0,r.errorMess=null,r.dataFilterDefault={search:{},order:"created_at",dir:"desc",tag:[],field:{},page:r.pager.next_page||1},r.dataFilter=e.copy(r.dataFilterDefault),r.initFilter=function(a){if("undefined"==typeof a&&(a=!1),r.dataFilter=e.copy(r.dataFilterDefault),a)r.saveFilter();else{var n=r.getFilter();n&&Object.keys(n).length&&(r.dataFilter=t.extend(r.dataFilter,n))}},r.saveFilter=function(){n.search({});var t="";e.forEach(r.dataFilter,function(r,i){return"field"===i?(t=a.general.encodeSlugField(r),t&&n.search(i,t),!0):"tag"===i?(r.length&&n.search(i,a.general.encodeSlugTag(r)),!0):void(e.isObject(r)?Object.keys(r).length&&n.search(i,JSON.stringify(r)):r&&n.search(i,r))})},r.getFilter=function(){var t=n.search(),i={};return e.forEach(t,function(e,t){if("field"===t){var n=a.general.decodeSlugField(e);return i[t]=n.field,r.filterTagSelected=n.tag,!0}if("tag"===t)return i[t]=a.general.decodeSlugTag(e),!0;try{i[t]=JSON.parse(e)}catch(l){i[t]=e}}),i},r.classSorting=function(e){return r.dataFilter.order==e?"asc"==r.dataFilter.dir?"sorting_asc":"sorting_desc":""},r.limitPages=[],"undefined"!=typeof RKVarGlobalTag.limitPages&&(r.limitPages=JSON.parse(RKVarGlobalTag.limitPages)),r.convertAccount=function(t){if(!e.isDefined(t)||!t)return null;var a=t.split("@");return a.length<2?t:a[0]},r.toArrayFromStr=function(e,t){if(!e)return[];"undefined"==typeof t&&(t=",");var a=e.split(t);return a},r.generateTagHtml=function(t,a){var r="";return t&&(r='<ul class="tagit tag-field-list">',e.forEach(t,function(e,t){return"undefined"==typeof e||t<RKVarGlobalTag.SHOW_NUM_TAGS&&void(r+='<li class="tagit-choice tagit-choice-read-only" style="background-color: '+e.color+';"><span class="tagit-label">'+e.value+"</span></li>")}),r+="</ul>"),e.isDefined(a)?void e.element('tr[data-id="'+a+'"] .td-tags').html(r):i.trustAsHtml(r)},r.trimObjNames=function(t,a,r){if(!t)return"";if(e.isDefined(a)||(a=25),e.isDefined(r)||(r=", "),t.length<=a)return t;var n=t.split(r),i=[];for(var l in n){if(!(i.length+n[l].length+2<a))break;i+=(0===i.length?"":r)+n[l]}return 0===i.length?t.substr(0,a-5)+"...":i+r+"..."},r.splitIdNameHtml=function(t,a,r){if(!t)return"";e.isDefined(r)||(r=25);var n="",i="",l=!1;return e.forEach(t.split("|"),function(e){var t=e.split(":");return 2!==t.length||(n.length+t[1].length>r?l=!0:i+='<span data-team-id="'+t[0]+'">'+t[1]+'</span><span data-separator="1">, </span>',void(n+=t[1]+", "))}),n=n.slice(0,-2),i=i.slice(0,-34),i||(i=n.substr(0,r-5)),l&&(i+="..."),{text:n,html:i}};var o=sessionStorage,c="storage_list_tags";r.KEY_STORAGE_FIELD="storage_list_fields",r.exportStorageTags=function(t){e.isDefined(r.globTag.urlExportTags)&&s(function(){var e=r.getStorageItem("storage_tag_ver");l.get(r.globTag.urlExportTags,{params:{version:e?e:0}}).then(function(e){e.data.tags&&(r.importStorageTags(e.data.tags,t),r.setStorageItem("storage_tag_ver",e.data.version),r.setStorageItem(r.KEY_STORAGE_FIELD,e.data.fields)),r.localTagsOfField=r.getStorageTags(),"undefined"!=typeof t&&"function"==typeof t.then&&t.then()})},500)},r.exportStorageTags(),r.importStorageTags=function(t){if(e.isDefined(o)){var a={};for(var r in t){var n=t[r];e.isDefined(a[n.field_id])?a[n.field_id].push({id:n.id,value:n.value.trim()}):a[n.field_id]=[{id:n.id,value:n.value.trim()}]}try{o.setItem(c,JSON.stringify(a))}catch(i){return!1}}},r.getStorageTags=function(){if(!e.isDefined(o))return null;var t=o.getItem(c);return t?JSON.parse(t):null},r.getStorageItem=function(t){return e.isDefined(o)?o.getItem(t):null},r.setStorageItem=function(t,a){if(e.isDefined(o)){e.isObject(a)&&(a=JSON.stringify(a));try{o.setItem(t,a)}catch(r){return}}}}]),rkTagApp.directive("ngBindHtmlCompile",["$compile",function(e){return{restrict:"AE",link:function(t,a,r){t.$watch(function(){return t.$eval(r.ngBindHtmlCompile)},function(n){a.html(n&&n.toString());var i=t;r.bindHtmlScope&&(i=t.$eval(r.bindHtmlScope)),e(a.contents())(i)})}}}]),rkTagApp.directive("ngPaginate",["$rootScope",function(e){return{restrict:"A",templateUrl:a.general.getTemplate("pager.html")}}]),rkTagApp.directive("select2Local",function(){return{restrict:"A",scope:{localData:"=localData"},link:function(a,r,n){var i={};if(n.select2Local&&(i=JSON.parse(n.select2Local)),"undefined"==typeof i.minimumInputLength&&(i.minimumInputLength=2),"undefined"!=typeof n.select2Local&&n.select2Local){var l=e.element(r);return a.$watch("localData",function(a){if(a){l.show(),i.data=t.map(a,function(e){return{id:e.id,text:e.value}});var r=[];e.isDefined(n.excerpt)&&n.excerpt&&(r=n.excerpt),i.matcher=function(t,a){return!!(e.isDefined(t.term)&&a.text.substr(0,t.term.length).toLowerCase()==t.term.toLowerCase()&&r.indexOf(a.id)<0)&&a},l.select2(i)}else l.hide()}),!0}}}}),rkTagApp.directive("ngSelect2",["$parse",function(a){return{restrict:"A",priority:1,link:function(r,n,i){if("undefined"==typeof t().select2)return!0;var l=e.element(n);if("undefined"==typeof i.select2EnforceFocus||"0"!==i.select2EnforceFocus)try{t.fn.modal.Constructor.prototype.enforceFocus=function(){}}catch(s){}var o={};if(i.ngSelect2&&(o=JSON.parse(i.ngSelect2)),"undefined"==typeof i.select2RemoteUrl||!i.select2RemoteUrl)return"undefined"!=typeof i.select2Search&&"0"==i.select2Search&&(o.minimumResultsForSearch=1/0),l.select2(o),!0;var c=function(e){return e.loading?e.text:"<div class='select2-result-repository clearfix'><div class='select2-result-repository__title'>"+e.text+"</div></div>"},u=function(e){return e.text};setTimeout(function(){var t={id:function(e){return e.id},ajax:{url:i.select2RemoteUrl,dataType:"json",delay:250,data:function(e){return{q:e.term,page:e.page}},processResults:function(e,t){return t.page=t.page||1,{results:e.items,pagination:{more:20*t.page<e.total_count}}},cache:!0},escapeMarkup:function(e){return e},minimumInputLength:2,templateResult:c,templateSelection:u};t=e.extend(t,o),l.select2(t)}),"undefined"!==i.select2Model&&i.select2Model&&l.on("select2:select",function(e){var t=e.params.data.id,n=e.params.data.text,l=a(i.select2Model),s=l.assign;s(r,t),"undefined"!==i.select2Text&&i.select2Text&&(l=a(i.select2Text),s=l.assign,s(r,n)),"undefined"!==i.select2Changed&&i.select2Changed&&"undefined"!=typeof r[i.select2Changed]&&r[i.select2Changed](e,t)})}}}]),rkTagApp.directive("listTags",["$rootScope",function(t){function a(t,a){if(t.length>0){var r='<ul class="tagit tag-field-list">';for(var n in t){if(!(n<RKVarGlobalTag.SHOW_NUM_TAGS))break;var i=t[n].split("|"),l="";e.isDefined(i[1])&&a.hasClass("tags-format-color")&&(l='style="background-color: '+i[1]+'"'),r+='<li class="tagit-choice tagit-choice-read-only" '+l+'><span class="tagit-label">'+i[0]+"</span></li>"}t.length>RKVarGlobalTag.SHOW_NUM_TAGS&&(r+='<li><span class="tagit-label">.....</span></li>'),r+="</ul>",a.html(r)}else a.html("")}return{restrict:"A",link:function(e,r,n){n.$observe("listTags",function(){var e=t.toArrayFromStr(n.listTags,"-");a(e,r)})}}}]),rkTagApp.filter("trustHtml",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}])}(angular,jQuery,RKTagFunction);