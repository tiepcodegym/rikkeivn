!function(e,t,a,i){rkTagApp.controller("fieldManageController",["$scope","$sce","$element","$http","$templateRequest","$compile",function(d,n,l,r,o,f){var g;d.fieldPath={},d.trans=RKTagTrans,d.varGlobalTag=a,d.ajaxLoadindRequest=!1,d.token=siteConfigGlobal.token,d.fieldStatus=[];for(g in d.varGlobalTag.fieldStatus)d.fieldStatus.push({id:parseInt(g),label:d.varGlobalTag.fieldStatus[g]});d.fieldTypes=[],d.fieldTypes.push({id:null,label:i.general.htmlDecode("&nbsp")});for(g in d.varGlobalTag.fieldTypes)d.fieldTypes.push({id:parseInt(g),label:d.varGlobalTag.fieldTypes[g]});d.fieldActiveId=d.rootFieldTree,d.fieldTypeTag=d.varGlobalTag.fieldTypeTag,d.formFieldData={},d.fieldItem={},d.tags={},d.fieldTagReviewCount={};var s=n.getTrustedResourceUrl(i.general.getTemplate("field-manage-tree.html"));o(s).then(function(e){d.funcGetHtmlFieldManage=n.trustAsHtml(e)}),d.funcSetRootTree=function(t){d.rootFieldTree=parseInt(t),d.fieldPath[t]={},e.copy(d.varGlobalTag.fieldPath,d.fieldPath[t]);var a=i.getHtmlFieldTree.init(d.rootFieldTree,d.fieldPath[d.rootFieldTree],1,0,{type:d.varGlobalTag.fieldTypeInfo,level:2,attrMore:'ng-click="fieldItemClick($event);"'});d.htmlFieldTree=n.trustAsHtml(a),d.formFielditemDefault={status:1,type:d.fieldTypeTag,parent_id:d.rootFieldTree,set:d.rootFieldTree,name:""},d.formFieldData={},d.formFieldData.item=e.copy(d.formFielditemDefault),setTimeout(function(){d.funcFieldCountTag(t),e.element(".tag-field-content .tree-list li:eq(1)").trigger("click")},200)},d.fieldItemClick=function(l){if(l.preventDefault(),d.ajaxLoadindRequest)return!0;var g=e.element(l.currentTarget),s=g.data("id");return!!g.hasClass("active")||(g.closest(".tab-tag-wrapper").find(".actions-group").find('.btn-action[data-action="edit"]').data("field-id",s),d.disableSubmitBtn=!1,d.fieldActiveId=s,d.funcSetBtnAjaxLoading(!0,s),void r({method:"get",url:a.urlFieldGetTagItem,headers:{"Content-Type":"application/x-www-form-urlencoded"},params:{id:s}}).then(function(e){if(!e.data.success)return t.notify({message:e.data.message},{type:"warning"}),d.funcSetBtnAjaxLoading(!1,s),!0;var a=n.getTrustedResourceUrl(i.general.getTemplate("field-tag.html"));d.updatefieldPath(e.data.fieldsPath),d.tags=i.general.fieldTagTypes(e.data.tag),d.fieldItem=e.data.field,d.fieldTagsName=d.fieldPath[d.rootFieldTree][s].data.name,d.funcFieldTagAvai(e.data.field.type,s),o(a).then(function(a){f(t(".field-tag-wrapper").html(a).contents())(d),d.fieldTags?(d.funcCallTagIT({color:e.data.field.color}),d.fieldWrapperUi=1):d.fieldItem.type==d.varGlobalTag.fieldTypeInfo&&d.fieldPath[d.rootFieldTree][s].parent.length>=2?d.fieldWrapperUi=2:d.fieldWrapperUi=0},function(){i.general.notifyError()}),d.funcSetBtnAjaxLoading(!1,s)},function(e){i.general.notifyError(),d.funcSetBtnAjaxLoading(!1,s)}))},d.fieldEditorClick=function(l){if(d.ajaxLoadindRequest)return!0;var g=e.element(l.currentTarget),s=g.data("field-id"),c=g.find(".submit-ajax-refresh");c.removeClass("hidden"),d.funcSetBtnAjaxLoading(!0,s),r({method:"get",url:a.urlFieldGetItem,headers:{"Content-Type":"application/x-www-form-urlencoded"},params:{id:s}}).then(function(a){if(!a.data.success)return t.notify({message:a.data.message},{type:"warning"}),c.addClass("hidden"),d.funcSetBtnAjaxLoading(!1,s),!0;a.data.field?(d.formFieldData.item=i.general.jsonToInt(a.data.field),d.modalFieldEditTitle=a.data.field.name):(e.copy(d.formFielditemDefault,d.formFieldData.item),d.fieldActiveId&&(d.formFieldData.item.parent_id=d.fieldActiveId),d.modalFieldEditTitle=d.trans["Create new field"]),d.funcFieldTagInfo(d.formFieldData.item.type),d.updatefieldPath(a.data.fieldsPath);var l=n.getTrustedResourceUrl(i.general.getTemplate("field-edit.html"));o(l).then(function(e){d.fieldOptions=i.getHtmlFieldTree.init(d.rootFieldTree,d.fieldPath[d.rootFieldTree],2,s,{type:d.varGlobalTag.fieldTypeInfo}),f(t(".field-manage-modal-wrapper").html(e).contents())(d),t("#modal-field-edit").modal("show"),t("#modal-field-edit").on("shown.bs.modal",function(){t('#modal-field-edit input[name="item[color]"]').colorpicker({})})},function(){i.general.notifyError()}),c.addClass("hidden"),d.funcSetBtnAjaxLoading(!1,s)},function(e){i.general.notifyError(),c.addClass("hidden"),d.funcSetBtnAjaxLoading(!1,s)})},d.formFieldSubmit=function(a){a.preventDefault();var n=e.element(a.currentTarget),l=d.formFieldData.item.id;return!n.valid()||void r({method:"post",url:n.attr("action"),data:t.param(d.formFieldData),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(e){if(!e.data.success)return i.general.notifyError(e.data.message),!0;if(i.general.notifySuccess(e.data.message),l=e.data.field.id,e.data.field.is_new){var a=i.general.treeCreateItem(d.rootFieldTree,e.data.field.parent_id,e.data.field);a&&(f(a.parent().contents())(d),setTimeout(function(){a.trigger("click"),d.fieldTags&&d.funcCallTagIT({color:e.data.field.color})},300))}else{var n=t('.tree-list .field-item[data-id="'+l+'"]');n.find(".field-text").html(e.data.field.name),e.data.field.parent_id_old!=e.data.field.parent_id&&i.general.treeCreateItem(d.rootFieldTree,e.data.field.parent_id,null,n),d.fieldPath[d.rootFieldTree][l].data.name=d.formFieldData.item.name,d.fieldTagsName=d.formFieldData.item.name,d.fieldItem.color=e.data.field.color,d.fieldPath[d.rootFieldTree][l].data.color=e.data.field.color,d.funcFieldTagAvai(e.data.field.type,e.data.field.id),setTimeout(function(){i.tagUi.updateColor(e.data.field.color,n)})}t("#modal-field-edit").modal("hide"),t('.field-item[data-id="'+e.data.field.id+'"]').length&&t("html, body").animate({scrollTop:t('.field-item[data-id="'+e.data.field.id+'"]').offset().top-200},300)},function(e){i.general.notifyError()})},d.fieldDeleteClick=function(n){if(d.ajaxLoadindRequest)return!0;var l=e.element(n.currentTarget),o=l.data("field-id"),f=l.find(".submit-ajax-refresh");i.general.popupConfirmDanger({title:d.trans.Confirm,message:d.trans["Are you sure delete this field and all children?"],ok:function(e){f.removeClass("hidden"),d.funcSetBtnAjaxLoading(!0,o),r({method:"delete",url:a.urlFieldDelete,headers:{"Content-Type":"application/x-www-form-urlencoded"},params:{id:o}}).then(function(e){return e.data.success?(i.general.notifySuccess(e.data.message),t('.field-item[data-id="'+o+'"]').remove(),t('.field-item[data-parent-id="'+o+'"]').remove(),d.fieldItem={},d.fieldActiveId=d.rootFieldTree,f.addClass("hidden"),void d.funcSetBtnAjaxLoading(!1)):(t.notify({message:e.data.message},{type:"warning"}),f.addClass("hidden"),d.funcSetBtnAjaxLoading(!1,o),!0)},function(e){i.general.notifyError(),f.addClass("hidden"),d.funcSetBtnAjaxLoading(!1,o)})}},{id:o})},d.formFieldValidate={rules:{"item[name]":{required:!0,maxlength:255}},messages:{"item[name]":{required:d.trans["This field is required"],maxlength:d.trans["Max length :number"]}}},d.funcFieldTagInfo=function(e){return d.fieldTagInfo=e==d.varGlobalTag.fieldTypeInfo,d.fieldTagInfo},d.funcFieldTagAvai=function(e,t){return d.fieldTags=e==d.fieldTypeTag,"undefined"!=typeof d.fieldPath[d.rootFieldTree][t]&&d.fieldPath[d.rootFieldTree][t].child.length&&(d.fieldTags=!1),d.funcFieldTagInfo(e),d.fieldTags},d.funcAvaiColor=function(e){if("undefined"==typeof d.fieldPath[d.rootFieldTree][e])return!1;var t=d.fieldPath[d.rootFieldTree][e];return!(t.data.type!=d.varGlobalTag.fieldTypeTag||t.child.length||!t.data.color)},d.funcIsFieldTagAvai=function(e){if("undefined"==typeof d.fieldPath[d.rootFieldTree][e])return!1;var t=d.fieldPath[d.rootFieldTree][e];return t.data.type==d.varGlobalTag.fieldTypeTag&&!t.child.length},d.funcCallTagIT=function(e){"undefined"==typeof e&&(e={}),setTimeout(function(){i.tagUi.list(t('.tag-field-list[data-type="approve"]'),d.tags.approve,{color:e.color,checkDuplidate:'.tag-field-list[data-type="review"]',compileAngular:!0,scope:d,compile:f,editor:!0,thenUpdateLabelTag:function(e,t,a){d.thenUpdateLabelTagApprove(e,t,a)},beforeChangeAny:function(e,a){try{d.tagReViewInactive(),a._inactiveHighlightTag(t('.tag-field-list[data-type="review"]')),d.$digest()}catch(i){}}}),i.tagUi.list(t('.tag-field-list[data-type="review"]'),d.tags.review,{color:e.color,inputAddRemove:!0,tagReview:!0,classAdd:"tag-review",compileAngular:!0,scope:d,compile:f,funcOptions:function(e,t){d.showTagReviewLink(e,t)},beforeChangeAny:function(e,a){try{d.tagReViewInactive(),a._inactiveHighlightTag(t('.tag-field-list[data-type="review"]')),d.$digest()}catch(i){}}})})},d.isShowTagReviewLink=!1,d.showTagReviewLink=function(e,a){t(document).on("dblclick",e.selector+" .tagit-choice.tagit-choice-editable",function(i){if(a.flagIsDelete)return!0;var n=t(this),l=n.data("id");if(!l)return!0;if(!a._activeHighlightTag(e,n))return!0;d.isShowTagReviewLink=!0,d.tagReviewLinkOrgId=l;try{d.$digest()}catch(r){}})},d.thenUpdateLabelTagApprove=function(e,a,i){"undefined"==typeof d.tags.approve&&(d.tags.approve={}),d.tags.approve[e]={id:e,value:a,stauts:1},t('select[data-s2-etype="reviewLink"]').trigger("change")},d.thenDeleteApprove=function(e){return"undefined"==typeof d.tags.approve[e]||(delete d.tags.approve[e],void d.tagReViewInactive())},d.tagReViewInactive=function(){d.isShowTagReviewLink=!1;try{t('select[data-s2-etype="reviewLink"]').trigger("change")}catch(e){}},d.tagReviewLinkSubmit=function(){var e=t('select[data-s2-etype="reviewLink"]').val();return!(e&&d.tagReviewLinkOrgId&&!isNaN(e)&&!isNaN(d.tagReviewLinkOrgId))||(!!d.tagReviewLinkSubmitProgress||(d.tagReviewLinkSubmitProgress=!0,void r({method:"post",url:d.varGlobalTag.urlTagReviewLinkSubmit,headers:{"Content-Type":"application/x-www-form-urlencoded"},params:{tagOrg:d.tagReviewLinkOrgId,tagAs:e}}).then(function(a){return d.tagReviewLinkSubmitProgress=!1,a.data.success?(i.general.notifySuccess(a.data.message),d.tagReViewInactive(),t('.tag-field-list[data-type="approve"] li.tag-id-'+e).effect("highlight").effect("highlight").effect("highlight"),"undefined"!=typeof d.fieldTagReviewCount[d.fieldActiveId]&&d.fieldTagReviewCount[d.fieldActiveId]--,d.fieldTagTotal[d.fieldActiveId]--,void t('.tag-field-list[data-type="review"] li.tag-id-'+d.tagReviewLinkOrgId).remove()):(i.general.notifyError(a.data.message),!0)})["catch"](function(){d.tagReviewLinkSubmitProgress=!1,i.general.notifyError()})))},d.lengthObject=function(e){return Object.keys(e).length},d.updatefieldPath=function(e){e&&(d.fieldPath[d.rootFieldTree]=e)},d.funcSetBtnAjaxLoading=function(e,t){"undefined"!=typeof t&&t&&(d.disableSubmitBtn=e),d.disableSubmitBtnNew=e,d.ajaxLoadindRequest=e},d.funcFieldCountTag=function(e){var a=t('field-list-tree[data-type-id="'+e+'"] ul.tree-list li.field-item[data-id]'),i=[];return!a.length||(a.each(function(e,a){var n=parseInt(t(a).data("id"));d.funcIsFieldTagAvai(n)&&i.push(n)}),!i.length||void r({method:"get",url:d.varGlobalTag.urlFieldCountTag,headers:{"Content-Type":"application/x-www-form-urlencoded"},params:{fieldIds:i.join("-")}}).then(function(e){if(d.fieldTagReviewCount={},d.fieldTagTotal={},!e.data.count_tag_review.length)return!0;var t,a;for(t in e.data.count_tag_review)a=e.data.count_tag_review[t],d.fieldTagReviewCount[parseInt(a.field_id)]=parseInt(a.total_tag_review),d.fieldTagTotal[parseInt(a.field_id)]=parseInt(a.total_tag)}))},d.funcFieldTagApprove=function(e,a){var n=t(e.currentTarget).closest("li");return!(!a||n.hasClass("ajax-loadings"))&&(n.addClass("ajax-loading"),void r({method:"post",url:d.varGlobalTag.urlFieldApproveTagItem,headers:{"Content-Type":"application/x-www-form-urlencoded"},dataType:"json",data:t.param({id:a,_token:siteConfigGlobal.token})}).then(function(e){return e.data.success?(i.general.notifySuccess(e.data.message),n.remove(),t('.tag-field-list[data-type="approve"]').tagit("createTag",e.data.tagItem.value," tag-id-"+e.data.tagItem.id),"undefined"==typeof d.fieldTagReviewCount[d.fieldActiveId]||void d.fieldTagReviewCount[d.fieldActiveId]--):(i.general.notifyError(e.data.message),!0)}))},d.funcFieldTagDelete=function(e,a){var n=e.data("id");return!!n&&(r({method:"delete",url:d.varGlobalTag.urlFieldDeleteTagItem,headers:{"Content-Type":"application/x-www-form-urlencoded"},dataType:"json",data:t.param({id:n,_token:siteConfigGlobal.token})}).then(function(t){return"function"==typeof a.callback&&a.callback(),t.data.success?(i.general.notifySuccess(t.data.message),e.hasClass("tag-review")&&"undefined"!=typeof d.fieldTagReviewCount[d.fieldActiveId]&&d.fieldTagReviewCount[d.fieldActiveId]--,d.fieldTagTotal[d.fieldActiveId]--,void("function"==typeof a.thenUpdateLabelTag&&d.thenDeleteApprove(n))):(i.general.notifyError(t.data.message),!0)},function(){"function"==typeof a.callback&&a.callback(),i.general.notifyError()}),!0)},d.funcFieldTagAdd=function(e,a,n,l){r({method:"post",url:d.varGlobalTag.urlFieldAddTagItem,headers:{"Content-Type":"application/x-www-form-urlencoded"},dataType:"json",data:t.param({field_id:e,tag_name:n,_token:siteConfigGlobal.token})}).then(function(t){return t.data.success?(a.data("id",t.data.tagItem.id),i.general.notifySuccess(t.data.message),d.fieldTagTotal[e]++,void("function"==typeof l.thenUpdateLabelTag&&d.thenUpdateLabelTagApprove(t.data.tagItem.id,n))):(i.general.notifyError(t.data.message),!0)},function(e){i.general.notifyError(),d.funcSetBtnAjaxLoading(!1,fieldActiveId)})},d.select2OptionsNotSearch=i.select2.notSearch()}])}(angular,jQuery,RKVarGlobalTag,RKTagFunction);