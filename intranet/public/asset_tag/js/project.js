!function(e,t,a,r,o){rkTagApp.controller("projectController",["$scope","$http","$sce","$templateRequest","$compile","$timeout","ModalService","$window","$location",function(n,i,l,d,s,c,g,m,p){function u(){var a=[],r={};if(e.element(".table-project .td-tags").each(function(){var e=t(this).closest("tr").data("id"),o=t(this).data("tagids");if(o){var i=n.toArrayFromStr(o+"","-");if(i.length>0){for(var l=0;l<i.length;l++)a.indexOf(i[l])<0&&a.push(i[l]);r[e]=i}}}),!(a.length<1)){var o=n.getStorageItem(n.KEY_STORAGE_FIELD),l=n.localTagsOfField;if(o&&l)return n.tagsInfo={},o=JSON.parse(o),e.forEach(o,function(t){e.isDefined(l[t.id])&&e.forEach(l[t.id],function(e){e.color=t.color,n.tagsInfo[e.id]=e})}),f(r,n.tagsInfo),void c(n.resizeHiddenTags,200);i.get(n.globTag.urlGetTagsInfo,{params:{tag_str:a.join("-")}}).then(function(t){n.tagsInfo={},t.data&&e.forEach(t.data,function(e,t){n.tagsInfo[e.id]=e}),f(r,n.tagsInfo),c(n.resizeHiddenTags,200)});var d=p.hash();if(d&&d.indexOf("show_")>-1){var s=d.split("_");if(s.length>1){var g=s[1];e.element('tr[data-id="'+g+'"] button.btn-edit').trigger("click")}}e.element(".td-filter-teams .btn-group").removeClass("open")}}function f(t,a){n.collection&&e.forEach(n.collection,function(r){if(e.isDefined(t[r.id])){var o=t[r.id],n=[];for(var i in o){var l=a[o[i]];n.push(l)}r.tag_names=n}})}function j(){e.element(".tags-content ul.tagit").each(function(){var e=t(this).data("id")||null;e&&(n.fieldTagTotal[e]=t(this).find("li.tagit-choice").length)})}var h,b,T=!1,_=!1;n.trans=RKTagTrans,n.varGlobalTag=RKVarGlobalTag,n.projectData={pm:{},type:[],teamLeaderOption:{},teamLeaderLength:0,memberTypes:{}},n.oldProjectData={},n.projectItem={},n.projectDataRelate={},n.projectItemRelate={},b={member:{},scope:{}},h={base:{cust_contact_id:null,manager_id:null,type:0,type_mm:2},sale:{ids:[]},team:{ids:[]},lang:{ids:[]},quality:{}},n.projectData.resourceType=a.general.jsonToArray(RKVarGlobalTag.projectReourceType),n.varGlobalTag.projectStateKey=Object.keys(n.varGlobalTag.projectState).map(Number),n.projectIdActive=null,n.formProjectOldEdit=function(e,t){var r;return"undefined"==typeof t?(r=null,t={loadingModal:!1}):r=t.id,n.editItem=t,n.editProject=t,n.projAssignee=t.assignee_id,n.listAssignees=[{id:t.assignee_id,text:n.convertAccount(t.assignee_name)}],n.projectIdActive=r,T?void n._processGetProjectData(r,t):!!_||(_=!0,t.loadingModal=!0,i({method:"get",url:n.varGlobalTag.urlGetProjectDataNormal,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(e){n.projectData.pm=Object.assign(n.projectData.pm,e.data.pm),n.projectData.type=n.projectData.type.concat(a.general.jsonToArray(e.data.project_type)),n.projectData.teamLeader=a.general.json2ToInt(e.data.team_leader),n.projectData.team=o.teamTree.init(e.data.team),n.projectData.lang=e.data.lang,n.projectData.memberTypes=e.data.member_types,n.projectData.memberTypeAvaiLang=e.data.member_type_avai_lang,n._processGetProjectData(r,t),n.scopeProjOldEdit=e.data.scope_proj_old_edit,n.myTeam=e.data.my_team?e.data.my_team:[],_=!1,T=!0,t.loadingModal=!1},function(e){a.general.notifyError(e.data.message),_=!1,t.loadingModal=!1}),!0)},n._processGetProjectData=function(e,t){return n.project={},"undefined"!=typeof e&&e?(t.loadingModal=!0,void i({method:"get",url:n.varGlobalTag.urlProjectGetDataItem,params:{id:e},headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(e){if(!e.data.success)return a.general.notifyError(e.data.message),!0;if(n.funcResetModalProject("edit",e.data.project),n.oldProjectData=e.data.project,n.project.sales=e.data.sales,n.project.customer_name=e.data.customer_name,e.data.leader_pm&&e.data.leader_pm.length){var r,o,i=!1,l=!1;for(r in e.data.leader_pm)if(o=e.data.leader_pm[r],o.id!=n.projectItem.base.leader_id||i||(n.project.leader_name=n.funcEmailNameConcat(o.email,o.name),i=!0),o.id!=n.projectItem.base.manager_id||l||(n.project.manager_name=n.funcEmailNameConcat(o.email,o.name),l=!0),i&&l)break}n.project.sale_ids=n.projectItem.sale.ids,n._processRenderFormProject(),t.loadingModal=!1},function(e){a.general.notifyError(),_=!1,t.loadingModal=!1})):(n.funcResetModalProject("create"),n._processRenderFormProject(),!0)},n._processRenderFormProject=function(){n.funcSetTitleModalProject(),n.funcCheckProjStatusOld(),n.isProjEditable();var e=l.getTrustedResourceUrl(a.general.getTemplate("project/basic-info.html"));d(e).then(function(e){n.htmlProjectBasicInfo=l.trustAsHtml(e)});var t=l.getTrustedResourceUrl(a.general.getTemplate("project-edit.html"));d(t).then(function(e){n.htmlProjectEditorModal=l.trustAsHtml(e),setTimeout(function(){n._showFormProject()})})},n.isChangeProjectTag=!1,n._showFormProject=function(){RKVarGlobalTag.IS_SEARCH||n.funcSetValidateRule(),n.select2Init(),t("#modal-project-old-edit").modal({backdrop:"static",keyboard:!1}).modal("show"),t('a[href="#project-tags"]').trigger("click"),t("#modal-project-old-edit .tab-content .tab-pane .tab-content-loaded").remove(),t("#modal-project-old-edit").on("shown.bs.modal",function(){var e=!1;o.bootstapMultiSelect.init({onChange:function(t){o.bootstapMultiSelect._removeSpace(t.closest("select")),e=!0},onDropdownHidden:function(a){if(!e)return!0;var r=t(a.currentTarget).siblings("select:first");return a.currentTarget=r[0],n.inputProjectSubmit(a,n.projectItem[r.data("col-group")][r.data("col-name")],r.data("col-group"),r.data("col-name")),e=!1,!0}})}),t("#modal-project-old-edit").on("hidden.bs.modal",function(){t(".modal-backdrop").length&&t(".modal-backdrop").remove(),!n.globTag.IS_SEARCH&&n.isChangeProjectTag&&(n.isChangeProjectTag=!1,n.exportStorageTags({then:function(){n.getList(n.dataFilter)}}))})},n.funcLengObj=function(e){return e?Object.keys(e).length:0},a.validate.addGreaterDate(),a.validate.addGreaterEqualDate(),a.validate.addLessEqualDate(),n.$watch("projectItem",function(){return!n.isProjFormSubmitted||void t("#create-project-form").valid()},!0),n.formProjectSubmit=function(r){r.preventDefault();var o=e.element(r.currentTarget),l=o.find('[type="submit"] .ajax-loading');return n.isProjFormSubmitted=!0,!o.valid()||(!!_||(n.disabledFormProject=!0,l.removeClass("hidden"),void i({method:"post",url:o.attr("action"),data:t.param(n.projectItem),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(r){return r.data.success?(a.general.notifySuccess(r.data.message),n.projectItem.id=parseInt(r.data.id),n.projectItem.base.status=r.data.project.status,n.funcSetTitleModalProject(),_=!1,l.addClass("hidden"),n.disabledFormProject=!1,e.copy(n.projectItem,n.oldProjectData),n.isChangeProjectTag=!0,n.editItem=r.data.project,n.isProjEditable(),void setTimeout(function(){t("#modal-project-old-edit .tab-content .tab-pane .tab-content-loaded").remove(),t('a[href="#scope"]').trigger("click")})):(a.general.notifyError(r.data.message),_=!1,l.addClass("hidden"),n.disabledFormProject=!1,!0)},function(e){a.general.notifyError(),_=!1,l.addClass("hidden"),n.disabledFormProject=!1})))},n.inputProjectSubmit=function(r,o,l,d,s){if(!n.projectItem.id)return!0;"object"==typeof r&&"function"==typeof r.preventDefault?r.preventDefault():"object"==typeof r&&r.currentTarget||"string"==typeof r&&(r={currentTarget:t(r)[0]});var c=e.element(r.currentTarget),g=c.closest("form#create-project-form"),m=c.siblings(".input-ajax-loading"),p={};return!g.length||"undefined"!==s&&s?(p={id:n.projectItem.id,colGroup:l,colName:d,value:o},!!a.general.notChangeValueObject(n.oldProjectData,p)||("team"===l&&(p.relate={leader_id:n.projectItem.base.leader_id}),m.removeClass("hidden"),void i({method:"post",url:n.varGlobalTag.urlProjectUpdateInput,data:t.param(p),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(e){return e.data.reload?(window.location.reload(),!0):e.data.success?(a.general.notifySuccess(e.data.message),n.funcSetTitleModalProject(),m.addClass("hidden"),"undefined"==typeof n.oldProjectData[l]&&(n.oldProjectData[l]={}),n.oldProjectData[l][d]=o,"lang"===l?(g.closest(".tab-content").find("#team-allocation .btn-delete.type-cancel").trigger("click"),!0):"base"===l&&"type_mm"===d?(t("#team-allocation").children().children(".tab-content-loaded").remove(),!0):void(("scope"===l||"base"===l&&["start_at","end_at"].indexOf(d)>-1)&&("scope"===l&&("undefined"==typeof n.tooltipProjTagData[n.projectItem.id]&&(n.tooltipProjTagData[n.projectItem.id]={}),n.tooltipProjTagData[n.projectItem.id].scope_desc=n.projectDataRelate.scope.scope_desc,n.tooltipProjTagData[n.projectItem.id].scope_scope=n.projectDataRelate.scope.scope_scope),n.renderProjTooltip({project_id:n.projectItem.id,start_date:n.projectItem.base.start_at,end_date:n.projectItem.base.end_at,scope_desc:n.tooltipProjTagData[n.projectItem.id].scope_desc,scope_scope:n.tooltipProjTagData[n.projectItem.id].scope_scope}),n.funcQtipItem(null,null,n.projectItem.id)))):(a.general.notifyError(e.data.message),m.addClass("hidden"),!0)},function(e){a.general.notifyError(),m.addClass("hidden")}))):(n.funcSetValidateRule(c.attr("name")),setTimeout(function(){g.valid()&&n.inputProjectSubmit(r,o,l,d,!0)},100),!0)},n.select2OptionsNotSearch=a.select2.notSearch(),n.select2OptionsRemote=function(e){return a.select2.remote(e)},n.select2Init=function(){o.select2.init({minimumInputLength:2})},t(document).on("change",'select[name="cust_contact_id"]',function(e){var a;try{a=parseInt(t(this).val())}catch(r){a=null}n.projectItem.base.cust_contact_id=a,n.inputProjectSubmit(e,a,"base","cust_contact_id")}),t(document).on("change",'select[name="sale_ids[]"]',function(e){var a;try{a=t(this).val().map(Number)}catch(r){a=[]}n.projectItem.sale.ids=a,n.inputProjectSubmit(e,a,"sale","ids")}),n.funcSelect2PMChanged=function(e,a){var r=t(e.currentTarget),o=r.attr("data-col-group"),i=r.attr("data-col-name");return!o||!i||void n.inputProjectSubmit(e,a,o,i)},n.funcSetTitleModalProject=function(){n.projectItem.id?n.titleModalProject=n.projectItem.base.name:n.titleModalProject=n.trans["Add old project"]},n.funcProjWoDetailLink=function(){if(!n.projectItem.id)return"#";var e=n.varGlobalTag.urlProjWoDetail;return e.replace(/0$/,n.projectItem.id)},n.funcResetModalProject=function(t,a){"create"===t?(e.copy(h,n.projectItem),e.copy(b,n.projectDataRelate),e.copy(b,n.projectItemRelate)):"edit"===t&&(e.copy(a,n.projectItem),e.copy(b,n.projectDataRelate),e.copy(b,n.projectItemRelate),n.projectItem.team.ids?n.projectItem.team.ids=n.projectItem.team.ids.map(Number):n.projectItem.team.ids=[],n.projectItem.lang.ids?n.projectItem.lang.ids=n.projectItem.lang.ids.map(Number):n.projectItem.lang.ids=[])},n.funcProjLoadTabContent=function(r){var o=t(r.currentTarget),s=o.attr("href"),c=t(s).children("[ng-bind-html-compile]");if("#project-tags"==s&&n.initProjectFields(n.projectItem.id),!c.length)return!0;var g=c.data("url"),m=c.data("template"),p=c.attr("ng-bind-html-compile");return!(g&&m&&p&&!c.children(".tab-content-loaded").length)||(n[p]='<i class="fa fa-spin fa-refresh"></i>',void i({method:"get",url:g,params:{id:n.projectItem.id},headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(t){if(!t.data.success)return a.general.notifyError(t.data.message),!0;e.forEach(t.data.relate,function(t,a){"object"==typeof t&&(Array.isArray(t)?(n.oldProjectData[a]=[],n.projectDataRelate[a]=[]):(n.oldProjectData[a]={},n.projectDataRelate[a]={}),e.copy(t,n.projectDataRelate[a]),e.copy(t,n.oldProjectData[a]))});var r=l.getTrustedResourceUrl(a.general.getTemplate(m));d(r).then(function(e){n[p]=l.trustAsHtml(e)}),n.disabledProjMemberBtn=!1},function(e){a.general.notifyError()}))},n.funcSetValidateRule=function(e){n.isProjFormSubmitted=!1,n.projRulesDefault||(n.projRulesDefault={messages:{name:{remote:"This field is unique"},project_code:{remote:"This field is unique"},end_at:{greaterDate:"Must be greater than start date"}},ignore:"",errorPlacement:function(e,t){t.hasClass("bootstrap-multiselect")?e.insertAfter(t.next(".btn-group")):t.hasClass("igs-input")?t.closest(".input-group-select2").after(e):e.insertAfter(t)}}),n.projrulesAvai={"team_ids[]":{required:!0},"lang_ids[]":{required:!0},leader_id:{required:!0},manager_id:{required:!0},type:{required:!0},billable_effort:{required:!0,number:!0,min:0},plan_effort:{required:!0,number:!0,min:0},start_at:{required:!0,date:!0},end_at:{required:!0,date:!0,greaterDate:"#project_start_at"},name:{required:!0,maxlength:255,remote:{url:n.varGlobalTag.urlProjectCheckExists,type:"get",data:{col:"name",value:function(){return n.projectItem.base.name},id:n.projectItem.id}}},project_code:{required:!0,maxlength:255,remote:{url:n.varGlobalTag.urlProjectCheckExists,type:"get",data:{col:"project_code",value:function(){return n.projectItem.base.project_code},id:n.projectItem.id}}}},"undefined"==typeof e?n.formProjectRules=n.projrulesAvai:"undefined"==typeof n.projrulesAvai[e]?n.formProjectRules={}:(n.formProjectRules={},n.formProjectRules[e]=n.projrulesAvai[e],"team_ids[]"===e&&(n.formProjectRules.leader_id=n.projrulesAvai.leader_id)),n.validationProjForm=t("form#create-project-form").validate(n.projRulesDefault),n.validationProjForm&&(n.validationProjForm.settings.rules=n.formProjectRules)},n.funcSetProjMember=function(t,a){var r={};if(e.copy(t,r),r.account=r.email.replace(/@.*$/,""),r.account=r.account[0].toUpperCase()+r.account.slice(1),r.start_at=r.start_at.replace(/\s.*$/,""),r.end_at=r.end_at.replace(/\s.*$/,""),r.typeText=n.projectData.memberTypes[r.type],r.key=parseInt(a)+1,"undefined"!=typeof r.lang_ids);else if(r.prog_lang){r.lang_ids=(""+r.prog_lang).split(",").map(Number);var o,i="";for(o in r.lang_ids)"undefined"!=typeof n.projectData.lang[r.lang_ids[o]]&&(i+=n.projectData.lang[r.lang_ids[o]]+", ");r.prog_lang=i.slice(0,-2)}return r.type=parseInt(r.type),r.employee_id=parseInt(r.employee_id),n.projectItemRelate.member[r.id]={},e.copy(r,n.projectItemRelate.member[r.id]),n.projectItemRelate.member[r.id]},n.funcProjMemberAdd=function(r){var i,c,g=e.element(r.currentTarget),m=g.closest("#form-proj-member"),p=g.closest("tr[data-member-id]");if(m.find("input, select").length)return!0;i=p.length?parseInt(p.attr("data-member-id")):0,n.disabledProjMemberBtn=!0,"undefined"!=typeof i&&i&&"undefined"!=typeof n.projectItemRelate.member[i]?(n.projMember={id:n.projectItemRelate.member[i].id,type:n.projectItemRelate.member[i].type,employee_id:n.projectItemRelate.member[i].employee_id,prog_langs:n.projectItemRelate.member[i].lang_ids,start_at:n.projectItemRelate.member[i].start_at,end_at:n.projectItemRelate.member[i].end_at,effort:n.projectItemRelate.member[i].effort},n.projMemberData={key:n.projectItemRelate.member[i].key,account:n.projectItemRelate.member[i].account,flat_resource:n.projectItemRelate.member[i].flat_resource},c=!0):(n.projMember={type:1,employee_id:null,prog_langs:[],id:null},n.projMemberData={account:null},c=!1);var u=l.getTrustedResourceUrl(a.general.getTemplate("project/member-edit.html"));d(u).then(function(e){var a;if(c){var r=g.closest("tr[data-member-id]");r.after(e),a=r.next(),r.remove()}else{var l=t("#team-allocation .table-proj-members tbody");l.append(e),a=l.children("tr:last")}a.attr("data-member-id",i),s(a.contents())(n),setTimeout(function(){o.bootstapMultiSelect.init(),a.find("button").prop("disabled",!1)})})},n.funcProjMemberCancel=function(t){var a=e.element(t.currentTarget),r=a.closest("tr[data-member-id]"),o=parseInt(r.attr("data-member-id"));"undefined"!=typeof o&&o?n.funcProjMemberView(r,o):r.remove(),n.disabledProjMemberBtn=!1},n.funcProjMemberRemove=function(r){var o=e.element(r.currentTarget),l=o.closest("tr[data-member-id]"),d=o.find(".ajax-loading"),s=o.find(".ajax-main-content"),c=parseInt(l.attr("data-member-id"));return"undefined"==typeof c&&!c||void a.general.popupConfirmDanger({title:n.trans.EConfirm,ok:function(){s.addClass("hidden"),d.removeClass("hidden"),n.disabledProjMemberBtn=!0,i({method:"delete",url:n.varGlobalTag.urlProjMemberDelete,headers:{"Content-Type":"application/x-www-form-urlencoded"},params:{id:c,project_id:n.projectItem.id}}).then(function(e){return e.data.success?(a.general.notifySuccess(e.data.message),s.removeClass("hidden"),d.addClass("hidden"),n.disabledProjMemberBtn=!1,l.remove(),void n.funcAfterRemoveMember(c)):(t.notify({message:e.data.message},{type:"warning"}),s.removeClass("hidden"),d.addClass("hidden"),n.disabledProjMemberBtn=!1,!0)},function(e){a.general.notifyError(),s.removeClass("hidden"),d.addClass("hidden"),n.disabledProjMemberBtn=!1})},closed:function(){t("body").addClass("modal-open")}})},n.funcAfterRemoveMember=function(e){if("undefined"==typeof n.projectItemRelate.member[e])return!0;var a,r,o=n.projectItemRelate.member[e].key;delete n.projectItemRelate.member[e];for(a in n.projectItemRelate.member)r=n.projectItemRelate.member[a],r.key<o||(r.key--,t('#form-proj-member table > tbody > tr[data-member-id="'+r.id+'"] > td.member-key').text(r.key));console.log(n.projectItemRelate.member)},n.funcProjMemberSave=function(r){var o,l=e.element(r.currentTarget),d=l.closest("form#form-proj-member"),s={};if(1===parseInt(n.projMember.type)?(o=d.validate(n.validateFormProjMemberDefault),o.settings.rules=n.validateFormProjMemberDefault.rules):(e.copy(n.validateFormProjMemberDefault,s),delete s.rules["prog_langs[]"],o=d.validate(s),o.settings.rules=s.rules),!d.valid())return!0;n.disabledProjMemberBtn=!1,n.disabledProjMemberBtn=!0;var c=l.find(".ajax-loading"),g=l.find(".ajax-main-content"),m=l.closest("tr[data-member-id]");n.projMember.project_id=n.projectItem.id,g.addClass("hidden"),c.removeClass("hidden"),i({method:"post",url:n.varGlobalTag.urlProjectSaveMember,data:t.param(n.projMember),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(e){if(!e.data.success)return a.general.notifyError(e.data.message),c.addClass("hidden"),g.removeClass("hidden"),n.disabledProjMemberBtn=!1,!0;var t;t=n.projMember.id?n.projectItemRelate.member[n.projMember.id].key-1:Object.keys(n.projectItemRelate.member).length,n.projMember.email=n.projMemberData.account,n.projectData.memberTypeAvaiLang.indexOf(n.projMember.type)>-1&&n.projMember.prog_langs&&n.projMember.prog_langs.length?n.projMember.prog_lang=n.projMember.prog_langs.join():n.projMember.prog_lang="",n.projMember.flat_resource=e.data.member.flat_resource,n.projMember.id=e.data.member.id,n.funcSetProjMember(n.projMember,t),n.funcProjMemberView(m,e.data.member.id),a.general.notifySuccess(e.data.message),n.disabledProjMemberBtn=!1},function(e){a.general.notifyError(),n.disabledProjMemberBtn=!1,c.addClass("hidden"),g.removeClass("hidden")})},n.funcProjMemberView=function(e,t){var r=l.getTrustedResourceUrl(a.general.getTemplate("project/member-view.html"));n.itemMemberId=t,d(r).then(function(a){e.after(a);var r=e.next();r.attr("data-member-id",t),s(r.contents())(n),e.remove()})},n.validateFormProjMemberDefault={rules:{type:{required:!0},employee_id:{required:!0},start_at:{required:!0,date:!0,greaterEqualDate:"#project_start_at"},end_at:{required:!0,date:!0,lessEqualDate:"#project_end_at",greaterEqualDate:"#proj_member-start_at"},effort:{required:!0,number:!0,min:0,max:100},"prog_langs[]":{required:!0}},messages:{start_at:{greaterEqualDate:"Must be greater or equal than start date of project"},end_at:{lessEqualDate:"Must be less or equal than end date of project",greaterEqualDate:"Must be greater or equal than start date of member"}},ignore:"",errorPlacement:function(e,t){t.hasClass("bootstrap-multiselect")?e.insertAfter(t.next(".btn-group")):e.insertAfter(t)}},a.general.validateRemoteDelay(),n.funcCheckProjStatusOld=function(e){return n.projectItem.id?("undefined"!=typeof e&&e||(e=n.projectItem.base.status),n.isProjOld=n.varGlobalTag.projectStateKey.indexOf(parseInt(e))>-1,n.isProjOld):(n.isProjOld=!0,!0)},n.funcIsProjOld=function(e){return n.varGlobalTag.projectStateKey.indexOf(parseInt(e))>-1},n.getProjGroupsName=function(){var e,t,a="";for(e in n.projectData.team)t=n.projectData.team[e],n.projectItem.team.ids.indexOf(parseInt(t.id))>-1&&(a+=t.label.trim()+", ");return a.slice(0,-2)},n.getProjTypeText=function(){var e,t;for(e in n.projectData.type)if(t=n.projectData.type[e],n.projectItem.base.type==t.id)return t.label;return null},n.getProjSalesText=function(){if("undefined"==typeof n.project.sales||!n.project.sales)return null;var e,t="";for(e in n.project.sales)t+=n.project.sales[e].label+", ";return t.slice(0,-2)},n.getProjTypeResourceEffort=function(){return"undefined"==typeof n.varGlobalTag.projectReourceType[n.projectItem.base.type_mm]?null:n.varGlobalTag.projectReourceType[n.projectItem.base.type_mm]},n.getProjLangsText=function(){if(!n.projectItem.lang.ids||!n.projectItem.lang.ids.length)return null;var e,t,a="";for(e in n.projectItem.lang.ids)t=n.projectItem.lang.ids[e],"undefined"!=typeof n.projectData.lang[t]&&(a+=n.projectData.lang[t]+", ");return a.slice(0,-2)},n.isProjEditable=function(){return n.projectItem.base.status?n.funcIsProjOld(n.projectItem.base.status)?n.scopeProjOldEdit==n.varGlobalTag.scopeCompany?(n.isProjEdit=!0,!0):n.scopeProjOldEdit==n.varGlobalTag.scopeTeam&&a.general.intersectionArray(n.projectItem.team.ids,n.myTeam)?(n.isProjEdit=!0,!0):n.projectItem.base.manager_id==n.varGlobalTag.userCurrent||n.projectItem.base.leader_id==n.varGlobalTag.userCurrent?(n.isProjEdit=!0,!0):(n.isProjEdit=!1,!1):(n.isProjEdit=!1,!1):(n.isProjEdit=!0,!0)},n.funcEmailNameConcat=function(e,t){return"undefined"!=typeof e&&e?(e=e.replace(/@.*/,""),"undefined"!=typeof t&&t?t+" ("+e+")":e):t},n.funcProcessNext=function(e){return!n.projectItem.id||void c(function(){t('a[href="'+e+'"]').trigger("click")})},n.collection=[],n.initFilter(),n.dataFilter.dir||(n.dataFilter.dir="desc"),n.dataLoaded=!0,n.fieldTagTotal=[],c(function(){n.$broadcast("tags_selected",n.filterTagSelected)}),n.$on("is_search_page",function(e,t){n.isSearchPage=t}),n.getList=function(t,o){if(e.isDefined(o)||(o=!1),n.dataLoaded){n.isSearchPage&&a.progressBar.start(),n.dataLoaded=!1,n.globTag.IS_REVIEW&&(t.is_review=n.globTag.IS_REVIEW),n.globTag.projectIds&&!o&&(t["project_ids[]"]=JSON.parse(n.globTag.projectIds));var i=t.field,l=t.tag;t=a.general.paramField(t),"undefined"!=typeof t.tag&&t.tag&&(t.tag=a.general.encodeSlugTag(t.tag)),n.isSearchPage?r.init({then:function(e){return e?(n.dataLoaded=!0,n.dataSearched=!0,n.dataReseted=!0,a.progressBar.end(),!0):(n.fullProjectIds=r.searchField(i,l),n.fullProjectIds&&(t.proj_filter=n.fullProjectIds.join("-"),n.$broadcast("EventChangeProjFilter",t.proj_filter)),void n.getListHttp(t))}}):n.getListHttp(t)}},n.getListHttp=function(t){i({method:"get",url:n.globTag.urlGetProjectList,headers:{"Content-Type":"application/x-www-form-urlencoded"},params:t}).then(function(t){var r,o=t.data;e.isDefined(o.projectsList)?(r=o.projectsList,n.tagsOfField=o.tagsOfField,n.numberTagOfField=o.numberTagOfField,n.teamCountProj=o.teamCountProj,n.totalProjInField=o.totalProjInField,n.totalProject=r.total||0,n.$broadcast("tags_data_loaded")):r=o,n.collection=r.data,n.getActiveTeamProj(),n.pager={current_page:r.current_page,next_page:r.last_page>r.current_page?r.current_page+1:null,last_page:r.last_page||0,limit:r.per_page+"",total:r.total||0,page:r.current_page},n.dataFilter.limit=r.per_page,n.dataLoaded=!0,n.dataSearched=!0,n.dataReseted=!0,n.checkedItems=[],e.element("._check_all").prop("checked",!1),n.bulkAction=null,c(function(){u()},300),a.progressBar.end()})["catch"](function(e){a.general.notifyError(),n.dataLoaded=!0,n.dataSearched=!0,n.dataReseted=!0,a.progressBar.end()})},c(function(){n.getList(n.dataFilter)}),n.getActiveTeamProj=function(){return!!t(".tb-proj-list").length&&void e.getTestability(t(".tb-proj-list")).whenStable(function(){n.$broadcast("project_list_change");var a=[];return t(".tb-proj-list .team-str-list").each(function(e,r){var o=t(r).data("leader-id");return!o||t(r).find("[data-team-id]").length<2||void(a.indexOf(o)===-1&&a.push(o))}),n.funcTooltipShow(),!a.length||void i({method:"GET",url:n.globTag.urlGetProjLeaderTeam,headers:{"Content-Type":"application/x-www-form-urlencoded"},params:{leader:a.join("-")}}).then(function(a){return!a.data.leader||void e.forEach(a.data.leader,function(e){var a=e.team_ids.split(",").map(Number);t('.tb-proj-list .team-str-list[data-leader-id="'+e.employee_id+'"]').each(function(e,r){return t(r).find("[data-team-id]").length<2||void t(r).find("[data-team-id]").each(function(e,r){a.indexOf(parseInt(t(r).data("team-id")))>-1&&t(r).addClass("active")})})})})["catch"](function(){})})},n.funcTooltipShow=function(){t(".tooltip-proj-tag-search[data-id]").each(function(e,a){var r=t(a).data("id");return"undefined"==typeof n.tooltipProjTag[r]||!n.tooltipProjTag[r]||void n.funcQtipItem(t(a),n.tooltipProjTag[r])})},n.funcQtipItem=function(e,a,r){if(!e||!a){if(!r)return!1;e=t(".tooltip-proj-tag-search[data-id="+r+"]"),a=n.tooltipProjTag[r]}e.qtip({content:{text:a},position:{my:"top center",at:"center",viewport:t(window)},hide:{fixed:!0,delay:100},style:{classes:"custom-tooltip tooltip-proj-tag"}})},n.resizeHiddenTags=function(){var e=60;t("body tr .td-tags ul.tagit").each(function(){var a=t(this),r=parseInt(a.parent().data("tagcount")),o=a.width()-e,i=0,l=a.find("li"),d=0;a.addClass("hidden"),l.each(function(e){var n=!1;if(t(this).hasClass("hidden")&&(t(this).removeClass("hidden"),n=!0),a.removeClass("hidden"),i+=t(this).outerWidth(!0),a.addClass("hidden"),n&&t(this).addClass("hidden"),i>=o)return l.eq(e).nextAll().andSelf().not(".more-tag").addClass("hidden"),l.eq(e).prevAll().removeClass("hidden"),d=r-e,!1}),d>0?a.find(".more-tag .num").length>0?a.find(".more-tag .num").text(d):a.append('<li class="more-tag">+<span class="num">'+d+"</span> more</li>"):(a.find(".more-tag").remove(),l.removeClass("hidden"),r>n.globTag.SHOW_NUM_TAGS&&a.append('<li class="more-tag">+<span class="num">'+(r-n.globTag.SHOW_NUM_TAGS)+"</span> more</li>")),a.removeClass("hidden")})};var v;t(window).resize(function(){c.cancel(v),v=c(n.resizeHiddenTags,200)}),n.doSort=function(e){if(n.dataLoaded){if(n.dataFilter.order==e){var t="asc"==n.dataFilter.dir?"desc":"asc";n.dataFilter.dir=t}n.dataFilter.order=e,n.getList(n.dataFilter),n.saveFilter()}},n.goPage=function(e){return!(!n.dataLoaded||!e)&&(isFinite(e)||(e=1),e>n.pager.last_page&&(e=n.pager.last_page,n.pager.current_page=e),e<1&&(e=1,n.pager.current_page=1),!(1==e&&1==n.pager.page||e==n.pager.last_page&&n.pager.page==n.pager.last_page)&&(n.dataFilter.page=e,n.getList(n.dataFilter),n.saveFilter(),!1))},n.changePerPage=function(){n.dataLoaded&&(n.pager.page=1,n.dataFilter.limit=n.pager.limit,n.dataFilter.page=1,n.getList(n.dataFilter),n.saveFilter())},n.searchData=function(e,a,r){if(n.dataLoaded)switch(n.dataFilter.page=1,e){case 1:13==a.keyCode&&(n.dataSearched=!1,n.getList(n.dataFilter),n.saveFilter());break;case 3:if("undefined"==typeof r||"undefined"==typeof r.tagit)break;t(r.tagit).tagit("assignedTags").length?n.dataFilter.tag=t(r.tagit).tagit("assignedTags"):delete n.dataFilter.tag,n.dataSearched=!1,n.getList(n.dataFilter),n.saveFilter();break;default:n.dataSearched=!1,n.getList(n.dataFilter),n.saveFilter()}},n.resetDataFilter=function(a){if(n.dataLoaded){if(n.initFilter(!0),n.dataFilter.page=1,n.dataReseted=!1,p.search({}),m.location.search){var r=m.location;return void(m.location.href=r.origin+r.pathname)}if(n.$broadcast("tags_selected",[]),delete n.dataFilter["project_ids[]"],n.getList(n.dataFilter,!0),a&&a.currentTarget){var o=t(a.currentTarget).data("tagit");o&&t(o).length&&t(o).tagit("removeAll")}c(function(){e.element(".select2-hidden-accessible:not(.not-reset)").next(".select2-container").find(".select2-selection__rendered").text(""),e.element(".bootstrap-multiselect").multiselect("deselectAll"),e.element(".bootstrap-multiselect").multiselect("refresh")},200),n.$broadcast("reset_project_filter")}},n.projTagStatuses=JSON.parse(n.globTag.projTagStatuses),n.getLabelStatus=function(e){return"undefined"!=typeof n.projTagStatuses[e]?n.projTagStatuses[e]:null},n.getClassStatus=function(t,a){return e.isDefined(a)||(a=!1),t==n.globTag.PROJ_STT_APPROVE?a?"label-success":"text-green":t==n.globTag.PROJ_STT_REVIEW?a?"label-primary":"text-light-blue":t==n.globTag.PROJ_STT_ASSIGNED?a?"label-info":"text-aqua":a?"label-danger":"text-red"},n.actionClasses=JSON.parse(n.globTag.tagActionClasses),n.tagActionClass=function(t){var a="tag-action";return t=parseInt(t),e.isDefined(n.actionClasses[t])?a+" "+n.actionClasses[t]:a},n.dismissModal=function(t){e.element(t.target).closest(".modal").modal("hide")},n.fields=[],n.globTag.FIELDS&&(n.fields=JSON.parse(n.globTag.FIELDS)),n.showModalEditTag=function(t){d(n.generalTag.getTemplate("project/edit-tag.html")).then(function(a){var r=s(a)(n),o=e.element("#modal-edit-tags");o.html("").append(r),r.modal("show"),c(function(){r.find(".tree-list li:eq(1) a").click()},500),n.projectFields=[],n.projectFields.push(n.globTag.SET_FIELD_PROJ),n.listEditTags=[],n.fieldsLoaded=[],n.editItem=t,n.fieldActiveId=null,n.fieldSelected=null})["catch"](function(){a.general.notifyError()})},n.initProjectFields=function(a){n.fieldActiveId=null,n.fieldsLoaded=[],n.listEditTags=[],n.fieldSelected=null,n.projectFields=[],n.projectFields.push(n.globTag.SET_FIELD_PROJ),c(function(){t("#modal-project-old-edit").find(".tree-list li:eq(1) a").click()},200),n.fieldTagTotal={},i.get(n.globTag.urlCountFieldsTag,{params:{project_id:a}}).then(function(a){a.data&&e.forEach(a.data,function(e,t){parseInt(e.tag_count)>0&&(n.fieldTagTotal[parseInt(e.field_id)]=e.tag_count)}),t("#project_tags_form").addClass("count-tag-loaded")})},n.$on("listen_fields",function(e,t){n.fields&&(n.fields=t)}),n.listEditTags=[],n.fieldsLoaded=[],n.getFieldProjTags=function(r,o){var l=e.element(o.target).closest(".modal");return n.fieldActiveId==r?void l.find('.proj-tags[data-id="'+r+'"]').parent().removeClass("hidden"):(n.fieldActiveId=r,n.fieldSelected=n.fields[r],n.fieldSelected.child.length>0?void(n.fieldNotLeaves=!0):(n.fieldNotLeaves=!1,n.fieldsLoaded.indexOf(r)>-1?void l.find('.proj-tags[data-id="'+r+'"]').parent().removeClass("hidden"):(n.fieldsLoaded.push(r),n.loadingTags=!0,n.editItem=e.extend(n.editItem,n.projectItem),l.find(".tags-content").addClass("hidden"),void i.get(RKVarGlobalTag.urlEditProjectTag,{params:{proj_id:n.editItem.id,field_id:r}}).then(function(o){n.avalidTags=[];var d=l.find('#project_tags_form .proj-tags[data-id="'+r+'"]');try{d.tagit("destroy")}catch(s){}n.listEditTags[r]=o.data.tags,n.tagReadOnly=!0,c(function(){var d=l.find('#project_tags_form .proj-tags[data-id="'+r+'"]');try{d.tagit("destroy")}catch(s){}var c=!0;o.data.permissUpdateTag&&(c=!1,n.editItem.showEditTagBtn=!0),n.permissUpdateTag=o.data.permissUpdateTag,(n.editItem.tag_status==n.globTag.PROJ_STT_APPROVE&&!n.globTag.permissApprove||n.globTag.IS_SEARCH)&&(c=!0),n.tagReadOnly=c,d.tagit({allowSpaces:!0,readOnly:c,caseSensitive:!1,tagSource:function(e,a){var i=n.getStorageTags();if(i&&i[r]){i=i[r];var l=t.map(o.data.tags,function(e){return e.value}),d=[];for(var s in i){var c=i[s];l.indexOf(c.value)>-1||c.value.substr(0,e.term.length).toLowerCase()==e.term.toLowerCase()&&d.push(c.value)}a(d)}else a([])},beforeTagAdded:function(t,o){o.duringInitialization||(n.loadingTags=!0,i.post(n.globTag.urlAddTag,{project_id:n.editItem.id||n.projectItem.id,field_id:r,tag:o.tagLabel}).then(function(t){return t.data.reload?(window.location.reload(),!0):(n.loadingTags=!1,n.isChangeProjectTag=!0,t.data.tag_id&&e.element(o.tag).addClass("tagid-"+t.data.tag_id),void j())})["catch"](function(t){a.general.notifyError(t.data.message),n.loadingTags=!1,e.element(o.tag).remove()}))},beforeTagRemoved:function(t,o){if(o.tagLabel){n.loadingTags=!0;var l=o.tag.attr("class").match(/tagid-\d+/);if(l&&l.length&&l[0])return i["delete"](n.globTag.urlDeleteTag,{params:{project_id:n.editItem.id||n.projectItem.id,field_id:r,tag_id:l[0].replace(/\D+/,"")}}).then(function(t){return t.data.reload?(window.location.reload(),!0):(e.element(o.tag).remove(),n.loadingTags=!1,n.isChangeProjectTag=!0,void j())})["catch"](function(e){a.general.notifyError(e.data.message),n.loadingTags=!1}),!1}}}),d.parent().removeClass("hidden"),
d.find(".tagit-new inpu").focus()},300),n.loadingTags=!1})["catch"](function(e){a.general.notifyError(e.data.message),n.loadingTags=!1}))))},n.modalEditAssignee=function(t){d(n.generalTag.getTemplate("project/edit-assignee.html")).then(function(a){var r=s(a)(n),o=e.element("#modal-edit-assignee");o.html("").append(r),r.modal("show"),n.editProject=t,n.projAssignee=t.assignee_id,n.listAssignees=[{id:t.assignee_id,text:n.convertAccount(t.assignee_name)}]})["catch"](function(){a.general.notifyError()})},n.assigneeSelect2Opts={ajax:{url:n.globTag.urlSearchEmployee,dataType:"json",delay:250,data:function(e){return{q:e.term,page:e.page}},processResults:function(e,t){return t.page=t.page||1,{results:e.items,pagination:{more:20*t.page<e.total_count}}}},minimumInputLength:1},n.saveProjAssignee=function(t,r){if(t){var o=e.element(r.target),l=o.find("select").val(),d=l.split(":");if(d.length>1&&(l=d[1]),!l||isNaN(l))return!0;var s;s=n.isBulkAction?n.checkedItems:n.editProject.id||n.projectItem.id,n.savingAssignee=!0,i.post(n.globTag.urlSaveProjectAssignee,{project_id:s,assignee_id:l}).then(function(e){var t=o.closest(".modal");"modal_edit_proj_assignee"==t.attr("id")&&t.modal("hide");var r=e.data;n.isBulkAction?(n.isBulkAction=!1,n.getList(n.dataFilter)):(n.editProject.assignee_id=r.assignee_id,n.editProject.assignee_name=r.assignee_name,n.editProject.tag_status=r.tag_status),a.general.notifySuccess(e.data.message),n.savingAssignee=!1})["catch"](function(e){n.savingAssignee=!1,a.general.notifyError(e.data.message)})}},n.submitEditTag=function(r,o){g.showModal({templateUrl:n.generalTag.getTemplate("confirm-modal.html"),controller:"projModalController"}).then(function(l){l.element.modal(),l.scope.confirmTitle=n.trans["Confirm submit"],l.scope.confirmContent=n.trans["Are you sure submit"],l.close.then(function(l){if(l&&r.tag_status!=n.globTag.TAG_STT_REVIEW){var d=e.element(o.target).closest("form"),s={},c=[];d.find("ul.proj-tags").each(function(){if(t(this).hasClass("tagit")){var e=t(this).data("id"),a=t(this).tagit("assignedTags");s[e]=a,c=t.merge(c,a)}}),r.loading=!0,i.post(n.globTag.urlSubmitProjectTag,{project_id:r.id,proj_tags:s}).then(function(t){return t.data.reload?(window.location.reload(),!0):(r.tag_status=t.data.tag_status,r.assignee_id=t.data.assignee_id,r.assignee_name=t.data.assignee_name,e.isDefined(t.data.tag_results)&&(r.tag_names=t.data.tag_results),r.loading=!1,e.isDefined(o)&&e.element(o.target).closest(".modal").modal("hide"),a.general.notifySuccess(t.data.message),void j())})["catch"](function(e){r.loading=!1,a.general.notifyError(e.data.message)})}})})},n.approveTag=function(r,o){g.showModal({templateUrl:n.generalTag.getTemplate("confirm-modal.html"),controller:"projModalController"}).then(function(l){l.element.modal(),l.scope.confirmTitle=n.trans["Confirm submit"],l.scope.confirmContent=n.trans["Are you sure submit"],l.close.then(function(l){if(l){var d=e.element(o.target).closest("form"),s={},c=[];d.find("ul.proj-tags").each(function(){if(t(this).hasClass("tagit")){var e=t(this).data("id"),a=t(this).tagit("assignedTags");s[e]=a,c=t.merge(c,a)}}),r.loading=!0,i.post(n.globTag.urlApproveProjectTag,{project_id:r.id,proj_tags:s}).then(function(t){return t.data.reload?(window.location.reload(),!0):(r.tag_status=t.data.tag_status,r.assignee_id=t.data.assignee_id,r.assignee_name=t.data.assignee_name,r.loading=!1,e.isDefined(o)&&e.element(o.target).closest(".modal").modal("hide"),j(),void a.general.notifySuccess(t.data.message))})["catch"](function(e){r.loading=!1,a.general.notifyError(e.data.message)})}})})},n.checkedItems=[],n.checkAllItem=function(a){var r=e.element(a.target);e.element("._check_item").prop("checked",r.is(":checked")),n.checkedItems=[],e.element("._check_item:checked").each(function(){n.checkedItems.push(t(this).val())})},n.checkItem=function(t,a){var r=e.element(a.target),o=n.checkedItems.indexOf(t);r.is(":checked")?o<0&&n.checkedItems.push(t):o>-1&&n.checkedItems.splice(o,1);var i=e.element("._check_item").length,l=e.element("._check_item:checked").length;e.element("._check_all").prop("checked",i===l)},n.teamList=[],n.globTag.TEAM_LIST&&(n.teamList=jQuery.map(JSON.parse(n.globTag.TEAM_LIST),function(e,t){return{value:e.value,label:n.generalTag.htmlDecode(e.label)}})),c(function(){var t=!1;e.element(".td-filter-teams select").multiselect({includeSelectAllOption:!1,nonSelectedText:"Choose items",allSelectedText:"All",nSelectedText:"items selected",numberDisplayed:0,enableFiltering:!0,enableCaseInsensitiveFiltering:!0,onDropdownShow:function(){t=!1},onChange:function(e){t=!0},onDropdownHidden:function(e){t&&n.searchData(2)}});var a=e.element(".td-filter-teams .multiselect-container li.filter .input-group-btn");if(!a.hasClass("apply-search")){var r=s('<button class="btn btn-default apply-search" ng-click="searchData(2)">Apply</button>')(n);a.addClass("apply-search").append(r)}},200),n.bulkActions=[],n.globTag.ACTION_LIST&&(n.bulkActions=JSON.parse(n.globTag.ACTION_LIST)),n.projTagActions=function(){!n.bulkAction||n.checkedItems.length<1||!n.dataLoaded||(n.isBulkAction=!0,n.bulkAction==n.globTag.ACTION_ASSIGN?(d(n.generalTag.getTemplate("project/edit-assignee.html")).then(function(t){var a=s(t)(n),r=e.element("#modal-edit-assignee");r.html("").append(a),a.modal("show"),n.projAssignee=null})["catch"](function(){a.general.notifyError("Not found template")}),n.bulkAction=null):g.showModal({templateUrl:n.generalTag.getTemplate("confirm-modal.html"),controller:"projModalController"}).then(function(e){e.element.modal(),e.scope.confirmTitle=n.trans.Confirm,e.scope.confirmContent=n.trans["Are you sure action"],e.close.then(function(e){return e?(n.dataLoaded=!1,void i.post(n.globTag.urlBulkAction,{project_id:n.checkedItems,action:n.bulkAction}).then(function(e){n.dataLoaded=!0,n.getList(n.dataFilter),a.general.notifySuccess(e.data.message)})["catch"](function(e){n.dataLoaded=!0,a.general.notifyError(e.data.message)})):void(n.bulkAction=null)}),n.isBulkAction=!1}))},n.checkShowBtnSubmitTag=function(e,t){if(n.globTag.IS_SEARCH||!n.permissUpdateTag)return!1;switch(t){case"submit":return!!n.globTag.permissSubmit&&(!n.globTag.permissApprove&&e.tag_status!=n.globTag.PROJ_STT_APPROVE);case"approve":return n.globTag.permissApprove;default:return!1}},n.rootFieldTree=n.globTag.SET_FIELD_PROJ,n.$watch("fields",function(){var e=a.getHtmlFieldTree.init(n.rootFieldTree,n.fields,1,0,{type:n.varGlobalTag.fieldTypeInfo,level:2,attrMore:'ng-click="getFieldProjTags({{id}}, $event)" id="field_{{id}}"'});n.htmlFieldTree=l.trustAsHtml(e)}),n.toggleSearchTab=function(e,t){if("employee"==e){if(c(n.resizeHiddenTags,200),!n.dataLoaded)return t.preventDefault(),t.stopPropagation(),!1;n.$broadcast("load_employees")}else{if("project"!=e)return;c(n.resizeHiddenTags,200)}n.saveFilter(n.dataFilter)},n.tagit={},n.tagit.showScroll=function(e){var a=t(".tag-search.tagit")[0].scrollWidth,r=t(".tag-search.tagit").outerWidth();return r>=a?(e.removeClass("has-scroll-hoz"),e.closest(".content-header").removeClass("has-scroll-hoz"),!0):(e.addClass("has-scroll-hoz"),e.closest(".content-header").addClass("has-scroll-hoz"),!0)},t(".tag-search").length&&(t(".tag-search").tagit({allowSpaces:!0,caseSensitive:!1,placeholderText:"Enter tag...",afterTagAdded:function(e,a){n.tagit.showScroll(t(e.target))},afterTagRemoved:function(e,a){n.tagit.showScroll(t(e.target)),t(".btn-search-tag").trigger("click")},autocomplete:{source:function(e,t){t(a.ng.tagitSource(n,e,this.element))}}}),"undefined"!=typeof n.dataFilter.tag&&e.forEach(n.dataFilter.tag,function(e){t(".tag-search").tagit("createTag",e)}),t(".tag-search .tagit-new input").keypress(function(e){e.which===t.ui.keyCode.ENTER&&!t(this).val()&&t(".btn-search-tag").length&&t(".btn-search-tag").trigger("click")})),n.listProjectTypes={},e.isDefined(n.globTag.labelProjectTypes)&&(n.listProjectTypes=JSON.parse(n.globTag.labelProjectTypes)),n.labelProjType=function(t){return e.isDefined(n.listProjectTypes[t])?n.listProjectTypes[t]:null},n.tooltipProjTag={},n.tooltipProjTagData={},n.renderProjTooltip=function(e){var t=e.project_id;if(!t)return!0;"undefined"==typeof n.tooltipProjTagData[t]&&(n.tooltipProjTagData[t]={});var a="";e.pm_email&&(a+="<li><strong>"+n.trans["Project Manager"]+"</strong>: "+n.convertAccount(e.pm_email)+"</li>",n.tooltipProjTagData[t].pm_email=e.pm_email),e.start_date&&(a+="<li><strong>"+n.trans.Time+"</strong>: "+e.start_date.replace(/\s.*/,"")+' <i class="fa fa-long-arrow-right"></i> '+e.end_date.replace(/\s.*/,"")+"</li>",n.tooltipProjTagData[t].start_date=e.start_date,n.tooltipProjTagData[t].end_date=e.end_date);var r="";if(e.sale_emails){var o=n.toArrayFromStr(e.sale_emails,", ");if(o.length>0){r=[];for(var i in o)r.push(n.convertAccount(o[i]));r=r.join(", ")}a+="<li><strong>"+n.trans.Sale+": "+r+"</li>"}return e.scope_desc&&(a+='<li class="pre-text"><strong>'+n.trans.Description+"</strong>: "+e.scope_desc+"</li>",n.tooltipProjTagData[t].scope_desc=e.scope_desc),e.scope_scope&&(a+='<li class="pre-text"><strong>'+n.trans.Scope+"</strong>: "+e.scope_scope+"</li>",n.tooltipProjTagData[t].scope_scope=e.scope_scope),!a||(a='<ul class="project-tooltip">'+a+"</ul>",void(n.tooltipProjTag[t]=a))},n.funcTagForMulti=function(e,r){e.preventDefault(),n.checkboxTag={all:!1,item:{}},n.tagOfFieldAvai=a.ng.tagOfField(n,t('.proj-tags.tag-field-list.tagit[data-id="'+r+'"]'),r),t("#modal-tag-field-multi-choose").modal("show")},n.funcChangeSelectAllTag=function(){var a=n.checkboxTag.all;e.forEach(t('input[name="checkbox_tag_field_item"]'),function(e){n.checkboxTag.item[t(e).val()]=a})},n.funcChangeSelectItemTag=function(a){if("undefined"==typeof n.checkboxTag.item[a]||!n.checkboxTag.item[a])return n.checkboxTag.all=!1,!0;var r=!0;e.forEach(t('input[name="checkbox_tag_field_item"]'),function(e){if(!n.checkboxTag.item[t(e).val()])return r=!1,!1}),n.checkboxTag.all=r},n.funcSubmitTagMulti=function(e,r){e.preventDefault();var o,l=[];for(o in n.checkboxTag.item)n.checkboxTag.item[o]&&l.push(o);return!l.length||(n.loadingTags=!0,t("#modal-tag-field-multi-choose").modal("hide"),void i.post(n.globTag.urlAddTag,{project_id:n.projectIdActive,field_id:r,tag:l.join("-"),multi:!0}).then(function(e){if(e.data.success){if(n.loadingTags=!1,n.isChangeProjectTag=!0,e.data.count){n.fieldActiveId=null;var o=n.fieldsLoaded.indexOf(r);n.fieldsLoaded.splice(o,1),c(function(){t('.tree-list .field-item[data-id="'+r+'"]').trigger("click")},200),"undefined"==typeof n.fieldTagTotal[r]&&(n.fieldTagTotal[r]=0),n.fieldTagTotal[r]+=e.data.count}}else{if(e.data.reload)return window.location.reload(),!0;a.general.notifyError(e.data.message),n.loadingTags=!1}})["catch"](function(e){if("undefined"==typeof e.data)var t="Error system";else var t=e.data.message;a.general.notifyError(t),n.loadingTags=!1}))}}]),rkTagApp.controller("projModalController",["$scope","close","$element",function(e,t,a){e.dismissModal=function(e){a.modal("hide"),t(e,200)}}]),rkTagApp.directive("tagUi",function(){return{restrict:"A",link:function(e,t,a){a.$observe("tagUi",function(){var e=a.tagUi;e=e?JSON.parse(e):{},e.allowSpaces=!0,t.tagit(e)})}}})}(angular,jQuery,RKTagFunction,RKTagLDB,RKfuncion);