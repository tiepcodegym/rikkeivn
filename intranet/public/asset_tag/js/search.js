!function(e,t,a,r){rkTagApp.controller("searchObjectTagController",["$scope","$http","$timeout","$location","$sce","$httpParamSerializer","$q",function(i,l,o,n,d,s,c){function f(){o(function(){var t=e.element(".filter-col").height();e.element(".content-container").css("min-height",t)},300)}i.trans=RKTagTrans,i.varGlobalTag=RKVarGlobalTag,i.isSearchPage=!0,l.get(i.varGlobalTag.urlGetFieldsPath,{}).then(function(t){i.fieldsPath=t.data.fieldsPath,i.fields=t.data.fieldsPath,i.$emit("listen_fields",t.data.fieldsPath),i.teamList=r.teamTree.init(t.data.team),i.$broadcast("filter_team_loaded"),i.maxMM=t.data.maxMM,o(function(){var t=n.search();if(e.isDefined(t.field)){var r=a.general.decodeSlugField(t.field).field;e.forEach(r,function(t,a){e.element("#toggle_field_"+a).trigger("click")})}else if(e.isDefined(t.search)){var i=t.search;i&&(i=JSON.parse(i),e.isDefined(i.billable_effort)?e.element("#toggle_mm_checkbox").trigger("click"):e.isDefined(i["tpj.team_id"])?e.element("#toggle_team_checkbox").trigger("click"):e.element('.fields-path .filter-box input[type="checkbox"]:first').trigger("click"))}else e.element('.fields-path .filter-box input[type="checkbox"]:first').trigger("click")},1e3)}),i.$on("tags_selected",function(e,t){t||(t=[]),i.tagsSelected=t}),i.$emit("is_search_page",i.isSearchPage),i.toggleFilterTag=function(t,a){if(i.dataLoaded){e.isDefined(i.dataFilter.field[a])||(i.dataFilter.field[a]=[]);var r=i.tagsSelected.indexOf(t.tag_id+""),l=i.dataFilter.field[a].indexOf(t.tag_id+"");r>-1?(i.tagsSelected.splice(r,1),l>-1&&(i.dataFilter.field[a].splice(l,1),i.dataFilter.field[a].length||delete i.dataFilter.field[a])):(i.tagsSelected.push(t.tag_id+""),l<0&&i.dataFilter.field[a].push(t.tag_id+"")),i.getList(i.dataFilter),i.saveFilter()}},i.$on("tags_data_loaded",function(e){f()}),i.generateTagMoreUrl=function(e){var t=i.varGlobalTag.urlGetMoreTag,a={fieldId:e};return a["tagIdsExists[]"]=i.getCurrentTagOfField,d.trustAsHtml(t+"/?"+s(a))},i.getCurrentTagOfField=function(t){if(e.isDefined(i.tagsOfField[t])){var a=[];return e.forEach(i.tagsOfField[t],function(e,t){a.push(e.tag_id)}),a}return[]},i.MIN_SEARCH=10,jQuery("body").on("change",".search-tag-field",function(){var e=t(this).data("id"),a=t(this).val(),r=t(this).find("option:selected").text(),l={tag_id:a,tag_name:r,tag_count:0};i.tagsOfField[e].push(l),i.$apply(),i.toggleFilterTag(l,e),t(this).next(".select2-container").find(".select2-selection__rendered").text("Search").attr("title","Search")}),jQuery("body").on("click",".filter-search .select2-container",function(){var e=jQuery(window).scrollTop();jQuery(window).scrollTop(e+1)}),jQuery("body").on("keyup",".select2-container input.select2-search__field",function(){if(""==t(this).val().trim()){var e=jQuery(window).scrollTop();jQuery(window).scrollTop(e+1)}}),i.toggleCheckField=function(t,a){var r=e.element(a.target).closest(".filter-box"),l=e.element(a.target),n=l.is(":checked"),d=r.find(".box-title label");if(o(function(){l.prop("checked",!d.hasClass("collapsed"))},50),!n&&e.isDefined(i.dataFilter.field[t]))var s=setInterval(function(){if(i.dataLoaded){clearInterval(s);for(var e=i.dataFilter.field[t],a=0;a<e.length;a++){var r=e[a],l=i.tagsSelected.indexOf(r+"");l>-1&&i.tagsSelected.splice(l,1)}delete i.dataFilter.field[t],i.getList(i.dataFilter),i.saveFilter()}},500);d.hasClass("collapsed")?d.removeClass("active"):d.addClass("active"),o(function(){r.find(".select2-container").css("width","100%")},200),f()},i.toggleFilterTeam=function(t){var a=[];e.isDefined(i.dataFilter.search)&&e.isDefined(i.dataFilter.search["tpj.team_id"])&&(a=i.dataFilter.search["tpj.team_id"]);var r=a.indexOf(t);r<0?a.push(t):a.splice(r,1),e.isDefined(i.dataFilter.search)||(i.dataFilter.search={}),i.dataFilter.search["tpj.team_id"]=a,i.getList(i.dataFilter),i.saveFilter()},i.toggleCheckTeam=function(t,a){var r=e.element(a.target).closest(".filter-box"),l=e.element(a.target),n=l.is(":checked"),d=r.find(".box-title label");if(o(function(){l.prop("checked",!d.hasClass("collapsed"))},50),!n&&e.isDefined(i.dataFilter.search)&&e.isDefined(i.dataFilter.search["tpj.team_id"]))var s=setInterval(function(){i.dataLoaded&&(clearInterval(s),delete i.dataFilter.search["tpj.team_id"],i.getList(i.dataFilter),i.saveFilter())},500);d.hasClass("collapsed")?d.removeClass("active"):d.addClass("active")},i.toggleCheckMM=function(a){var r=e.element(a.target).closest(".filter-box"),l=e.element(a.target),n=l.is(":checked"),d=r.find(".box-title label");if(o(function(){l.prop("checked",!d.hasClass("collapsed"))},50),!n&&e.isDefined(i.dataFilter.search)&&e.isDefined(i.dataFilter.search.billable_effort))var s=setInterval(function(){i.dataLoaded&&(clearInterval(s),delete i.dataFilter.search.billable_effort,i.getList(i.dataFilter),i.saveFilter(),i.filterMMStart=0,i.filterMMEnd=g,t("#slider_mm").slider("values",[0,p]))},500);d.hasClass("collapsed")?d.removeClass("active"):d.addClass("active")},i.countProjOfTeam=function(t){if(!e.isDefined(i.teamCountProj))return 0;var a=0;return e.forEach(i.teamCountProj,function(e){if(e.team_id==t)return a=e.count_proj,!1}),a},i.countProjOfField=function(t){if(!e.isDefined(i.totalProjInField))return 0;var a=0;return e.forEach(i.totalProjInField,function(e){if(e.field_id==t)return a=e.total_item,!1}),a},i.toggleFilterClose=!0,i.toggleFilter=function(){var t=e.element(".field-box-list");i.toggleFilterClose?(i.toggleFilterClose=!1,t.addClass("ft-show")):(i.toggleFilterClose=!0,t.removeClass("ft-show"))},i.$on("total_employees",function(e,t){i.totalEmployee=t||0});var p=100,g="âˆž";i.$watch("maxMM",function(a){e.isDefined(a)&&(p=parseInt(a)+5,i.filterMMStart=0,i.filterMMEnd=g,e.isDefined(i.dataFilter.search)&&e.isDefined(i.dataFilter.search.billable_effort)&&(i.filterMMStart=i.dataFilter.search.billable_effort[0],i.dataFilter.search.billable_effort[1]<p&&(i.filterMMEnd=i.dataFilter.search.billable_effort[1])),t("#slider_mm").each(function(){var a=t(this);a.slider({range:!0,min:0,max:p,step:.1,values:[i.filterMMStart,p],slide:function(e,t){i.filterMMStart=t.values[0],i.filterMMEnd=t.values[1],i.filterMMEnd>=p&&(i.filterMMEnd=g);var r;r=t.value<=10?.1:1,a.slider("option","step",r),i.$apply()},change:function(t,a){e.isDefined(i.dataFilter.search)?i.dataFilter.search.billable_effort=a.values:i.dataFilter.search={billable_effort:a.values},i.searchData(2),0==a.values[0]&&a.values[1]==p&&(delete i.dataFilter.search.billable_effort,i.dataFilter.search||delete i.dataFilter.search),i.saveFilter(i.dataFilter)}})}))}),i.$on("reset_project_filter",function(){i.filterMMStart=0,i.filterMMEnd=g,t("#slider_mm").slider("values",[0,p])})}]),rkTagApp.controller("employeeController",["$scope","$http","$timeout","$compile",function(i,l,o,n){function d(){var a=[],r={};if(e.element(".table-employee .td-tags").each(function(){var e=t(this).closest("tr").data("id"),l=t(this).data("tagids");if(l){var o=i.toArrayFromStr(l+"","-");if(o.length>0){for(var n=0;n<o.length;n++)a.indexOf(o[n])<0&&a.push(o[n]);r[e]=o}}}),!(a.length<1)){var n=i.getStorageItem(i.KEY_STORAGE_FIELD),d=i.localTagsOfField||null;return n&&d?(e.isDefined(i.tagsInfo)&&i.tagsInfo&&(n=JSON.parse(n),e.forEach(n,function(t){e.isDefined(d[t.id])&&e.forEach(d[t.id],function(e){e.color=t.color,i.tagsInfo[e.id]=e})})),s(r,i.tagsInfo),void o(i.resizeHiddenTags,200)):void l.get(i.globTag.urlGetTagsInfo,{params:{tag_str:a.join("-")}}).then(function(t){i.tagsInfo={},t.data&&e.forEach(t.data,function(e,t){i.tagsInfo[e.id]=e}),s(r,i.tagsInfo),o(i.resizeHiddenTags,200)})}}function s(t,a){i.employeesList&&e.forEach(i.employeesList,function(r){if(e.isDefined(t[r.id])){var i=t[r.id],l=[];for(var o in i){var n=a[i[o]];l.push(n)}r.tag_names=l}})}function c(){i.filterEmployee={order:"proj.created_at",dir:"desc",page:1,search:{}},i.pager={current_page:1,next_page:null,last_page:0,limit:50,total:0},i.employeeLoaded=!1,o(function(){t(".nav-tabs-search .nav-tabs li:first a").click()},300),i.getList(i.filterEmployee)}function f(){o(function(){var t=!1;e.element(".emp-filter-teams select").multiselect({includeSelectAllOption:!1,nonSelectedText:"Choose items",allSelectedText:"All",nSelectedText:"items selected",numberDisplayed:2,enableFiltering:!0,enableCaseInsensitiveFiltering:!0,onDropdownShow:function(){t=!1},onChange:function(e){r.bootstapMultiSelect._removeSpace(e.closest("select"),2),t=!0},onDropdownHidden:function(e){t&&i.searchData(2)}});var a=e.element(".emp-filter-teams .multiselect-container li.filter .input-group-btn");if(!a.hasClass("apply-search")){var l=n('<button class="btn btn-default apply-search" ng-click="searchData(2)">Apply</button>')(i);a.addClass("apply-search").append(l)}},200)}i.employeesList=[],i.filterEmployee={order:"proj.created_at",dir:"desc",page:1,search:{}},i.pager={current_page:1,next_page:null,last_page:0,limit:50,total:0},i.employeeBusyRate={},i.projIdsFilter="",i.$on("EventChangeProjFilter",function(e,t){i.projIdsFilter=t}),i.getList=function(t,r){if(e.isDefined(r)||(r=!1),i.dataLoaded){if(t.project_ids="",!i.projIdsFilter)return i.employeesList=null,i.pager={current_page:1,next_page:0,last_page:0,limit:0,total:0,page:0},!0;t.project_ids=i.projIdsFilter,a.progressBar.start(),i.dataLoaded=!1,f(),l.get(i.globTag.urlGetEmployeeList,{params:t}).then(function(e){i.employeeIdsGetBusyRate=[];var t=e.data;i.employeesList=t.data,i.$emit("total_employees",t.total),i.pager={current_page:t.current_page,next_page:t.last_page>t.current_page?t.current_page+1:null,last_page:t.last_page||0,limit:t.per_page+"",total:t.total||0,page:t.current_page},i.filterEmployee.limit=t.per_page,o(d,200),i.employeeLoaded=!0,i.dataLoaded=!0,a.progressBar.end(),i.getEmployeeBusyRate(i.employeesList,t.total)})["catch"](function(e){a.general.notifyError(),i.dataLoaded=!0,a.progressBar.end()})}},i.funcSetEmployeeBusyRate=function(e){return!!i.employeeBusyRate.hasOwnProperty(e)||void i.employeeIdsGetBusyRate.push(e)},i.getEmployeeBusyRate=function(a,r){return!r||void e.getTestability(t(".tb-tag-emp-list")).whenStable(function(){return!i.employeeIdsGetBusyRate.length||void l({method:"get",url:i.globTag.urlGetEmployeeBusyRate,headers:{"Content-Type":"application/x-www-form-urlencoded"},params:{employee:i.employeeIdsGetBusyRate.join("-")}}).then(function(e){return!(e.data&&e.data.employee.length&&e.data.month)||void i.employeeBusyRateRender(e.data.employee,e.data.month)})["catch"]()})},i.datePeriod={},i.numberPeriodBusyRate=0,i.setDatePeriod=function(t){if(!e.equals({},i.datePeriod))return i.datePeriod;var a=7,r=t.clone();for(r.month(t.month()+2).endOf("month"),i.numberPeriodBusyRate=0;;){var l=t.format("YYYY-MM-DD");if(i.datePeriod[l]={dateFormat:l,color:"white",effort:0,dateStart:t.clone(),dateEnd:t.clone().day("Sunday").add(a,"d")},i.datePeriod[l].daysWork=i.daysWork(i.datePeriod[l].dateStart,i.datePeriod[l].dateEnd),i.numberPeriodBusyRate++,t.isAfter(r))break;t.day("Monday"),t.add(a,"d")}return i.numberPeriodBusyRate=100/i.numberPeriodBusyRate,i.datePeriod},i.employeeBusyRateRender=function(t,a){var r=moment(a),l=i.setDatePeriod(r),o={};e.forEach(t,function(t){"undefined"==typeof o[t.employee_id]&&(o[t.employee_id]=[],i.employeeBusyRate[t.employee_id]={},e.copy(l,i.employeeBusyRate[t.employee_id]),i.employeeIdsGetBusyRate.splice(i.employeeIdsGetBusyRate.indexOf(t.employee_id),1)),o[t.employee_id].push({start_at:moment(t.start_at),end_at:moment(t.end_at),effort:t.effort})}),i.employeeIdsGetBusyRate.length&&(e.forEach(i.employeeIdsGetBusyRate,function(t){i.employeeBusyRate[t]={},e.copy(l,i.employeeBusyRate[t])}),i.employeeIdsGetBusyRate=[]),e.forEach(o,function(t,a){e.forEach(t,function(t){e.forEach(i.employeeBusyRate[a],function(e){if(e.dateStart.isAfter(t.end_at))return!1;var a,r=0,l=0;e.dateStart.isSameOrBefore(t.start_at)&&t.start_at.isSameOrBefore(e.dateEnd)?(a=t.end_at.isBefore(e.dateEnd)?t.end_at.clone():e.dateEnd.clone(),l=i.daysWork(t.start_at,a),r=l*t.effort/e.daysWork):e.dateStart.isSameOrBefore(t.end_at)&&t.end_at.isSameOrBefore(e.dateEnd)?(l=i.daysWork(e.dateStart,t.end_at),r=l*t.effort/e.daysWork):e.dateStart.isAfter(t.start_at)&&e.dateEnd.isBefore(t.end_at)&&(r=parseFloat(t.effort)),r&&(r=parseFloat(r.toFixed(2)),e.effort+=r,e.color=i.busyRateColor(e.effort))})})})},i.busyRateColor=function(e){return e>100?"red":e>80?"green":e>0?"yellow":"white"},i.daysWork=function(e,t){for(var a=0,r=e.clone();;){if(r.isAfter(t))break;var l=r.format("YYYY-MM-DD"),o=r.format("MM-DD"),n=r.format("ddd");i.globTag.holiday.special.indexOf(l)>-1||i.globTag.holiday.annual.indexOf(o)>-1||i.globTag.holiday.weekend.indexOf(n)>-1||a++,r.add(1,"d")}return a},i.employeeLoaded=!1,i.$on("load_employees",function(){i.employeeLoaded||i.getList(i.filterEmployee)}),i.doSort=function(e){if(i.dataLoaded){if(i.filterEmployee.order==e){var t="asc"==i.filterEmployee.dir?"desc":"asc";i.filterEmployee.dir=t}i.filterEmployee.order=e,i.getList(i.filterEmployee)}},i.goPage=function(e){return!(!i.dataLoaded||!e)&&(isFinite(e)||(e=1),e>i.pager.last_page&&(e=i.pager.last_page,i.pager.current_page=e),e<1&&(e=1,i.pager.current_page=1),!(1==e&&1==i.pager.page||e==i.pager.last_page&&i.pager.page==i.pager.last_page)&&(i.filterEmployee.page=e,void i.getList(i.filterEmployee)))},i.changePerPage=function(){i.dataLoaded&&(i.pager.page=1,i.filterEmployee.limit=i.pager.limit,i.filterEmployee.page=1,i.getList(i.filterEmployee))},i.searchData=function(e,t){if(i.dataLoaded)switch(i.filterEmployee.page=1,e){case 1:13==t.keyCode&&(i.dataSearched=!1,i.getList(i.filterEmployee));break;default:i.dataSearched=!1,i.getList(i.filterEmployee)}},i.classSorting=function(e){return i.filterEmployee.order==e?"asc"==i.filterEmployee.dir?"sorting_asc":"sorting_desc":""},i.$on("project_list_change",function(){o(c,300)})}])}(angular,jQuery,RKTagFunction,RKfuncion);