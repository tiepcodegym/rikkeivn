function reCalTimeWorking(t){$("#"+t).find(".input_checkin").each(function(){var t=$(this).attr("name"),e=t.match(/\[(checkin|checkout|break_time)\]/),a=t.replace(e[1],"checkin"),i=t.replace(e[1],"checkout"),n=t.replace(e[1],"break_time"),o=t.replace(e[1],"working_hour"),r=t.replace(e[1],"ot_hour"),d=$('[name="'+a+'"]').val(),l=$('[name="'+i+'"]').val(),s=$('[name="'+n+'"]').val();""!=d&&""!=l&&calTimeWorking(o,r,d,l,s)})}function refreshItem(){$("#timesheet-body").html('<img src="'+IMG_LOADING+'" class="data-loading" />');var t=$("#period-select").val().split("->");if(!checkIsDate(t[0]))return void $("#timesheet-body").html("");$("#start_date").val(t[0]),$("#end_date").val(t[1]);var e={po_id:$("#po-select").val(),project_id:$("#project-select").val(),start_date:t[0],end_date:t[1]},a=REFRESH_LINE_ITEM_URL+"?"+$.param(e);$(".data-loading").show(),getAjax(a).done(handleChangePeriod)}function validateTime(t){var e,a=!0;return e=void 0!==t?$("#"+t).find(".input-time"):$(".input-time"),e.each(function(){var t=$(this).attr("name"),e=t.match(/\[(checkin|checkout|break_time)\]/),i=t.replace(e[1],"checkin"),n=t.replace(e[1],"checkout"),o=t.replace(e[1],"break_time"),r=t.replace(e[1],"working_hour"),d=$('[name="'+i+'"]'),l=$('[name="'+n+'"]'),s=$('[name="'+o+'"]'),c=$('[name="'+r+'"]'),h=convertTimeToMinutes(d.val()),_=convertTimeToMinutes(l.val()),v=convertTimeToMinutes(s.val());if(d.removeClass("error"),l.removeClass("error"),c.removeClass("error"),""!=d.val()||""!=l.val()||""!=s.val())return""==d.val()&&""!=l.val()?(d.addClass("error"),void(a=!1)):""!=d.val()&&""==l.val()?(l.addClass("error"),void(a=!1)):void(_-h-v<0&&(d.addClass("error"),l.addClass("error"),c.addClass("error"),a=!1))}),a}function calTimeWorking(t,e,a,i,n){if(""==a||""==i)return $('input[name="'+t+'"]').val(""),void $('input[name="'+e+'"]').val("");a=convertTimeToMinutes(a),i=convertTimeToMinutes(i),n=convertTimeToMinutes(n);var o=convertTimeToMinutes(checkin_standard),r=convertTimeToMinutes(checkout_standard),d=0;o>a&&(d+=o-a),r<i&&(d+=i-r);var l=rebuildValueFloat((i-a-n-d)/60),s=rebuildValueFloat(d/60);return $('input[name="'+t+'"]').hasClass("is-weekend")?($('input[name="'+t+'"]').val(""),void $('[name="'+e+'"]').val(parseFloat(l)+parseFloat(s))):($('input[name="'+t+'"]').val(l),void $('input[name="'+e+'"]').val(s))}function editRow(t,e,a,i){i=rebuildValueFloat(i),$("#"+t).find(".row-"+e).find("."+a).not(".is-weekend").not(".leave-day").val(i)}function validateValueHour(t){return!!isFloat(t)&&!(t>24)}function rebuildValueFloat(t){var e=0;return t=String(t),t.indexOf(".")>=0?(e=t.substring(parseInt(t.indexOf("."))+1),parseInt(e)>0?parseFloat(t).toFixed(2):t.substring(0,parseInt(t.indexOf(".")))):t}function handleChangeProject(t){var e=$(".po-group"),a=$("#po-select"),i=$(".period-group");return resetPoPeriod(),$(".img-loading").hide(),0===t.data.length?($(".po-group-no-item").show(),e.hide(),void i.hide()):(e.show(),i.show(),void $.each(t.data,function(t,e){a.append('<option value="'+e.id+'">'+e.name+"</option>"),period[e.id]=e.period,rate_ot_list[e.id]=e.rate_ot}))}function load_rateOt(t){checkin_standard="8:00",checkout_standard="17:30",""!=t.checkin_standard&&(checkin_standard=t.checkin_standard),""!=t.checkout_standard&&(checkout_standard=t.checkout_standard),ot_normal_start=t.ot_normal_start,ot_normal_end=t.ot_normal_end,ot_day_off_start=t.ot_day_off_start,ot_day_off_end=t.ot_day_off_end,ot_holiday_start=t.ot_holiday_start,ot_holiday_end=t.ot_holiday_end,ot_overnight_start=t.ot_overnight_start,ot_overnight_end=t.ot_overnight_end,$("#checkin_standard").val(checkin_standard),$("#checkout_standard").val(checkout_standard),$("#ot_normal_start").val(ot_normal_start),$("#ot_normal_end").val(ot_normal_end),$("#ot_day_off_start").val(ot_day_off_start),$("#ot_day_off_end").val(ot_day_off_end),$("#ot_holiday_start").val(ot_holiday_start),$("#ot_holiday_end").val(ot_holiday_end),$("#ot_overnight_start").val(ot_overnight_start),$("#ot_overnight_end").val(ot_overnight_end),$(".checkin_standard").text(checkin_standard),$(".checkout_standard").text(checkout_standard),$(".ot_normal_start").text(ot_normal_start),$(".ot_normal_end").text(ot_normal_end),$(".ot_day_off_start").text(ot_day_off_start),$(".ot_day_off_end").text(ot_day_off_end),$(".ot_holiday_start").text(ot_holiday_start),$(".ot_holiday_end").text(ot_holiday_end),$(".ot_overnight_start").text(ot_overnight_start),$(".ot_overnight_end").text(ot_overnight_end),""!=t.ot_normal_start&&$(".rate-ot-block").show()}function handleChangePO(t){var e=period[t];$("#period-select").html("<option>--- Select ---</option>"),$("#po_title").val($("#po-select>option:selected").text()),e.length>0&&$.each(e,function(t,e){$("#period-select").append('<option value="'+e.start+"->"+e.end+'">'+e.start+" -> "+e.end+"</option>")})}function handleChangePeriod(t){return"error"==t.status?($("#note").html(t.message),void $(".data-loading").hide()):(""!=t.html?($("#note").html("<strong>Chú ý:</strong> Những dữ liệu bên dưới được set với các giá trị mặc định, bạn cần đồng bộ với timesheet thực tế của nhân viên."),$("#timesheet-body").html(t.html),$(".data-loading").hide(),RKExternal.select2.init()):($("#note").html("Không có dữ liệu trong khoảng thời gian này. Vui lòng kiểm tra lại đơn hàng"),$(".data-loading").hide()),void $(".tbl-line-item").each(function(){reCalTotalWorkingHour($(this).attr("id"))}))}function handleSyncTimesheet(t){var e=t.line_item_id;$("."+e).find(".message-item").html("").removeClass("error text-success"),$('[name="line_item['+e+'][employee_id]"]').val($(".search-employee").val()),"error"==t.status?$("."+e).find(".message-item").addClass("error").text(t.message):""!=t.html&&($(".division-"+e).val(t.team_id).trigger("change"),$("#"+e).html(t.html),$("."+e).find(".message-item").addClass("text-success").text("Đồng bộ timesheet thành công")),$(".input-float").each(function(t){$(this).val(rebuildValueFloat($(this).val()))}),reCalTotalWorkingHour(e),reCalTotalLeaveDay(e)}function resetPoPeriod(){$("#po-select").html("<option>--- Select ---</option>"),$("#period-select").html("<option>--- Select ---</option>"),$(".po-group").hide(),$(".period-group").hide(),$(".po-group-no-item").hide()}function getAjax(t,e,a){return"undefined"===e&&(e=""),void 0===a&&(a="GET"),$.ajax({type:a,url:t,data:e})}function checkIsTime(t){return/^\s*(2[0-3]|[01]?[0-9]):([0-5]?[0-9])\s*$/.test(t)}function checkIsDate(t){return/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(t)}function isFloat(t){var e=/^\s*\d*(\.\d+)?\s*$/;return e.test(t)}function convertTimeToMinutes(t){if(!checkIsTime(t))return 0;var e=t.split(":");return 60*e[0]+parseFloat(e[1])}function reCalTotalWorkingHour(t){var e=$("#"+t),a=0,i=0,n=0;e.find(".input_working_hour").each(function(){""!=$(this).val()&&(a+=parseFloat($(this).val()))}),e.find(".input_ot_hour").each(function(){""!=$(this).val()&&(i+=parseFloat($(this).val()))}),e.find(".input_overnight").each(function(){""!=$(this).val()&&(n+=parseFloat($(this).val()))}),$(".total-working-"+t).text(rebuildValueFloat(a+i+n)),$(".total-ot-"+t).text(rebuildValueFloat(i)),$(".total-overnight-"+t).text(rebuildValueFloat(n))}function reCalTotalLeaveDay(t){var e=$("#"+t),a=0,i=0,n=0;e.find(".input_working_hour").not(".is-weekend").each(function(){n++,i+=8,""!=$(this).val()&&(a+=parseFloat($(this).val()))}),n=Math.max((i-a)/8,0),$("#collapse-"+t).find(".input_day_of_leave").val(n.toFixed(3))}function validate_edit_all(){var t=!0;return $(".valid-mesage").hide(),$(".edit-item").removeClass("error"),$(".edit-item").each(function(e){""==$(this).val()||checkIsTime($(this).val())||(t=!1,$(this).addClass("error"),$(".valid-mesage").show())}),t}var period=[],line_deleted=[],rate_ot_list=[],checkin_standard="8:00",checkout_standard="17:30",ot_normal_start="",ot_normal_end="",ot_day_off_start="",ot_day_off_end="",ot_holiday_start="",ot_holiday_end="",ot_overnight_start="",ot_overnight_end="";$(document).ready(function(){$(".input-date").datepicker({autoclose:!0,format:"yyyy-mm-dd",weekStart:1,todayHighlight:!0}),RKExternal.select2.init(),$(document).on("click",".toogle-item",function(){$(this).hasClass("collapsed")?$(this).text("[ + ]"):$(this).text("[ - ]")}),$(".search-employee").selectSearchEmployee(),$("#project-select").on("change",function(){var t=$(this).val(),e=GET_PO_URL+"?project_id="+t;$(".img-loading").show(),$("#timesheet-body").html(""),getAjax(e).done(handleChangeProject)}),$("#period-select").on("change",function(){$("#timesheet-body").html('<img src="'+IMG_LOADING+'" class="data-loading" />');var t=$(this).val().split("->");if(!checkIsDate(t[0]))return void $("#timesheet-body").html("");$("#start_date").val(t[0]),$("#end_date").val(t[1]);var e={po_id:$("#po-select").val(),project_id:$("#project-select").val(),start_date:t[0],end_date:t[1],timesheet_id:TIMESHEET_ID,checkin_standard:checkin_standard,checkout_standard:checkout_standard};$("#project_name").val($("#project-select>option:selected").text());var a=GET_LINE_ITEM_URL+"?"+$.param(e);$(".data-loading").show(),getAjax(a).done(handleChangePeriod),$(".edit-time-block").show()}),$("#po-select").on("change",function(){var t=$(this).val();handleChangePO(t),load_rateOt(rate_ot_list[t])}),$("#btn-edit-time").on("click",function(){var t=$(".edit-checkin").val(),e=$(".edit-checkout").val(),a=$(".edit-breaktime").val(),i=validate_edit_all();i&&(""!=t&&$(".input_checkin").not(".is-weekend").not(".leave-day").val(t),""!=e&&$(".input_checkout").not(".is-weekend").not(".leave-day").val(e),""!=a&&$(".input_break_time").not(".is-weekend").not(".leave-day").val(a),$(".line-item").each(function(t){var e=$(this).find(".tbl-line-item").attr("id");reCalTimeWorking(e),reCalTotalWorkingHour(e),reCalTotalLeaveDay(e)}))}),$(document).on("click",".show-note",function(){$(".btn-save-note").data("id",$(this).data("id")),$(".btn-save-note").data("date",$(this).data("date"));var t=$(this).parent().find(".note-"+$(this).data("date")).val();$("#txt-note").val(t),$("#note-modal").modal()}),$(document).on("click",".toogle-item",function(){$(this).hasClass("collapsed")?$(this).text("[ + ]"):$(this).text("[ - ]")}),$(document).on("click",".btn-save-note",function(){var t=$(this).data("id"),e=$(this).data("date");$('textarea[name="line_item['+t+"][details]["+e+'][note]"]').val($("#txt-note").val())}),$(document).on("click",".btn-sync-timesheet",function(){var t=$("#start_date").val(),e=$("#end_date").val(),a=$("#sync-timesheet");a.data("line-id",$(this).data("line-id")),a.data("start-date",t),a.data("end-date",e),$("#sync-modal").modal()}),$("#sync-timesheet").on("click",function(){var t=$(".search-employee").val(),e=$(this).data("line-id");$("."+e).find(".message-item").html('<img src="'+IMG_LOADING+'" />').show();var a={employee_id:t,line_item_id:e,start_date:$(this).data("start-date"),end_date:$(this).data("end-date"),checkin:checkin_standard,checkout:checkout_standard},i=URL_SYNC_TIMESHEET+"?"+$.param(a);getAjax(i).done(handleSyncTimesheet)}),$("#btn-submit").on("click",function(t){t.preventDefault();var e=!1;$(".input-float").each(function(t){validateValueHour($(this).val())||($(this).addClass("error"),e||(e=!0))});var a=!1;$(".input-time").each(function(t){var e=$(this).val();""==e||checkIsTime(e)||($(this).addClass("error"),a||(a=!0))}),$(".tbl-line-item").each(function(){var t=$(this).attr("id"),e=validateTime(t);e?$("#"+t).find(".valid-time").text(""):($("#"+t).find(".valid-time").text("Có dữ liệu không hợp lệ, vui lòng kiểm tra lại"),a=!0)}),e||a||$("#timesheet-form").submit()}),$(document).on("change",".input-float",function(){var t=$.trim($(this).val());return $(this).val(t),validateValueHour(t)?($(this).val(rebuildValueFloat(t)),void $(this).removeClass("error")):($(this).addClass("error"),void $(this).focus())}),$(document).on("change",".input-time",function(){var t=$.trim($(this).val());$(this).val(t);var e=$(this).attr("name"),a=$(this).parents("div").attr("id"),i=e.match(/\[(checkin|checkout|break_time)\]/),n=e.replace(i[1],"checkin"),o=e.replace(i[1],"checkout"),r=e.replace(i[1],"break_time"),d=e.replace(i[1],"working_hour"),l=e.replace(i[1],"ot_hour"),s=$('[name="'+n+'"]').val(),c=$('[name="'+o+'"]').val(),h=$('[name="'+r+'"]').val(),_=validateTime(a);_?$("#"+a).find(".valid-time").text(""):$("#"+a).find(".valid-time").text("Có dữ liệu không hợp lệ, vui lòng kiểm tra lại"),""==s&&""==c&&""==h||calTimeWorking(d,l,s,c,h),reCalTotalWorkingHour(a),reCalTotalLeaveDay(a)}),$(document).on("change",".input-float",function(){var t=$(this).parents("div.tbl-line-item").attr("id");reCalTotalWorkingHour(t),reCalTotalLeaveDay(t)}),$(document).on("click",".edit-row",function(){var t=$(this).data("type"),e=$(this).data("row"),a=$(this).parents("div").attr("id");$("#data-row").val(""),$("#data-row").data("type",t),$(".btn-save-row").data("row",e),$(".btn-save-row").data("line-id",a),$("#edit-modal").find(".edit-row-error").text(""),$("#edit-modal").modal()}),$(".btn-save-row").on("click",function(){var t=$("#data-row").val(),e=$("#data-row").data("type"),a=$(this).data("row"),i=$(this).data("line-id");if(""==t)return void $(".edit-row-error").text("Vui lòng nhập giá trị");if("input-float"==e&&!validateValueHour(t))return void $(".edit-row-error").text("Vui lòng dạng số thập phân lớn hơn 0 và nhỏ hơn 24 (h)");if("input-time"==e&&!checkIsTime(t))return void $(".edit-row-error").text("Vui lòng nhập đúng định dạng (H:m)");editRow(i,a,e,t);var n=validateTime(i);n?$("#"+i).find(".valid-time").text(""):$("#"+i).find(".valid-time").text("Có dữ liệu không hợp lệ, vui lòng kiểm tra lại"),"input-time"==e&&reCalTimeWorking(i),reCalTotalWorkingHour(i),reCalTotalLeaveDay(i),$("#edit-modal").modal("hide")}),$(document).on("click",".btn-remove-item",function(){var t=$(this).parents("div.line-item");confirm("Bạn muốn xóa thông tin timesheet của nhân viên này?")&&(t.remove(),""!=t.data("id")&&(line_deleted.push(t.data("id")),$("#line-deleted").val(line_deleted.join(","))))}),$(".btn-refresh-item").on("click",function(){refreshItem()})});