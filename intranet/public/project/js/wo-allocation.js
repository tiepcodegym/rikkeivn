!function(e,t,a,r,o){var n="undefined"==typeof globalTrans?{}:globalTrans,i="undefined"==typeof globalPassModule?{}:globalPassModule,m={dom:{},lang:{},memberType:{},members:{},memberKeyId:{},dataMember:{},groupsVis:{},itemsVis:{},project:!1,teamMember:{},labelResource:"",timelineVis:{},optionVis:{},dataGeneral:{},htmlTeamAllocate:"",groupOrderData:{},init:function(r,o){if("object"!=typeof a)return!0;var n=this;n.project=i.project,n.getLabelResource(),n.dom=o,n.lang=r.lang,n.memberType=r.type,n.execTeamMember(r),n.groupsVis=new a.DataSet,n.itemsVis=new a.DataSet,n.members=n.memberGroupParent(r.member),n.addItemsVis(n.members),n.opitonVis={},n.htmlTeamAllocate=t('[data-flag-dom="wo-team-allocate"]').html(),t('[data-flag-dom="wo-team-allocate"]').remove(),o.html(n.htmlTeamAllocate),n.timelineVis=new a.Timeline(e.getElementById("ta-vis")),n.setOptionVis(),n.timelineVis.setOptions(n.opitonVis),n.timelineVis.setGroups(n.groupsVis),n.timelineVis.setItems(n.itemsVis),n.editAvai(),n.event(),n.action(),n.validateForm(),n.calTotalActualEffort(),n.getCurrentSkillNewEmp(),t('[data-flag-dom="datetime-picker"]').datepicker({format:"yyyy-mm-dd",weekStart:1,todayHighlight:!0,autoclose:!0})},memberGroupParent:function(e){var a={},r=this;return t.each(e,function(e,t){t.start_at=t.start_at.replace(/\s.*/,""),t.end_at=t.end_at.replace(/\s.*/,""),r.memberKeyId[t.id]=t,t.parent_id&&1!==parseInt(t.status)?("undefined"==typeof a[t.parent_id]&&(a[t.parent_id]={}),a[t.parent_id].child=t):("undefined"==typeof a[t.id]&&(a[t.id]={}),a[t.id].parent=t)}),t.each(a,function(e,t){var a;a=t.child?t.child:t.parent,r.groupsVis.get(a.employee_id)||r.groupsVis.add({id:a.employee_id,content:a.name+"<br/>"+r.replaceEmailToAccount(a.email)+r.getTeamOfEmployee(a.employee_id)})}),a},addItemsVis:function(e){var a=this;t.each(e,function(e,t){a.itemsVis.add(a.addItemVis(t))})},addItemVis:function(e){var t,a=this,r="",o="",m="";t=e.child?e.child:e.parent,i.status.sDelete.indexOf(parseInt(t.status))>-1?m="s-delete":1!==parseInt(t.status)&&(m="not-approve"),r=t.flat_resource+" "+a.labelResource+' &nbsp;|&nbsp; <span class="effort-number">'+t.effort+'%</span> &nbsp;|&nbsp; <span class="position">'+a.getLabelMemberType(t.type)+"</span>","undefined"!=typeof IS_OPPORTUNITY&&IS_OPPORTUNITY||(o+="<p><b>"+n.Status+":</b> ",t.status=parseInt(t.status),o+=1===t.status?n.Approved:i.status.sDelete.indexOf(t.status)>-1?n["Delete draft"]:i.status.sEdit.indexOf(t.status)>-1?n["Edit draft"]:n["Add draft"],o+="</p>"),a.isDiffValue(e,"email")&&(o+="<p><b>"+n.Account+":</b> ",o+='<span class="unapprove-value">'+a.replaceEmailToAccount(t.email)+'</span> | <span class="approve-value">approved: '+a.replaceEmailToAccount(e.parent.email)+"</span>"),o+="<p><b>"+n.Position+":</b> ",o+=a.isDiffValue(e,"type")?'<span class="unapprove-value">'+a.getLabelMemberType(t.type)+'</span> | <span class="approve-value">approved: '+a.getLabelMemberType(e.parent.type)+"</span>":a.getLabelMemberType(t.type),o+="</p><p><b>Start date:</b> ",o+=a.isDiffValue(e,"start_at")?'<span class="unapprove-value">'+t.start_at+'</span> | <span class="approve-value">approved: '+e.parent.start_at+"</span>":t.start_at,o+="</p><p><b>End date:</b> ",o+=a.isDiffValue(e,"end_at")?'<span class="unapprove-value">'+t.end_at+'</span> | <span class="approve-value">approved: '+e.parent.end_at+"</span>":t.end_at,o+="</p><p><b>Effort(%)</b>: ",o+=a.isDiffValue(e,"effort")?'<span class="unapprove-value">'+t.effort+'</span> | <span class="approve-value">approved: '+e.parent.effort+"</span>":t.effort,o+="</p><p><b>"+n["Actual Effort"]+"("+a.labelResource+"):</b> ",o+=a.isDiffValue(e,"flat_resource")?'<span class="unapprove-value">'+t.flat_resource+'</span> | <span class="approve-value">approved: '+e.parent.flat_resource+"</span>":t.flat_resource,o+="</p>",t.prog_lang_ids&&(o+="<p><b>PL:</b> ",o+=a.isDiffValue(e,"prog_lang_ids")?'<span class="unapprove-value">'+a.getLabelProLang(t.prog_lang_ids)+'</span> | <span class="approve-value">approved: '+a.getLabelProLang(e.parent.prog_lang_ids)+"</span>":a.getLabelProLang(t.prog_lang_ids),o+="</p>");var d=moment(t.start_at);return a.groupOrderData[t.employee_id]?d.isAfter(a.groupOrderData[t.employee_id])&&(a.groupOrderData[t.employee_id]=d):a.groupOrderData[t.employee_id]=d,{id:t.id,group:t.employee_id,start:t.start_at,end:t.end_at,content:r,title:o,className:m}},event:function(){var a=this,r=!1;a.timelineVis.on("select",function(e){return Array.isArray(e.items)&&e.items.length?a.memberId=e.items[0]:isNaN(e.items)?a.memberId=null:a.memberId=e.items,a.memberId?(a.formEditMember(),void(r||(r=!0,t("#modal-proj-member-edit").on("hide.bs.modal",function(){a.memberId=null,a.timelineVis.setSelection([]),t("#ta-vis .vis-range.vis-selected").removeClass("vis-selected")})))):null}),t(e).on("click",'[data-btn-action="woAddProjMember"]',function(e){e.preventDefault(),a.memberId=null,a.formEditMember()})},getFormatDate:function(e){return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()},getLabelResource:function(){var e=this;return e.project.resource_type===MD_TYPE?e.labelResource="MD":e.labelResource="MM",e.labelResource},getLabelMemberType:function(e){return"undefined"!=typeof this.memberType[e]?this.memberType[e]:"Dev"},getLabelProLang:function(e){var a="",r=this;return e=r.getLangArray(e),t.each(e,function(e,t){"undefined"!=typeof r.lang[t]&&(a+=r.lang[t]+", ")}),a.slice(0,-2)},getLangArray:function(e){return e?e.split("-"):[]},setOptionVis:function(){var e=this;e.opitonVis={groupOrder:function(t,a){return e.groupOrderData[t.id]&&e.groupOrderData[a.id]?e.groupOrderData[t.id].isAfter(e.groupOrderData[a.id])?1:-1:0},tooltip:{followMouse:!1,overflowMethod:"cap"},align:"center",zoomMin:864e6,editable:!1}},isDiffValue:function(e,t){return!!e.child&&e.parent[t]!=e.child[t]},formEditMember:function(){var e=this,a=t("#modal-proj-member-edit");if(!a.length){if(a=t("#flag-modal-proj-member-edit"),!a.length)return!0;a.attr("id","modal-proj-member-edit"),a=e.formInitData(a)}e.formRenderDataMember(),e.getCurrentSkill(a),null!=t("#currentSkills").val&&t("#currentSkills").val(null).trigger("change"),a.modal("show")},getCurrentSkill:function(e){var a=this,r=e.find("#field-account").val();null!=r&&t.ajax({url:urlGetCurrentSkill,data:{empId:r},type:"POST",datatype:"JSON",success:function(e){e&&(t("#currentSkills").empty(),a.renderListSkill(e))},error:function(e){console.log("error")}})},renderListSkill:function(e){var a=e.currentSkill,r=e.tagData;t.each(typesSkill,function(e,o){var n='<optgroup label="'+o.label+'">';t.each(a[e],function(a,o){var o=o.tag_id;t.each(r[e],function(e,t){n+='<option value="'+e+'"',e===o&&(n+=" selected"),n+=">"+t+"</option>"})}),n+="</optgroup>",t("#currentSkills").append(n)}),t(".js-example-matcher-start").select2({width:"100%",matcher:function(e,a){if(""===t.trim(e.term))return a;if("undefined"==typeof a.text)return null;var r=e.term.toLowerCase();return a.text.toLowerCase().indexOf(r)>-1||a.id.toLowerCase().indexOf(r)>-1?t.extend({},a,!0):null}}).prop("disabled",!0)},getCurrentSkillNewEmp:function(){var e=t("#field-account"),a=this,r=!1;e.on("change",function(){if(r=!0,null!=t("#currentSkills").val&&t("#currentSkills").val(null).trigger("change"),t("#modal-proj-member-edit").hasClass("in")===!0&&r===!0){var o=e.val();null!=o&&t.ajax({url:urlGetCurrentSkill,data:{empId:o},type:"POST",datatype:"JSON",success:function(e){e&&(t("#currentSkills").empty(),a.renderListSkill(e))},error:function(e){console.log("error")}})}})},formInitData:function(e){var a=this,r="";t.each(a.memberType,function(e,t){r+='<option value="'+e+'">'+t+"</option>"}),e.find("#pm-position").html(r),r="";var n=[];return t(".frm-create-project select#prog_langs").length?(n=t(".frm-create-project select#prog_langs").val(),n||(n=[])):n=Object.keys(o.projLangs),n.length&&(t.each(n,function(e,t){"undefined"!=typeof a.lang[t]&&(r+='<option value="'+t+'">'+a.lang[t]+"</option>")}),e.find("#field-pl").html(r)),e.find('[data-proj-label="label-type"]').html(a.labelResource),e},formRenderDataMember:function(){var e=this,a=e.memberKeyId[e.memberId];try{t('[data-flag-dom="datetime-picker"]').datepicker("setDate","now")}catch(r){}return t("form#form-project-member [data-input-form]").val("").change(),"object"==typeof e.formValidate&&"function"==typeof e.formValidate.resetForm&&e.formValidate.resetForm(),a?(t('[data-flag-dom="modal-pm-title"]').html(t('[data-flag-dom="modal-pm-title"]').data("title-edit")),[o.memberTypePm,o.memberTypeSubPm,o.memberTypeLeader,o.memberTypeDev].indexOf(parseInt(a.type))===-1?a.program=[]:a.program||(a.program=e.getLangArray(a.prog_lang_ids)),void e.formFillData(a)):e.formFillData({status:1,flagAddEvent:!0})},formFillData:function(e){var a,r=this;i.status.sDelete.indexOf(parseInt(e.status))>-1?(r.dataGeneral.cancelItem=!0,t('[data-flag-dom="btnSaveProjMember"]').addClass("hidden"),t('[data-flag-dom="btnDeleteProjMember"]').addClass("hidden"),t('[data-flag-del="revert"]').removeClass("hidden"),a=!0):(r.dataGeneral.cancelItem=!1,t('[data-flag-dom="btnSaveProjMember"]').removeClass("hidden"),t('[data-flag-dom="btnDeleteProjMember"]').removeClass("hidden"),t('[data-flag-del="revert"]').addClass("hidden"),a=!1),e.flagAddEvent&&t('[data-flag-dom="btnDeleteProjMember"]').addClass("hidden"),i.editWOAvai||(a=!0),t("form#form-project-member [data-input-form]").each(function(o,n){var i=t(n).data("input-form");return t(n).prop("disabled",a),"undefined"==typeof e[i]||!e[i]||("start_at"===i||"end_at"===i?(t(n).datepicker("setDate",e[i].replace(/\s.*/,"")),t(n).datepicker("update"),!0):"employee_id"!==i?(t(n).val(e[i]).change(),!0):void(e.employee_id&&(t(n).data("select2-more-name",e.name).data("select2-more-email",e.email),t(n).html('<option value="'+e.employee_id+'">'+r.replaceEmailToAccount(e.email)+" ("+e.name+")</option>").val(e.employee_id).change())))}),r.actionInputPL(),t('form#form-project-member [data-input-form="id"]').prop("disabled",!1)},action:function(){var a=this;a.dataMember={},r.projMemberBeforeSubmit=function(){a.dataMember={},t("form#form-project-member [data-input-form]").each(function(e,r){a.dataMember[t(r).data("input-form")]=t(r).val()}),a.dataMember.program&&a.dataMember.program.length?a.dataMember.prog_lang_ids=a.dataMember.program.join("-"):a.dataMember.prog_lang_ids="",a.dataMember.email=t('form#form-project-member [data-input-form="employee_id"]').data("select2-more-email"),a.dataMember.name=t('form#form-project-member [data-input-form="employee_id"]').data("select2-more-name")},r.projMemberSaveSuccess=function(e){if(e.isCheckShowSubmit&&t(".submit-workorder").removeClass("display-none"),"object"!=typeof e.member)return!0;var r=null;a.formFillData(e.member);var o,n=null;if(e["delete"]){var i=a.itemsVis.get(a.dataMember.id);i&&(r=i.group,a.itemsVis.remove(a.dataMember.id))}if(e["delete"]&&!e.approve?(delete a.memberKeyId[e.member.id],delete a.members[e.member.id],e.member.parent_id&&(n=a.memberKeyId[e.member.parent_id],delete a.members[n.id].child)):(n=t.extend(a.dataMember,e.member),a.memberKeyId[n.id]=n),!n)return r&&a.checkGroupItems(r),a.calTotalActualEffort(),a.timelineVis.fit(),!0;n.parent_id?("undefined"==typeof a.members[n.parent_id]&&(a.members[n.parent_id]={}),a.members[n.parent_id].child=n,o=a.members[n.parent_id]):("undefined"==typeof a.members[n.id]&&(a.members[n.id]={}),1===parseInt(n.status)&&(a.members[n.id].child&&"undefined"!=typeof a.members[n.id].child.id&&a.itemsVis.get(a.members[n.id].child.id)&&a.itemsVis.remove(a.members[n.id].child.id),delete a.members[n.id].child),a.members[n.id].parent=n,o=a.members[n.id]),a.execTeamMember(e),a.groupsVis.get(n.employee_id)||a.groupsVis.add({id:n.employee_id,content:n.name+"<br/>"+a.replaceEmailToAccount(n.email)+a.getTeamOfEmployee(n.employee_id)}),"undefined"!==e.oldEmpId&&e.oldEmpId&&a.groupsVis.remove(e.oldEmpId);var m=a.addItemVis(o);a.itemsVis.get(e.member.id)?a.itemsVis.update(m):(n.parent_id&&a.itemsVis.remove(n.parent_id),a.itemsVis.add(m)),a.calTotalActualEffort(),a.timelineVis.fit()},r.confirm.no=function(){t("form#form-project-member").data("submit-noti",""),t('form#form-project-member input[name="isDelete"]').val(0),r.confirm.hide()},t(e).on("click",'[data-flag-dom="btnDeleteProjMember"]',function(){if(t("#form-project-member").validate().cancelSubmit=!0,"revert"===t(this).data("flag-del"))var e=t("form#form-project-member").data("cancel-delete-noti");else var e=t("form#form-project-member").data("delete-noti");t("form#form-project-member").data("submit-noti",e),t('form#form-project-member input[name="isDelete"]').val(1)}),r.projMemberComplete=function(){t("form#form-project-member").data("submit-noti",""),t('form#form-project-member input[name="isDelete"]').val(0),t("#modal-proj-member-edit").modal("hide")}},calTotalActualEffort:function(){var e=this,a=0,r=0,o=!1;t('[data-dom-flag="type-resource"]').text(e.getLabelResource()),t.each(e.members,function(e,t){t.parent&&1===parseInt(t.parent.status)&&(a+=parseFloat(t.parent.flat_resource)),t.child&&i.status.sDelete.indexOf(parseInt(t.child.status))===-1?(r+=parseFloat(t.child.flat_resource),o=!0):t.child||i.status.sDelete.indexOf(parseInt(t.parent.status))!==-1?t.child&&(o=!0):(r+=parseFloat(t.parent.flat_resource),1!==parseInt(t.parent.status)&&(o=!0))}),t('[data-dom-effort="approved"]').text(a.toFixed(2)),o?(t('[data-dom-effort="un"]').text(r.toFixed(2)),t('[data-dom-flag="tae-unapprove"]').removeClass("hidden")):t('[data-dom-flag="tae-unapprove"]').addClass("hidden")},editAvai:function(){i.editWOAvai?t('[data-btn-action="woAddProjMember"]').removeClass("hidden"):(t('[data-btn-action="woAddProjMember"]').remove(),t('[data-flag-dom="btnSaveProjMember"]').remove(),t('[data-flag-dom="btnDeleteProjMember"]').remove(),t("form#form-project-member [data-input-form]").prop("disabled",!0))},validateForm:function(){var a=this;t(e).on("change",'[data-input-form="type"]',function(){a.actionInputPL()}),t.validator.addMethod("woMemberPL",function(e,a){var r=t('[data-input-form="type"]').val();return!!(!r||parseInt(r)!==o.memberTypeDev||e&&e.length)},"This field is required."),t.validator.addMethod("woMemberEndat",function(e,a){var r=t('[data-input-form="start_at"]').val(),o=t("#summary #end_at").val();if(e&&r&&o){var n=new Date(e);if(r=new Date(r),o=new Date(o),n<r||n>o)return!1}return!0},"End at may not be least than start at of member and greater than end at of project"),t.validator.addMethod("woMemberStartat",function(e,a){var r=t("#summary #start_at").val();if(e&&r){var o=new Date(e);if(r=new Date(r),o<r)return!1}return!0},"Start at may not be least than start at of project"),a.formValidate=t("form#form-project-member").validate({rules:{"item[type]":{required:!0},"item[employee_id]":{required:!0},"item[start_at]":{required:!0,date:!0,woMemberStartat:!0},"item[end_at]":{required:!0,date:!0,woMemberEndat:!0},"item[effort]":{required:!0,range:[0,maxEffort]},"item[prog_langs][]":{woMemberPL:!0}}})},actionInputPL:function(){var e=this,a=t('[data-input-form="type"]').val();!a||[o.memberTypeDev,o.memberTypeLeader,o.memberTypePm,o.memberTypeSubPm].indexOf(parseInt(a))>-1?i.editWOAvai&&!e.dataGeneral.cancelItem&&t('[data-input-form="program"]').prop("disabled",!1):(t('[data-input-form="program"]').val("").change(),t('[data-input-form="program"]').prop("disabled",!0))},execTeamMember:function(e){if(!e.team)return!0;var a=this;t.each(e.team,function(e,t){"undefined"==typeof a.teamMember[t.employee_id]&&(a.teamMember[t.employee_id]=[]),a.teamMember[t.employee_id].indexOf(t.team_id)===-1&&a.teamMember[t.employee_id].push(t.team_id)})},getTeamOfEmployee:function(e){var a=this,r="";return a.teamMember[e]&&a.teamMember[e].length?(t.each(a.teamMember[e],function(e,t){return!o.teamPath[t]||!o.teamPath[t].data||void(r+=o.teamPath[t].data.name+", ")}),r?" - "+r.slice(0,-2):""):""},replaceEmailToAccount:function(e){return e?e.replace(/@.*/,""):""},checkGroupItems:function(e){var a=this;if(e=parseInt(e),!e||!a.groupsVis.get(e))return!0;var r=!1;return t.each(a.itemsVis._data,function(t,a){if(parseInt(a.group)===e)return r=!0,!1}),!!r||a.groupsVis.remove(e)}};window.rkWoAllocation=m}(document,jQuery,vis,RKExternal,RKVarPassGlobal);